<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Al-Riyadah HR Management System - Login</title>

    <!-- Favicon and Icons -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%232563eb'/><g fill='white'><path d='M30 25c-2.8 0-5 2.2-5 5s2.2 5 5 5 5-2.2 5-5-2.2-5-5-5zm0 15c-5.5 0-10 4.5-10 10v5h20v-5c0-5.5-4.5-10-10-10z'/><path d='M70 25c-2.8 0-5 2.2-5 5s2.2 5 5 5 5-2.2 5-5-2.2-5-5-5zm0 15c-5.5 0-10 4.5-10 10v5h20v-5c0-5.5-4.5-10-10-10z'/><path d='M50 35c-3.3 0-6 2.7-6 6s2.7 6 6 6 6-2.7 6-6-2.7-6-6-6zm0 18c-6.6 0-12 5.4-12 12v10h24v-10c0-6.6-5.4-12-12-12z'/></g></svg>">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%232563eb'/><g fill='white'><path d='M30 25c-2.8 0-5 2.2-5 5s2.2 5 5 5 5-2.2 5-5-2.2-5-5-5zm0 15c-5.5 0-10 4.5-10 10v5h20v-5c0-5.5-4.5-10-10-10z'/><path d='M70 25c-2.8 0-5 2.2-5 5s2.2 5 5 5 5-2.2 5-5-2.2-5-5-5zm0 15c-5.5 0-10 4.5-10 10v5h20v-5c0-5.5-4.5-10-10-10z'/><path d='M50 35c-3.3 0-6 2.7-6 6s2.7 6 6 6 6-2.7 6-6-2.7-6-6-6zm0 18c-6.6 0-12 5.4-12 12v10h24v-10c0-6.6-5.4-12-12-12z'/></g></svg>">
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%232563eb' rx='15'/><g fill='white'><path d='M30 25c-2.8 0-5 2.2-5 5s2.2 5 5 5 5-2.2 5-5-2.2-5-5-5zm0 15c-5.5 0-10 4.5-10 10v5h20v-5c0-5.5-4.5-10-10-10z'/><path d='M70 25c-2.8 0-5 2.2-5 5s2.2 5 5 5 5-2.2 5-5-2.2-5-5-5zm0 15c-5.5 0-10 4.5-10 10v5h20v-5c0-5.5-4.5-10-10-10z'/><path d='M50 35c-3.3 0-6 2.7-6 6s2.7 6 6 6 6-2.7 6-6-2.7-6-6-6zm0 18c-6.6 0-12 5.4-12 12v10h24v-10c0-6.6-5.4-12-12-12z'/></g></svg>">
    <link rel="manifest" href="site.webmanifest">

    <!-- Open Graph / Social Media Meta Tags -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Al-Riyadah HR Management System">
    <meta property="og:description" content="Complete HR Management System for Al-Riyadah - employee database, leaves, overtime, payroll and more.">
    <meta property="og:image" content="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 630'><rect width='1200' height='630' fill='%232563eb'/><text y='350' font-size='120' fill='white' text-anchor='middle' x='600' font-family='Arial'>Al-Riyadah HR System</text></svg>">
    <meta property="og:url" content="https://ahmedatef569.github.io/Al-Riyadah-HR-System/">
    <meta property="og:site_name" content="Al-Riyadah HR Management System">

    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Al-Riyadah HR Management System">
    <meta name="twitter:description" content="Complete HR Management System for Al-Riyadah - employee database, leaves, overtime, payroll and more.">
    <meta name="twitter:image" content="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 630'><rect width='1200' height='630' fill='%232563eb'/><text y='350' font-size='120' fill='white' text-anchor='middle' x='600' font-family='Arial'>Al-Riyadah HR System</text></svg>">

    <!-- Additional Meta Tags -->
    <meta name="description" content="Complete HR Management System for Al-Riyadah - employee database, leaves, overtime, payroll and more.">
    <meta name="keywords" content="HR, Human Resources, Employee Management, Payroll, Leave Management">
    <meta name="author" content="Al-Riyadah Company">
    <meta name="theme-color" content="#2563eb">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom Styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Tailwind gray-50 */
        }
        /* Style for active sidebar link */
        .sidebar-link.active {
            background-color: #e0f2fe; /* Tailwind sky-100 */
            color: #0ea5e9; /* Tailwind sky-500 */
            font-weight: 600;
        }
        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* Mobile sidebar improvements */
        @media (max-width: 767px) {
            #sidebar {
                z-index: 50 !important;
                width: 16rem; /* w-64 */
                max-width: 80vw;
            }

            #mobile-backdrop {
                z-index: 40 !important;
            }

            /* Ensure main content doesn't shift on mobile */
            main {
                margin-left: 0 !important;
                width: 100% !important;
            }

            /* Improve mobile menu button */
            #mobile-menu-button {
                z-index: 60 !important;
            }
        }

        /* Desktop layout - ensure no white space issues */
        @media (min-width: 768px) {
            #sidebar {
                position: sticky !important;
                transform: translateX(0) !important;
                z-index: 10 !important;
            }

            main {
                margin-left: 0;
                width: calc(100% - 16rem); /* Account for sidebar width */
            }

            .flex.w-full.h-full {
                display: flex;
                width: 100%;
            }
        }
        /* Custom styling for Flatpickr */
        .flatpickr-calendar {
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
        }

        /* Admin-only elements (hidden by default for non-admin users) */
        .admin-only.hidden {
            display: none;
        }
        /* Custom table styling */
        thead th {
            background-color: #f1f5f9; /* Tailwind slate-100 */
            position: sticky;
            top: 0;
            z-index: 10;
        }
        /* Ensure table container allows scrolling */
        .table-container {
            max-height: none; /* Allow tables to be as tall as needed */
            overflow: auto; /* Enable both horizontal and vertical scrolling */
            width: 100%;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
        }

        /* Make table headers sticky */
        .table-container thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #2563eb !important;
            color: white !important;
        }

        /* Ensure table cells don't wrap and have proper padding */
        .table-container td,
        .table-container th {
            white-space: nowrap;
            padding: 0.75rem 1rem;
        }
         /* Center login form */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #e5e7eb; /* Tailwind gray-200 */
        }
        /* Fixed height for chart containers */
        .chart-container {
            height: 18rem; /* Approx h-72 */
            position: relative; /* Needed for Chart.js responsiveness */
            width: 100%;
            margin-bottom: 1rem;
        }

        /* Ensure charts are visible */
        canvas {
            max-width: 100%;
            max-height: 100%;
        }

        /* Simplified Time Selection Styles */
        .clock-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(3px);
            overflow-y: auto;
            padding: 20px 0;
        }

        .clock-modal-content {
            background: white;
            padding: 15px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            width: 300px;
            max-width: 90vw;
            max-height: 90vh;
            animation: modalFadeIn 0.3s ease;
            margin: auto;
            overflow-y: auto;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .clock-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 10px;
        }

        .clock-modal-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .clock-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #666;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .clock-modal-close:hover {
            color: #4f46e5;
        }

        .hour-button {
            background-color: #f3f4f6;
            color: #1f2937;
            border: none;
            border-radius: 6px;
            padding: 8px 0;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            margin: 2px;
        }

        .hour-button:hover {
            background-color: #e5e7eb;
            transform: translateY(-1px);
        }

        .hour-button.selected {
            background-color: #4f46e5;
            color: white;
            box-shadow: 0 2px 5px rgba(79, 70, 229, 0.3);
        }

        .hour-button:active {
            transform: translateY(0);
        }
    </style>
</head>
<body class="overflow-hidden"> <div id="login-screen" class="login-container">
        <div class="bg-white p-8 md:p-12 rounded-lg shadow-xl w-full max-w-md">
            <div class="flex justify-center items-center mb-8">
                <div class="bg-indigo-600 p-3 rounded-lg shadow-lg">
                    <i class="fas fa-users text-white text-4xl"></i>
                </div>
                <div class="ml-3">
                    <h1 class="text-2xl font-bold text-indigo-600">HR System</h1>
                    <p class="text-sm text-gray-500">Employee Management</p>
                </div>
            </div>
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">HR System Login</h2>
            <form id="login-form" onsubmit="handleLogin(event)">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="username" name="username" required
                           class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                           placeholder="Enter email address">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="password" name="password" required
                           class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                           placeholder="Enter password">
                </div>
                <div id="login-error" class="text-red-500 text-sm mb-4 text-center hidden">
                    Invalid username or password.
                </div>
                <button type="submit"
                        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-md shadow transition duration-150">
                    Login
                </button>
            </form>             <p class="text-xs text-center text-gray-500 mt-6">
                Please enter your username and password to login.
            </p>
        </div>
    </div>

    <div id="app-container" class="flex h-screen overflow-hidden hidden">
        <!-- Mobile menu button -->
        <div class="fixed top-4 left-4 z-20 md:hidden">
            <button id="mobile-menu-button" class="bg-white p-3 rounded-md shadow-lg text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all duration-200">
                <i class="fas fa-bars text-xl"></i>
            </button>
        </div>

        <div class="flex w-full h-full min-h-screen">
            <aside id="sidebar" class="w-64 bg-white shadow-md flex flex-col no-scrollbar overflow-y-auto fixed md:sticky top-0 h-full z-10 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out md:z-auto">
                <div class="p-6 text-2xl font-bold text-gray-700 border-b flex justify-between items-center">
                    <span>Company HR</span>
                    <button id="close-sidebar" class="md:hidden text-gray-500 hover:text-gray-800">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <nav class="mt-6 flex-1">
                    <ul>
                        <li id="nav-item-dashboard" class="admin-only">
                            <a href="#" id="nav-dashboard" class="sidebar-link active flex items-center px-6 py-3 text-gray-600 hover:bg-gray-100 transition duration-150" onclick="showSection('dashboard')">
                                <i class="fas fa-tachometer-alt w-5 mr-3"></i> Dashboard
                            </a>
                        </li>
                        <li id="nav-item-employee-profile" class="hidden">
                            <a href="#" id="nav-employee-profile" class="sidebar-link flex items-center px-6 py-3 text-gray-600 hover:bg-gray-100 transition duration-150" onclick="showSection('employee-profile')">
                                <i class="fas fa-user w-5 mr-3"></i> My Profile
                            </a>
                        </li>
                        <li id="nav-item-my-requests" class="hidden">
                            <a href="#" id="nav-my-requests" class="sidebar-link flex items-center px-6 py-3 text-gray-600 hover:bg-gray-100 transition duration-150" onclick="showSection('my-requests')">
                                <i class="fas fa-clipboard-list w-5 mr-3"></i> My Requests
                            </a>
                        </li>
                        <li id="nav-item-manager-dashboard" class="hidden">
                            <a href="#" id="nav-manager-dashboard" class="sidebar-link flex items-center px-6 py-3 text-gray-600 hover:bg-gray-100 transition duration-150" onclick="showSection('manager-dashboard')">
                                <i class="fas fa-user-tie w-5 mr-3"></i> Manager Dashboard
                            </a>
                        </li>
                        <li id="nav-item-database" class="admin-only">
                            <a href="#" id="nav-database" class="sidebar-link flex items-center px-6 py-3 text-gray-600 hover:bg-gray-100 transition duration-150" onclick="showSection('database')">
                                <i class="fas fa-users w-5 mr-3"></i> Employee Database
                            </a>
                        </li>
                        <li id="nav-item-leaves" class="admin-only">
                            <a href="#" id="nav-leaves" class="sidebar-link flex items-center px-6 py-3 text-gray-600 hover:bg-gray-100 transition duration-150" onclick="showSection('leaves')">
                                <i class="fas fa-calendar-alt w-5 mr-3"></i> Employee Leaves
                            </a>
                        </li>
                        <li id="nav-item-excuses" class="admin-only">
                            <a href="#" id="nav-excuses" class="sidebar-link flex items-center px-6 py-3 text-gray-600 hover:bg-gray-100 transition duration-150" onclick="showSection('excuses')">
                                <i class="fas fa-clock w-5 mr-3"></i> Employee Excuses
                            </a>
                        </li>
                        <li id="nav-item-overtime" class="admin-only">
                            <a href="#" id="nav-overtime" class="sidebar-link flex items-center px-6 py-3 text-gray-600 hover:bg-gray-100 transition duration-150" onclick="showSection('overtime')">
                                <i class="fas fa-business-time w-5 mr-3"></i> Employee Overtime
                            </a>
                        </li>
                        <li id="nav-item-penalties" class="admin-only">
                            <a href="#" id="nav-penalties" class="sidebar-link flex items-center px-6 py-3 text-gray-600 hover:bg-gray-100 transition duration-150" onclick="showSection('penalties')">
                                <i class="fas fa-exclamation-triangle w-5 mr-3"></i> Employee Penalties
                            </a>
                        </li>
                        <li id="nav-item-salary" class="admin-only">
                            <a href="#" id="nav-salary" class="sidebar-link flex items-center px-6 py-3 text-gray-600 hover:bg-gray-100 transition duration-150" onclick="showSection('salary')">
                                <i class="fas fa-dollar-sign w-5 mr-3"></i> Salary Details
                            </a>
                        </li>
                        <li id="nav-item-payroll" class="admin-only">
                            <a href="#" id="nav-payroll" class="sidebar-link flex items-center px-6 py-3 bg-yellow-100 text-red-600 font-bold hover:bg-gray-100 transition duration-150" onclick="showSection('payroll')">
                                <i class="fas fa-money-bill-wave w-5 mr-3"></i> Payroll
                            </a>
                        </li>
                        <li id="nav-item-settings" class="admin-only">
                            <a href="#" id="nav-settings" class="sidebar-link flex items-center px-6 py-3 text-gray-600 hover:bg-gray-100 transition duration-150" onclick="showSection('settings')">
                                <i class="fas fa-cog w-5 mr-3"></i> Settings
                            </a>
                        </li>
                    </ul>
                </nav>
                <div class="p-6 border-t">
                    <button onclick="logout()" class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150">
                        <i class="fas fa-sign-out-alt mr-2"></i> Logout
                    </button>
                </div>
            </aside>

            <main class="flex-1 overflow-y-auto p-4 md:p-8 bg-gray-50 relative">
                <!-- Notification Bell -->
                <div class="absolute top-4 right-4 z-20">
                    <div class="relative">
                        <button id="notification-bell" class="bg-white p-2 rounded-full shadow-md text-gray-700 hover:bg-gray-100 focus:outline-none">
                            <i class="fas fa-bell text-xl"></i>
                            <span id="notification-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                        </button>
                        <div id="notification-dropdown" class="absolute right-0 mt-2 w-80 bg-white rounded-md shadow-lg overflow-hidden z-20 hidden">
                            <div class="py-2 px-3 bg-indigo-600 text-white font-semibold flex justify-between items-center">
                                <span>Notifications</span>
                                <button id="mark-all-read" class="text-xs bg-indigo-700 hover:bg-indigo-800 px-2 py-1 rounded">
                                    Mark all as read
                                </button>
                            </div>
                            <div id="notification-list" class="max-h-96 overflow-y-auto">
                                <!-- Notifications will be populated here -->
                                <div class="py-8 text-center text-gray-500">
                                    <i class="fas fa-bell-slash text-2xl mb-2"></i>
                                    <p>No notifications</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            <section id="dashboard" class="space-y-8">
                <h1 class="text-3xl font-bold text-gray-800">Dashboard</h1>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label for="dept-filter-dash" class="block text-sm font-medium text-gray-700 mb-1">Department</label>
                        <select id="dept-filter-dash" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="all">All Departments</option>
                            </select>
                    </div>
                    <div>
                        <label for="pos-filter-dash" class="block text-sm font-medium text-gray-700 mb-1">Position</label>
                        <select id="pos-filter-dash" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="all">All Positions</option>
                             </select>
                    </div>
                    <div>
                        <label for="status-filter-dash" class="block text-sm font-medium text-gray-700 mb-1">Employment Status</label>
                        <select id="status-filter-dash" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="all">All Statuses</option>
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button id="dashboard-filter-btn" onclick="handleDashboardFilter(this);" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                            <i class="fas fa-filter mr-1"></i> Apply Filters
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow hover:shadow-lg transition duration-150">
                        <h3 class="text-sm font-medium text-gray-500">Total Employees</h3>
                        <p id="stat-total-employees" class="mt-1 text-3xl font-semibold text-gray-900">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow hover:shadow-lg transition duration-150">
                        <h3 class="text-sm font-medium text-gray-500">Active Employees</h3>
                        <p id="stat-active-employees" class="mt-1 text-3xl font-semibold text-green-600">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow hover:shadow-lg transition duration-150">
                        <h3 class="text-sm font-medium text-gray-500">Avg. Leaves/Dept</h3>
                        <p id="stat-avg-leaves" class="mt-1 text-3xl font-semibold text-blue-600">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow hover:shadow-lg transition duration-150">
                        <h3 class="text-sm font-medium text-gray-500">Turnover Rate</h3>
                        <p id="stat-turnover" class="mt-1 text-3xl font-semibold text-red-600">0%</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Employees per Department</h3>
                        <div class="chart-container">
                             <canvas id="deptChart"></canvas>
                        </div>
                    </div>
                     <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Gender Distribution</h3>
                         <div class="chart-container">
                            <canvas id="genderChart"></canvas>
                         </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Employee Level Distribution</h3>
                         <div class="chart-container">
                            <canvas id="levelChart"></canvas>
                         </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Leaves per Department</h3>
                         <div class="chart-container">
                            <canvas id="leavesDeptChart"></canvas>
                         </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Age Distribution</h3>
                         <div class="chart-container">
                            <canvas id="ageChart"></canvas>
                         </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">YTD Hires vs Resigns (Monthly)</h3>
                         <div class="chart-container">
                            <canvas id="monthlyHiringChart"></canvas>
                         </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow lg:col-span-2">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Hiring vs Resigns Trends</h3>
                         <div class="chart-container">
                            <canvas id="hiringChart"></canvas>
                         </div>
                    </div>
                </div>
            </section>

            <section id="database" class="hidden space-y-6">
                <h1 class="text-3xl font-bold text-gray-800">Employee Database</h1>

                <div class="bg-white p-4 rounded-lg shadow flex flex-wrap gap-4 items-end">
                    <div class="flex-grow">
                        <label for="search-db" class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                        <input type="text" id="search-db" placeholder="Search by name, code, position..." class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="dept-filter-db" class="block text-sm font-medium text-gray-700 mb-1">Department</label>
                        <select id="dept-filter-db" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="all">All</option>
                            </select>
                    </div>
                    <div>
                        <label for="status-filter-db" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select id="status-filter-db" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="all">All</option>
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>
                    <button id="employee-filter-btn" onclick="handleEmployeeFilter(this);" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                        <i class="fas fa-filter mr-1"></i> Filter
                    </button>
                    <button onclick="exportTableToExcel('employeeTable', 'employee-data')" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                        <i class="fas fa-file-excel mr-1"></i> Export to Excel
                    </button>
                    <button onclick="openAddEmployeeModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                        <i class="fas fa-plus mr-1"></i> Add Employee
                    </button>
                </div>

                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="table-container">
                        <table id="employeeTable" class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-blue-600 font-bold">Code</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-blue-600 font-bold">
                                        Full Name <i class="fas fa-info-circle text-blue-200 ml-1" title="Click on name to view employee details"></i>
                                    </th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-blue-600 font-bold">Gender</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-blue-600 font-bold">Hiring Date</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-blue-600 font-bold">Position</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-blue-600 font-bold">Department</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-blue-600 font-bold">DOB</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-blue-600 font-bold">Phone</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-blue-600 font-bold">Email</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-blue-600 font-bold">Address</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-blue-600 font-bold">ID Number</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-blue-600 font-bold">Social Ins.</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-blue-600 font-bold">Status</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-blue-600 font-bold">Military</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-blue-600 font-bold">Level</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-blue-600 font-bold">Direct Manager</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-blue-600 font-bold">Resign Date</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-blue-600 font-bold">Marital Status</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-blue-600 font-bold">Faculty</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-blue-600 font-bold">Grad. Year</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-blue-600 font-bold">Leave Balance</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-blue-600 font-bold">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="employeeTableBody" class="bg-white divide-y divide-gray-200">
                                </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="leaves" class="hidden space-y-6">
                <h1 class="text-3xl font-bold text-gray-800">Employee Leaves</h1>

                <!-- Add Leave Button -->
                <div class="flex justify-end">
                    <button id="add-leave-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                        <i class="fas fa-plus mr-1"></i> Add Leave
                    </button>
                </div>

                <!-- Leave Request Form - Hidden by default -->
                <div id="leave-form-container" class="hidden">
                    <div class="bg-white p-6 rounded-lg shadow mb-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Submit Leave Request</h2>
                        <form id="leave-form" class="space-y-4">
                            <div>
                                <label for="leave-employee-code" class="block text-sm font-medium text-gray-700 mb-1">Employee Code*</label>
                                <input type="text" id="leave-employee-code" required class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Enter employee code">
                            </div>
                            <div>
                                <label for="leave-employee-name" class="block text-sm font-medium text-gray-700 mb-1">Employee Name</label>
                                <input type="text" id="leave-employee-name" readonly class="w-full p-2 border bg-gray-100 border-gray-300 rounded-md shadow-sm">
                                <input type="hidden" id="leave-employee" value="">
                            </div>
                            <div>
                                <label for="leave-balance" class="block text-sm font-medium text-gray-700 mb-1">Current Annual Balance</label>
                                <input type="number" id="leave-balance" readonly class="w-full p-2 border bg-gray-100 border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label for="leave-start-date" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                                <input type="text" id="leave-start-date" required placeholder="Select start date" class="w-full p-2 border border-gray-300 rounded-md shadow-sm flatpickr-input">
                            </div>
                            <div>
                                <label for="leave-end-date" class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                                <input type="text" id="leave-end-date" required placeholder="Select end date" class="w-full p-2 border border-gray-300 rounded-md shadow-sm flatpickr-input">
                            </div>
                            <div>
                                <label for="leave-days" class="block text-sm font-medium text-gray-700 mb-1">Number of Days</label>
                                <select id="leave-days" required class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="0.5">Half Day</option>
                                    <option value="1">1 Day</option>
                                    <option value="2">2 Days</option>
                                    <option value="3">3 Days</option>
                                    <option value="4">4 Days</option>
                                    <option value="5">5 Days</option>
                                </select>
                            </div>
                            <div>
                                <label for="leave-type" class="block text-sm font-medium text-gray-700 mb-1">Leave Type</label>
                                <select id="leave-type" required class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="annual">Annual Leave</option>
                                    <option value="sick">Sick Leave</option>
                                    <option value="unpaid">Unpaid Leave</option>
                                    <option value="compensatory">Compensatory Leave</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div>
                                <label for="leave-reason" class="block text-sm font-medium text-gray-700 mb-1">Reason (Optional)</label>
                                <textarea id="leave-reason" rows="3" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                            </div>
                            <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                                Submit Leave
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Leave Records - Full width when form is hidden -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Leave Records</h2>

                    <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="leave-filter-employee-code" class="block text-sm font-medium text-gray-700 mb-1">Filter by Employee Code</label>
                            <div class="flex space-x-2">
                                <input type="text" id="leave-filter-employee-code" placeholder="Enter employee code" class="flex-1 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                <input type="hidden" id="leave-filter-employee" value="all">
                            </div>
                        </div>
                        <div>
                            <label for="leave-filter-employee-name" class="block text-sm font-medium text-gray-700 mb-1">Employee Name</label>
                            <input type="text" id="leave-filter-employee-name" readonly class="w-full p-2 border bg-gray-100 border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="leave-filter-month" class="block text-sm font-medium text-gray-700 mb-1">Filter by Month (Current Year)</label>
                            <select id="leave-filter-month" class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                <option value="all">All Months</option>
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button id="apply-leave-filters" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                                <i class="fas fa-filter mr-1"></i> Apply Filters
                            </button>
                        </div>
                    </div>

                    <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                        <h3 class="text-lg font-medium text-gray-800 mb-2">Leave Summary</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">Total Leave Days (Current Year):</p>
                                <p id="total-leave-days" class="text-xl font-semibold text-blue-600">0</p>
                                <p class="text-xs text-gray-400 mt-1">Includes ALL leave types for current year only</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Remaining Leave Balance:</p>
                                <p id="remaining-leave-balance" class="text-xl font-semibold text-green-600">0</p>
                                <p class="text-xs text-gray-400 mt-1">Annual allowance minus used annual leave days</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Used Leave Percentage:</p>
                                <p id="used-leave-percentage" class="text-xl font-semibold text-orange-600">0%</p>
                                <p class="text-xs text-gray-400 mt-1">Percentage of annual leave used</p>
                            </div>
                        </div>
                    </div>

                    <div class="table-container">
                        <table id="leaveTable" class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-blue-600">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Employee</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Start Date</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">End Date</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Days</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Type</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Status</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="leaveTableBody" class="bg-white divide-y divide-gray-200">
                                </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="excuses" class="hidden space-y-6">
                <h1 class="text-3xl font-bold text-gray-800">Employee Excuses</h1>

                <!-- Add Excuse Button -->
                <div class="flex justify-end">
                    <button id="add-excuse-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                        <i class="fas fa-plus mr-1"></i> Add Excuse
                    </button>
                </div>

                <!-- Excuse Request Form - Hidden by default -->
                <div id="excuse-form-container" class="hidden">
                    <div class="bg-white p-6 rounded-lg shadow mb-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Submit Excuse Request</h2>
                        <form id="excuse-form" class="space-y-4">
                            <div>
                                <label for="excuse-employee-code" class="block text-sm font-medium text-gray-700 mb-1">Employee Code*</label>
                                <input type="text" id="excuse-employee-code" required class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Enter employee code">
                            </div>
                            <div>
                                <label for="excuse-employee-name" class="block text-sm font-medium text-gray-700 mb-1">Employee Name</label>
                                <input type="text" id="excuse-employee-name" readonly class="w-full p-2 border bg-gray-100 border-gray-300 rounded-md shadow-sm">
                                <input type="hidden" id="excuse-employee" value="">
                            </div>
                            <div>
                                <label for="excuse-date" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                                <input type="text" id="excuse-date" required placeholder="Select date" class="w-full p-2 border border-gray-300 rounded-md shadow-sm flatpickr-input">
                            </div>
                            <div>
                                <label for="excuse-type" class="block text-sm font-medium text-gray-700 mb-1">Excuse Type</label>
                                <select id="excuse-type" required class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="early-checkout">Early Check-out</option>
                                    <option value="late-checkin">Late Check-in</option>
                                    <option value="outdoor-task">Outdoor Task</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="excuse-start-time-display" class="block text-sm font-medium text-gray-700 mb-1">Start Time (From)</label>
                                    <div class="flex">
                                        <input type="text" id="excuse-start-time-display" readonly required class="flex-1 p-2 border border-gray-300 rounded-l-md shadow-sm bg-gray-50 cursor-pointer" placeholder="Click to select time">
                                        <input type="hidden" id="excuse-start-time" required>
                                        <button type="button" onclick="openClockModal('excuse-start-time')" class="bg-gray-200 hover:bg-gray-300 p-2 rounded-r-md">
                                            <i class="fas fa-clock text-gray-600"></i>
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <label for="excuse-end-time-display" class="block text-sm font-medium text-gray-700 mb-1">End Time (To)</label>
                                    <div class="flex">
                                        <input type="text" id="excuse-end-time-display" readonly required class="flex-1 p-2 border border-gray-300 rounded-l-md shadow-sm bg-gray-50 cursor-pointer" placeholder="Click to select time">
                                        <input type="hidden" id="excuse-end-time" required>
                                        <button type="button" onclick="openClockModal('excuse-end-time')" class="bg-gray-200 hover:bg-gray-300 p-2 rounded-r-md">
                                            <i class="fas fa-clock text-gray-600"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label for="excuse-reason" class="block text-sm font-medium text-gray-700 mb-1">Reason (Optional)</label>
                                <textarea id="excuse-reason" rows="3" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                            </div>
                            <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                                Submit Excuse
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Excuse Records - Full width when form is hidden -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Excuse Records</h2>

                    <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="excuse-filter-employee-code" class="block text-sm font-medium text-gray-700 mb-1">Filter by Employee Code</label>
                            <div class="flex space-x-2">
                                <input type="text" id="excuse-filter-employee-code" placeholder="Enter employee code" class="flex-1 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                <input type="hidden" id="excuse-filter-employee" value="all">
                            </div>
                        </div>
                        <div>
                            <label for="excuse-filter-employee-name" class="block text-sm font-medium text-gray-700 mb-1">Employee Name</label>
                            <input type="text" id="excuse-filter-employee-name" readonly class="w-full p-2 border bg-gray-100 border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="excuse-filter-month" class="block text-sm font-medium text-gray-700 mb-1">Filter by Month (Current Year)</label>
                            <select id="excuse-filter-month" class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                <option value="all">All Months</option>
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button id="excuse-filter-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                                <i class="fas fa-filter mr-1"></i> Apply Filters
                            </button>
                        </div>
                    </div>

                    <!-- Excuse Summary -->
                    <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h3 class="text-lg font-medium text-blue-800 mb-2">Current Month Excuses</h3>
                            <div class="flex items-center">
                                <div class="text-3xl font-bold text-blue-700" id="total-excuses-month">0</div>
                                <div class="ml-2 text-sm text-blue-600">excuses</div>
                            </div>
                        </div>
                        <div class="bg-indigo-50 p-4 rounded-lg">
                            <h3 class="text-lg font-medium text-indigo-800 mb-2">Year-to-Date Excuses</h3>
                            <div class="flex items-center">
                                <div class="text-3xl font-bold text-indigo-700" id="total-excuses-year">0</div>
                                <div class="ml-2 text-sm text-indigo-600">excuses</div>
                            </div>
                        </div>
                    </div>

                    <div class="table-container">
                        <table id="excuseTable" class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-blue-600">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Employee</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Date</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Type</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Time</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Reason</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Status</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="excuseTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="overtime" class="hidden space-y-6">
                <h1 class="text-3xl font-bold text-gray-800">Employee Overtime</h1>

                <!-- Add Overtime Button -->
                <div class="flex justify-end">
                    <button id="add-overtime-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                        <i class="fas fa-plus mr-1"></i> Add Overtime
                    </button>
                </div>

                <!-- Overtime Request Form - Hidden by default -->
                <div id="overtime-form-container" class="hidden">
                    <div class="bg-white p-6 rounded-lg shadow mb-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Submit Overtime Request</h2>
                        <form id="overtime-form" class="space-y-4">
                            <div>
                                <label for="overtime-employee-code" class="block text-sm font-medium text-gray-700 mb-1">Employee Code*</label>
                                <input type="text" id="overtime-employee-code" required class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Enter employee code">
                            </div>
                            <div>
                                <label for="overtime-employee-name" class="block text-sm font-medium text-gray-700 mb-1">Employee Name</label>
                                <input type="text" id="overtime-employee-name" readonly class="w-full p-2 border bg-gray-100 border-gray-300 rounded-md shadow-sm">
                                <input type="hidden" id="overtime-employee" value="">
                            </div>
                            <div>
                                <label for="overtime-date" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                                <input type="text" id="overtime-date" required placeholder="Select date" class="w-full p-2 border border-gray-300 rounded-md shadow-sm flatpickr-input">
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="overtime-start-time-display" class="block text-sm font-medium text-gray-700 mb-1">Start Time</label>
                                    <div class="flex">
                                        <input type="text" id="overtime-start-time-display" readonly required class="flex-1 p-2 border border-gray-300 rounded-l-md shadow-sm bg-gray-50 cursor-pointer" placeholder="Click to select time">
                                        <input type="hidden" id="overtime-start-time" required>
                                        <button type="button" onclick="openClockModal('overtime-start-time')" class="bg-gray-200 hover:bg-gray-300 p-2 rounded-r-md">
                                            <i class="fas fa-clock text-gray-600"></i>
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <label for="overtime-end-time-display" class="block text-sm font-medium text-gray-700 mb-1">End Time</label>
                                    <div class="flex">
                                        <input type="text" id="overtime-end-time-display" readonly required class="flex-1 p-2 border border-gray-300 rounded-l-md shadow-sm bg-gray-50 cursor-pointer" placeholder="Click to select time">
                                        <input type="hidden" id="overtime-end-time" required>
                                        <button type="button" onclick="openClockModal('overtime-end-time')" class="bg-gray-200 hover:bg-gray-300 p-2 rounded-r-md">
                                            <i class="fas fa-clock text-gray-600"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label for="overtime-reason" class="block text-sm font-medium text-gray-700 mb-1">Reason (Optional)</label>
                                <textarea id="overtime-reason" rows="3" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                            </div>
                            <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                                Submit Overtime Request
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Overtime Records - Full width when form is hidden -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Overtime Records</h2>

                    <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="overtime-filter-employee-code" class="block text-sm font-medium text-gray-700 mb-1">Filter by Employee Code</label>
                            <div class="flex space-x-2">
                                <input type="text" id="overtime-filter-employee-code" placeholder="Enter employee code" class="flex-1 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                <input type="hidden" id="overtime-filter-employee" value="all">
                            </div>
                        </div>
                        <div>
                            <label for="overtime-filter-employee-name" class="block text-sm font-medium text-gray-700 mb-1">Employee Name</label>
                            <input type="text" id="overtime-filter-employee-name" readonly class="w-full p-2 border bg-gray-100 border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="overtime-filter-month" class="block text-sm font-medium text-gray-700 mb-1">Filter by Month (Current Year)</label>
                            <select id="overtime-filter-month" class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                <option value="all">All Months</option>
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button id="overtime-filter-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                                <i class="fas fa-filter mr-1"></i> Apply Filters
                            </button>
                        </div>
                    </div>

                    <!-- Overtime Summary -->
                    <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h3 class="text-lg font-medium text-green-800 mb-2">Current Month Overtime</h3>
                            <div class="flex items-center">
                                <div class="text-3xl font-bold text-green-700" id="total-overtime-hours-month">0</div>
                                <div class="ml-2 text-sm text-green-600">hours</div>
                            </div>
                        </div>
                        <div class="bg-teal-50 p-4 rounded-lg">
                            <h3 class="text-lg font-medium text-teal-800 mb-2">Year-to-Date Overtime</h3>
                            <div class="flex items-center">
                                <div class="text-3xl font-bold text-teal-700" id="total-overtime-hours-year">0</div>
                                <div class="ml-2 text-sm text-teal-600">hours</div>
                            </div>
                        </div>
                    </div>

                    <div class="table-container">
                        <table id="overtimeTable" class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-blue-600">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Employee</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Date</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Time</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Hours</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Reason</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Status</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="overtimeTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="penalties" class="hidden space-y-6">
                <h1 class="text-3xl font-bold text-gray-800">Employee Penalties</h1>

                <!-- Add Penalty Button -->
                <div class="flex justify-end">
                    <button id="add-penalty-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                        <i class="fas fa-plus mr-1"></i> Add Penalty
                    </button>
                </div>

                <!-- Penalty Form - Hidden by default -->
                <div id="penalty-form-container" class="hidden">
                    <div class="bg-white p-6 rounded-lg shadow mb-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Add Penalty</h2>
                        <form id="penalty-form" class="space-y-4">
                            <div>
                                <label for="penalty-employee-code" class="block text-sm font-medium text-gray-700 mb-1">Employee Code*</label>
                                <input type="text" id="penalty-employee-code" required class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Enter employee code">
                            </div>
                            <div>
                                <label for="penalty-employee-name" class="block text-sm font-medium text-gray-700 mb-1">Employee Name</label>
                                <input type="text" id="penalty-employee-name" readonly class="w-full p-2 border bg-gray-100 border-gray-300 rounded-md shadow-sm">
                                <input type="hidden" id="penalty-employee" value="">
                            </div>
                            <div>
                                <label for="penalty-date" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                                <input type="text" id="penalty-date" required placeholder="Select date" class="w-full p-2 border border-gray-300 rounded-md shadow-sm flatpickr-input">
                            </div>
                            <div>
                                <label for="penalty-days" class="block text-sm font-medium text-gray-700 mb-1">Penalty Days</label>
                                <input type="number" id="penalty-days" required min="0.25" step="0.25" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Enter penalty days (0.25, 0.5, 0.75, etc.)">
                                <p class="text-xs text-gray-500 mt-1">Values will be auto-corrected to nearest 0.25 increment</p>
                            </div>
                            <div>
                                <label for="penalty-reason" class="block text-sm font-medium text-gray-700 mb-1">Reason*</label>
                                <textarea id="penalty-reason" required rows="3" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                            </div>
                            <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                                Add Penalty
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Penalty Records - Full width when form is hidden -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Penalty Records</h2>

                    <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="penalty-filter-employee-code" class="block text-sm font-medium text-gray-700 mb-1">Filter by Employee Code</label>
                            <div class="flex space-x-2">
                                <input type="text" id="penalty-filter-employee-code" placeholder="Enter employee code" class="flex-1 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                <input type="hidden" id="penalty-filter-employee" value="all">
                            </div>
                        </div>
                        <div>
                            <label for="penalty-filter-employee-name" class="block text-sm font-medium text-gray-700 mb-1">Employee Name</label>
                            <input type="text" id="penalty-filter-employee-name" readonly class="w-full p-2 border bg-gray-100 border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="penalty-filter-month" class="block text-sm font-medium text-gray-700 mb-1">Filter by Month (Current Year)</label>
                            <select id="penalty-filter-month" class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                <option value="all">All Months</option>
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button id="penalty-filter-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                                <i class="fas fa-filter mr-1"></i> Apply Filters
                            </button>
                        </div>
                    </div>

                    <!-- Penalty Summary -->
                    <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-red-50 p-4 rounded-lg">
                            <h3 class="text-lg font-medium text-red-800 mb-2">Current Month Penalties</h3>
                            <div class="flex items-center">
                                <div class="text-3xl font-bold text-red-700" id="total-penalty-days-month">0</div>
                                <div class="ml-2 text-sm text-red-600">days</div>
                            </div>
                        </div>
                        <div class="bg-orange-50 p-4 rounded-lg">
                            <h3 class="text-lg font-medium text-orange-800 mb-2">Year-to-Date Penalties</h3>
                            <div class="flex items-center">
                                <div class="text-3xl font-bold text-orange-700" id="total-penalty-days-year">0</div>
                                <div class="ml-2 text-sm text-orange-600">days</div>
                            </div>
                        </div>
                    </div>

                    <div class="table-container">
                        <table id="penaltyTable" class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-blue-600">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Employee</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Date</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Days</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Reason</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Status</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="penaltyTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="salary" class="hidden space-y-6">
                <h1 class="text-3xl font-bold text-gray-800">Salary Details</h1>

                <!-- Filters and Add Salary Button -->
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center space-y-4 md:space-y-0">
                    <!-- Filters -->
                    <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4 bg-white p-4 rounded-lg shadow">
                        <div class="flex items-center space-x-2">
                            <label for="salary-filter-employee-code" class="text-sm font-medium text-gray-700">Employee:</label>
                            <input type="text" id="salary-filter-employee-code" placeholder="Enter code" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <input type="text" id="salary-filter-employee-name" readonly class="bg-gray-100 border border-gray-300 rounded-md px-3 py-1 text-sm w-40">
                            <input type="hidden" id="salary-filter-employee" value="all">
                        </div>
                        <button id="salary-filter-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-1 px-4 rounded-md shadow transition duration-150">
                            <i class="fas fa-filter mr-1"></i> Apply Filters
                        </button>
                    </div>

                    <!-- Add Salary Button -->
                    <button id="add-salary-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                        <i class="fas fa-plus mr-1"></i> Add Salary Details
                    </button>
                </div>

                <!-- Salary Form Container (Hidden by default) -->
                <div id="salary-form-container" class="bg-white p-6 rounded-lg shadow hidden">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Add/Edit Salary Details</h2>
                    <form id="salary-form" class="space-y-4">
                        <!-- Employee Selection -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="salary-employee-code" class="block text-sm font-medium text-gray-700 mb-1">Employee Code</label>
                                <input type="text" id="salary-employee-code" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter employee code" required>
                                <input type="hidden" id="salary-employee" value="">
                            </div>
                            <div>
                                <label for="salary-employee-name" class="block text-sm font-medium text-gray-700 mb-1">Employee Name</label>
                                <input type="text" id="salary-employee-name" class="w-full bg-gray-100 border border-gray-300 rounded-md px-3 py-2" readonly>
                            </div>
                        </div>

                        <!-- Salary Details -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label for="salary-total" class="block text-sm font-medium text-gray-700 mb-1">Total Salary</label>
                                <input type="number" id="salary-total" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="0.00" step="0.01" min="0" required>
                            </div>
                            <div>
                                <label for="salary-basic" class="block text-sm font-medium text-gray-700 mb-1">Basic Salary</label>
                                <input type="number" id="salary-basic" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="0.00" step="0.01" min="0" required>
                            </div>
                            <div>
                                <label for="salary-allowance" class="block text-sm font-medium text-gray-700 mb-1">Fixed Allowance</label>
                                <input type="number" id="salary-allowance" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="0.00" step="0.01" min="0">
                            </div>
                            <div>
                                <label for="salary-deduction" class="block text-sm font-medium text-gray-700 mb-1">Fixed Deduction</label>
                                <input type="number" id="salary-deduction" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="0.00" step="0.01" min="0">
                            </div>
                        </div>

                        <!-- Bank Details -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="salary-bank" class="block text-sm font-medium text-gray-700 mb-1">Bank Name</label>
                                <input type="text" id="salary-bank" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter bank name">
                            </div>
                            <div>
                                <label for="salary-account" class="block text-sm font-medium text-gray-700 mb-1">Account Number</label>
                                <input type="text" id="salary-account" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter account number">
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="flex justify-end">
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-md shadow transition duration-150">
                                Save Salary Details
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Salary Table -->
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="table-container">
                        <table id="salaryTable" class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-blue-600">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Code</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Employee Name</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Total Salary</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Basic Salary</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Fixed Allowance</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Fixed Deduction</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Bank Name</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Account No.</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="salaryTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="payroll" class="hidden space-y-6">
                <h1 class="text-3xl font-bold text-gray-800">Payroll</h1>

                <!-- Payroll Controls -->
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center space-y-4 md:space-y-0">
                    <!-- Month Selection -->
                    <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4 bg-white p-4 rounded-lg shadow">
                        <div class="flex items-center space-x-2">
                            <label for="payroll-month" class="text-sm font-medium text-gray-700">Month:</label>
                            <select id="payroll-month" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                        <div class="flex items-center space-x-2">
                            <label for="payroll-year" class="text-sm font-medium text-gray-700">Year:</label>
                            <select id="payroll-year" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <!-- Will be populated by JS -->
                            </select>
                        </div>
                    </div>

                    <!-- Payroll Buttons -->
                    <div class="flex space-x-2">
                        <button id="run-payroll-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                            <i class="fas fa-calculator mr-1"></i> Run Current Month Payroll
                        </button>
                        <button id="export-payroll-btn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                            <i class="fas fa-file-excel mr-1"></i> Export to Excel
                        </button>
                    </div>
                </div>

                <!-- Payroll Form Container (Hidden by default) -->
                <div id="payroll-form-container" class="bg-white p-6 rounded-lg shadow hidden">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Payroll Calculation</h2>
                    <p class="text-sm text-gray-600 mb-4">Please enter the manual values for the payroll calculation. The system will automatically calculate the rest based on employee records.</p>

                    <div class="overflow-x-auto">
                        <table id="payrollCalculationTable" class="min-w-full divide-y divide-gray-200">
                            <thead>
                                <tr class="bg-blue-600">
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold bg-blue-600">Code</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold bg-blue-600">Name</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold bg-blue-600">Basic Salary</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold bg-blue-600">Fixed Allowance</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold bg-blue-600">Fuel Allowance</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold bg-blue-600">Reward (EGP)</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold bg-blue-600">Overtime</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold bg-blue-600">Fixed Deduction</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold bg-blue-600">Penalties/Days</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold bg-blue-600">Penalties (EGP)</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold bg-blue-600">Other Deductions</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold bg-blue-600">Net Salary</th>
                                </tr>
                            </thead>
                            <tbody id="payrollCalculationTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Will be populated by JS -->
                            </tbody>
                            <tfoot class="bg-gray-100 font-bold">
                                <tr id="payrollTotalsRow">
                                    <td colspan="2" class="px-4 py-3 text-right">Totals:</td>
                                    <td class="px-4 py-3" id="total-basic-salary">0.00</td>
                                    <td class="px-4 py-3" id="total-fixed-allowance">0.00</td>
                                    <td class="px-4 py-3" id="total-fuel-allowance">0.00</td>
                                    <td class="px-4 py-3" id="total-reward">0.00</td>
                                    <td class="px-4 py-3" id="total-overtime">0.00</td>
                                    <td class="px-4 py-3" id="total-fixed-deduction">0.00</td>
                                    <td class="px-4 py-3" id="total-penalties-days">0.00</td>
                                    <td class="px-4 py-3" id="total-penalties-egp">0.00</td>
                                    <td class="px-4 py-3" id="total-other-deductions">0.00</td>
                                    <td class="px-4 py-3" id="total-net-salary">0.00</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div class="flex justify-end mt-6 space-x-4">
                        <button id="cancel-payroll-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                            Cancel
                        </button>
                        <button id="save-payroll-btn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                            Save Payroll
                        </button>
                    </div>
                </div>

                <!-- Payroll Records -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Payroll Records</h2>

                    <!-- Payroll History Filters -->
                    <div class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="flex items-center space-x-2">
                            <label for="payroll-history-month" class="text-sm font-medium text-gray-700">Month:</label>
                            <select id="payroll-history-month" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="all">All Months</option>
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                        <div class="flex items-center space-x-2">
                            <label for="payroll-history-year" class="text-sm font-medium text-gray-700">Year:</label>
                            <select id="payroll-history-year" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="all">All Years</option>
                                <!-- Will be populated by JS -->
                            </select>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="payroll-history-filter-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-1 px-4 rounded-md shadow transition duration-150">
                                <i class="fas fa-filter mr-1"></i> <span id="filter-btn-text">Apply Filters</span>
                            </button>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table id="payrollHistoryTable" class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-blue-600">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Month/Year</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Code</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Name</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Basic Salary</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Total Allowances</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Total Deductions</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Net Salary</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="payrollHistoryTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Will be populated by JS -->
                                <tr>
                                    <td colspan="8" class="text-center py-4 text-gray-500">No payroll records found.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Employee Profile Section -->
            <section id="employee-profile" class="hidden space-y-6">
                <h1 class="text-3xl font-bold text-gray-800">My Profile</h1>

                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Employee Basic Info -->
                        <div class="md:col-span-1">
                            <div class="bg-indigo-50 p-6 rounded-lg text-center">
                                <div class="w-32 h-32 mx-auto bg-indigo-100 rounded-full flex items-center justify-center mb-4">
                                    <i class="fas fa-user text-indigo-600 text-5xl"></i>
                                </div>
                                <h2 id="profile-name" class="text-xl font-bold text-gray-800 mb-1"></h2>
                                <p id="profile-position" class="text-sm text-gray-600 mb-3"></p>
                                <div class="flex justify-center space-x-2">
                                    <span id="profile-status" class="px-3 py-1 text-xs font-semibold rounded-full"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Employee Details -->
                        <div class="md:col-span-2">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Personal Information</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm text-gray-500">Employee ID</p>
                                    <p id="profile-id" class="font-medium"></p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Department</p>
                                    <p id="profile-department" class="font-medium"></p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Email</p>
                                    <p id="profile-email" class="font-medium"></p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Phone</p>
                                    <p id="profile-phone" class="font-medium"></p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Date of Birth</p>
                                    <p id="profile-dob" class="font-medium"></p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Hiring Date</p>
                                    <p id="profile-hiring-date" class="font-medium"></p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Direct Manager</p>
                                    <p id="profile-manager" class="font-medium"></p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Level</p>
                                    <p id="profile-level" class="font-medium"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Leave Balance Card -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Leave Balance</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-green-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600">Annual Leave Balance</p>
                            <p id="profile-leave-balance" class="text-2xl font-bold text-green-600"></p>
                            <p class="text-xs text-gray-500 mt-1">Remaining days in current year</p>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600">Used Leave Days</p>
                            <p id="profile-used-leaves" class="text-2xl font-bold text-blue-600">0</p>
                            <p class="text-xs text-gray-500 mt-1">Days used in current year</p>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600">Pending Requests</p>
                            <p id="profile-pending-requests" class="text-2xl font-bold text-purple-600">0</p>
                            <p class="text-xs text-gray-500 mt-1">Awaiting approval</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- My Requests Section -->
            <section id="my-requests" class="hidden space-y-6">
                <h1 class="text-3xl font-bold text-gray-800">My Requests</h1>

                <!-- Request Actions -->
                <div class="flex flex-wrap gap-4">
                    <button id="new-leave-request-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                        <i class="fas fa-calendar-plus mr-2"></i> New Leave Request
                    </button>
                    <button id="new-excuse-request-btn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                        <i class="fas fa-clock mr-2"></i> New Excuse Request
                    </button>
                    <button id="new-overtime-request-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                        <i class="fas fa-business-time mr-2"></i> New Overtime Request
                    </button>
                </div>

                <!-- Requests Summary -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">Leave Requests</h3>
                            <span id="my-leave-count" class="px-3 py-1 bg-blue-100 text-blue-800 text-xs font-semibold rounded-full">0</span>
                        </div>
                        <div id="my-leave-requests" class="space-y-3 max-h-80 overflow-y-auto">
                            <!-- Leave requests will be populated here -->
                            <p class="text-gray-500 text-center py-4">No leave requests found</p>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">Excuse Requests</h3>
                            <span id="my-excuse-count" class="px-3 py-1 bg-green-100 text-green-800 text-xs font-semibold rounded-full">0</span>
                        </div>
                        <div id="my-excuse-requests" class="space-y-3 max-h-80 overflow-y-auto">
                            <!-- Excuse requests will be populated here -->
                            <p class="text-gray-500 text-center py-4">No excuse requests found</p>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">Overtime Requests</h3>
                            <span id="my-overtime-count" class="px-3 py-1 bg-purple-100 text-purple-800 text-xs font-semibold rounded-full">0</span>
                        </div>
                        <div id="my-overtime-requests" class="space-y-3 max-h-80 overflow-y-auto">
                            <!-- Overtime requests will be populated here -->
                            <p class="text-gray-500 text-center py-4">No overtime requests found</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Manager Dashboard Section -->
            <section id="manager-dashboard" class="hidden space-y-6">
                <h1 class="text-3xl font-bold text-gray-800">Manager Dashboard</h1>

                <!-- Team Overview -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">My Team</h2>
                    <div id="team-members-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Team members will be populated here -->
                        <p class="text-gray-500 col-span-full text-center py-4">No team members found</p>
                    </div>
                </div>

                <!-- Pending Approvals -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Pending Approvals</h2>

                    <!-- Tabs -->
                    <div class="border-b border-gray-200 mb-4">
                        <ul class="flex flex-wrap -mb-px">
                            <li class="mr-2">
                                <button id="tab-pending-leaves" class="inline-block py-2 px-4 text-blue-600 border-b-2 border-blue-600 font-medium" onclick="switchApprovalTab('pending-leaves')">
                                    Leaves <span id="pending-leaves-count" class="ml-1 px-2 py-0.5 bg-blue-100 text-blue-800 text-xs font-semibold rounded-full">0</span>
                                </button>
                            </li>
                            <li class="mr-2">
                                <button id="tab-pending-excuses" class="inline-block py-2 px-4 text-gray-500 hover:text-gray-700 font-medium" onclick="switchApprovalTab('pending-excuses')">
                                    Excuses <span id="pending-excuses-count" class="ml-1 px-2 py-0.5 bg-gray-100 text-gray-800 text-xs font-semibold rounded-full">0</span>
                                </button>
                            </li>
                            <li>
                                <button id="tab-pending-overtime" class="inline-block py-2 px-4 text-gray-500 hover:text-gray-700 font-medium" onclick="switchApprovalTab('pending-overtime')">
                                    Overtime <span id="pending-overtime-count" class="ml-1 px-2 py-0.5 bg-gray-100 text-gray-800 text-xs font-semibold rounded-full">0</span>
                                </button>
                            </li>
                        </ul>
                    </div>

                    <!-- Tab Content -->
                    <div id="pending-leaves-content" class="approval-tab-content">
                        <div id="pending-leaves-container" class="space-y-4">
                            <!-- Pending leave requests will be populated here -->
                            <p class="text-gray-500 text-center py-4">No pending leave requests</p>
                        </div>
                    </div>

                    <div id="pending-excuses-content" class="approval-tab-content hidden">
                        <div id="pending-excuses-container" class="space-y-4">
                            <!-- Pending excuse requests will be populated here -->
                            <p class="text-gray-500 text-center py-4">No pending excuse requests</p>
                        </div>
                    </div>

                    <div id="pending-overtime-content" class="approval-tab-content hidden">
                        <div id="pending-overtime-container" class="space-y-4">
                            <!-- Pending overtime requests will be populated here -->
                            <p class="text-gray-500 text-center py-4">No pending overtime requests</p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="settings" class="hidden space-y-6">
                <h1 class="text-3xl font-bold text-gray-800">Settings</h1>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Change Password</h2>
                        <form id="password-form" class="space-y-4">
                            <div>
                                <label for="current-password" class="block text-sm font-medium text-gray-700 mb-1">Current Password</label>
                                <input type="password" id="current-password" required class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label for="new-password" class="block text-sm font-medium text-gray-700 mb-1">New Password</label>
                                <input type="password" id="new-password" required class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label for="confirm-password" class="block text-sm font-medium text-gray-700 mb-1">Confirm New Password</label>
                                <input type="password" id="confirm-password" required class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                                Change Password
                            </button>
                        </form>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Appearance</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Theme</label>
                                <div class="flex space-x-4">
                                    <button id="light-mode-btn" class="flex-1 bg-white border border-gray-300 rounded-md py-2 px-4 font-medium hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                        <i class="fas fa-sun mr-2"></i> Light
                                    </button>
                                    <button id="dark-mode-btn" class="flex-1 bg-gray-800 text-white border border-gray-700 rounded-md py-2 px-4 font-medium hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                        <i class="fas fa-moon mr-2"></i> Dark
                                    </button>
                                </div>
                            </div>
                            <div class="pt-4 border-t space-y-4">
                                <button id="reset-btn" onclick="refreshDataFromSupabase()" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                                    <i class="fas fa-sync mr-2"></i> Refresh Data
                                </button>
                                <button id="logout-btn" onclick="logout()" class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                                    <i class="fas fa-sign-out-alt mr-2"></i> Logout
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <div id="employeeModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-10 mx-auto p-5 border w-full max-w-3xl shadow-lg rounded-md bg-white">
                <div class="flex justify-between items-center border-b pb-3 mb-5">
                    <h3 id="modalTitle" class="text-2xl font-semibold text-gray-800">Add New Employee</h3>
                    <button onclick="closeEmployeeModal()" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
                </div>
                <form id="employeeForm" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                    <input type="hidden" id="employeeId" value=""> <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="empCode" class="block text-sm font-medium text-gray-700">Employee Code*</label>
                            <input type="text" id="empCode" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="fullName" class="block text-sm font-medium text-gray-700">Full Name*</label>
                            <input type="text" id="fullName" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                         <div> <label for="gender" class="block text-sm font-medium text-gray-700">Gender*</label>
                            <select id="gender" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                <option value="">Select Gender</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                            </select>
                        </div>
                        <div>
                            <label for="hiringDate" class="block text-sm font-medium text-gray-700">Hiring Date*</label>
                            <div class="grid grid-cols-3 gap-2">
                                <select id="hiringDay" class="p-2 border border-gray-300 rounded-md shadow-sm">
                                    <option value="">Day</option>
                                    <!-- Days will be populated by JS -->
                                </select>
                                <select id="hiringMonth" class="p-2 border border-gray-300 rounded-md shadow-sm">
                                    <option value="">Month</option>
                                    <!-- Months will be populated by JS -->
                                </select>
                                <select id="hiringYear" class="p-2 border border-gray-300 rounded-md shadow-sm">
                                    <option value="">Year</option>
                                    <!-- Years will be populated by JS -->
                                </select>
                            </div>
                            <input type="hidden" id="hiringDate" required>
                        </div>
                        <div>
                            <label for="phone" class="block text-sm font-medium text-gray-700">Phone Number*</label>
                            <input type="tel" id="phone" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700">Email Address*</label>
                            <input type="email" id="email" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div class="md:col-span-2">
                            <label for="address" class="block text-sm font-medium text-gray-700">Address*</label>
                            <input type="text" id="address" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="position" class="block text-sm font-medium text-gray-700">Position*</label>
                            <div class="relative">
                                <input type="text" id="position" list="positionList" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                <datalist id="positionList">
                                    <!-- Will be populated by JS -->
                                </datalist>
                                <div class="text-xs text-gray-500 mt-1">Select from list or type a new position</div>
                            </div>
                        </div>
                         <div>
                            <label for="department" class="block text-sm font-medium text-gray-700">Department*</label>
                            <div class="relative">
                                <input type="text" id="department" list="departmentList" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                <datalist id="departmentList">
                                    <!-- Will be populated by JS -->
                                </datalist>
                                <div class="text-xs text-gray-500 mt-1">Select from list or type a new department</div>
                            </div>
                        </div>
                         <div>
                            <label for="dob" class="block text-sm font-medium text-gray-700">Date of Birth*</label>
                            <div class="grid grid-cols-3 gap-2">
                                <select id="dobDay" class="p-2 border border-gray-300 rounded-md shadow-sm">
                                    <option value="">Day</option>
                                    <!-- Days will be populated by JS -->
                                </select>
                                <select id="dobMonth" class="p-2 border border-gray-300 rounded-md shadow-sm">
                                    <option value="">Month</option>
                                    <!-- Months will be populated by JS -->
                                </select>
                                <select id="dobYear" class="p-2 border border-gray-300 rounded-md shadow-sm">
                                    <option value="">Year</option>
                                    <!-- Years will be populated by JS -->
                                </select>
                            </div>
                            <input type="hidden" id="dob" required>
                        </div>
                         <div>
                            <label for="idNumber" class="block text-sm font-medium text-gray-700">ID Number*</label>
                            <input type="text" id="idNumber" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                         <div>
                            <label for="socialInsurance" class="block text-sm font-medium text-gray-700">Social Insurance Number</label>
                            <input type="text" id="socialInsurance" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                         <div>
                            <label for="status" class="block text-sm font-medium text-gray-700">Status*</label>
                            <select id="status" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                        </div>
                         <div>
                            <label for="militaryStatus" class="block text-sm font-medium text-gray-700">Military Status</label>
                            <select id="militaryStatus" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                <option value="">N/A</option>
                                <option value="Completed">Completed</option>
                                <option value="Exempted">Exempted</option>
                                <option value="Postponed">Postponed</option>
                            </select>
                        </div>
                         <div>
                            <label for="level" class="block text-sm font-medium text-gray-700">Level*</label>
                            <select id="level" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                <option value="Non-manager">Non-manager</option>
                                <option value="Manager">Manager</option>
                            </select>
                        </div>
                         <div>
                            <label for="directManager" class="block text-sm font-medium text-gray-700">Direct Manager</label>
                            <select id="directManager" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                <option value="">Select Manager</option>
                                </select>
                        </div>
                         <div>
                            <label for="resignDate" class="block text-sm font-medium text-gray-700">Resign Date</label>
                            <div class="grid grid-cols-3 gap-2">
                                <select id="resignDay" class="p-2 border border-gray-300 rounded-md shadow-sm">
                                    <option value="">Day</option>
                                    <!-- Days will be populated by JS -->
                                </select>
                                <select id="resignMonth" class="p-2 border border-gray-300 rounded-md shadow-sm">
                                    <option value="">Month</option>
                                    <!-- Months will be populated by JS -->
                                </select>
                                <select id="resignYear" class="p-2 border border-gray-300 rounded-md shadow-sm">
                                    <option value="">Year</option>
                                    <!-- Years will be populated by JS -->
                                </select>
                            </div>
                            <input type="hidden" id="resignDate">
                        </div>
                        <div>
                            <label for="maritalStatus" class="block text-sm font-medium text-gray-700">Marital Status</label>
                            <select id="maritalStatus" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                <option value="">Select Status</option>
                                <option value="Single">Single</option>
                                <option value="Married">Married</option>
                                <option value="Divorced">Divorced</option>
                                <option value="Widowed">Widowed</option>
                            </select>
                        </div>
                         <div>
                            <label for="faculty" class="block text-sm font-medium text-gray-700">Faculty/Institute</label>
                            <input type="text" id="faculty" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="gradYear" class="block text-sm font-medium text-gray-700">Graduation Year</label>
                            <input type="number" id="gradYear" min="1950" max="2050" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="leaveBalance" class="block text-sm font-medium text-gray-700">Annual Leave Balance</label>
                            <input type="number" id="leaveBalance" min="0" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            <p class="text-xs text-gray-500 mt-1">Leave blank if employee has no balance. This will be manually managed by admin.</p>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 pt-4 border-t">
                        <button type="button" onclick="closeEmployeeModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-md shadow transition duration-150">Cancel</button>
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">Save Employee</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="messageBox" class="fixed bottom-5 right-5 bg-green-500 text-white p-4 rounded-lg shadow-lg hidden z-50 transition-opacity duration-300">
            <span id="messageText"></span>
        </div>

        <!-- Simplified Hour Selection Modal -->
        <div id="clockModal" class="clock-modal hidden">
            <div class="clock-modal-content">
                <div class="clock-modal-header">
                    <h3 class="clock-modal-title text-base" id="clock-modal-title">Select Time</h3>
                    <button id="close-clock-modal" class="clock-modal-close">&times;</button>
                </div>

                <!-- AM Hours -->
                <div class="mb-3">
                    <h4 class="text-center font-semibold text-gray-700 mb-1 text-sm">AM</h4>
                    <div class="grid grid-cols-4 gap-1" id="am-hours-container">
                        <!-- AM hours will be added by JS -->
                    </div>
                </div>

                <!-- PM Hours -->
                <div class="mb-3">
                    <h4 class="text-center font-semibold text-gray-700 mb-1 text-sm">PM</h4>
                    <div class="grid grid-cols-4 gap-1" id="pm-hours-container">
                        <!-- PM hours will be added by JS -->
                    </div>
                </div>

                <div class="clock-time-display text-center font-bold text-base text-indigo-600 my-2" id="clock-time-display">
                    Selected: <span id="selected-time-text">Not selected</span>
                </div>

                <div class="flex justify-end mt-3">
                    <button id="clock-confirm" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-1.5 px-4 rounded-md text-sm transition duration-150">
                        Confirm
                    </button>
                </div>
            </div>
        </div>

        <!-- Employee Card Modal -->
        <div id="employeeCardModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 items-center justify-center" style="display: none;">
            <div class="relative mx-auto p-5 border w-full max-w-xl shadow-lg rounded-md bg-white">
                <div class="flex justify-between items-center border-b pb-3 mb-4">
                    <h3 class="text-2xl font-semibold text-gray-800">Employee Details</h3>
                    <button onclick="closeEmployeeCardModal()" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
                </div>
                <div id="employeeCardContent" class="space-y-4">
                    <!-- Content will be dynamically populated -->
                    <div class="flex items-center justify-center p-8">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500"></div>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3 pt-4 border-t">
                    <button onclick="openEditEmployeeModalFromCard()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                        <i class="fas fa-edit mr-2"></i> Edit
                    </button>
                    <button onclick="closeEmployeeCardModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-md shadow transition duration-150">Close</button>
                </div>
            </div>
        </div>
    </div> <script>
        // --- Data Arrays (will be populated from Supabase) ---
        let employees = [];

        let leaveRecords = [];
        let excuseRecords = [];
        let overtimeRecords = [];
        let penaltyRecords = [];
        let salaryRecords = [];
        let payrollRecords = [];

        // --- Global Variables ---
        let departments = [];
        let positions = [];
        let managers = [];
        let currentUserRole = ''; // Will be set to 'admin', 'manager', or 'employee' during login
        let currentUserId = ''; // Will store the current user's ID (employee ID or 'admin')
        let currentUserData = null; // Will store the current user's data if they are an employee or manager
        let userAccounts = []; // Will store user account information
        let deptChartInstance, levelChartInstance, hiringChartInstance, leavesDeptChartInstance, genderChartInstance, ageChartInstance, monthlyHiringChartInstance;

        // --- Utility Functions ---
        function formatDate(dateString) {
            if (!dateString) return '';
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateString).toLocaleDateString(undefined, options);
        }

        function calculateLeaveDays(start, end) {
            // If start and end dates are the same, allow for half-day option
            if (start === end) {
                // Check if half-day is selected in the dropdown
                const selectedDays = parseFloat(document.getElementById('leave-days').value);
                if (selectedDays === 0.5) {
                    return 0.5; // Return 0.5 for half-day when dates are the same
                }
            }

            const startDate = new Date(start);
            const endDate = new Date(end);
            if (isNaN(startDate) || isNaN(endDate) || endDate < startDate) return 0;
            const diffTime = Math.abs(endDate - startDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
            return diffDays;
        }

        function showMessage(text, type = 'success') {
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            messageText.textContent = text;

            messageBox.classList.remove('hidden', 'bg-green-500', 'bg-red-500', 'opacity-0');
            messageBox.classList.add(type === 'success' ? 'bg-green-500' : 'bg-red-500', 'opacity-100');

            setTimeout(() => {
                messageBox.classList.remove('opacity-100');
                messageBox.classList.add('opacity-0');
                 setTimeout(() => messageBox.classList.add('hidden'), 300);
            }, 3000);
        }

        // --- Login/Logout ---
        // Note: handleLogin function is now implemented in the module script section below

        function logout() {
             // Reset the user role and ID
             currentUserRole = '';
             currentUserId = '';

             document.getElementById('login-form').reset();
             document.getElementById('login-error').classList.add('hidden');
             document.getElementById('app-container').classList.add('hidden');
             document.getElementById('login-screen').classList.remove('hidden');
             document.body.classList.remove('flex', 'h-screen');

             // Destroy all chart instances
             if (deptChartInstance) deptChartInstance.destroy();
             if (levelChartInstance) levelChartInstance.destroy();
             if (hiringChartInstance) hiringChartInstance.destroy();
             if (leavesDeptChartInstance) leavesDeptChartInstance.destroy();
             if (genderChartInstance) genderChartInstance.destroy();
             if (ageChartInstance) ageChartInstance.destroy();
             if (monthlyHiringChartInstance) monthlyHiringChartInstance.destroy();
             deptChartInstance = levelChartInstance = hiringChartInstance = leavesDeptChartInstance = genderChartInstance = ageChartInstance = monthlyHiringChartInstance = null;

             console.log("User logged out");
        }


        // Function to refresh data from Supabase
        async function refreshDataFromSupabase() {
            try {
                await loadSavedData();
                // Refresh all UI components
                updateDynamicDataLists();
                populateEmployeeTable();
                populateLeaveTable();
                populateExcuseTable();
                populateOvertimeTable();
                populatePenaltyTable();
                populateSalaryTable();
                populatePayrollHistoryTable();
                updateDashboard();
                showMessage('Data refreshed successfully from database!');
            } catch (error) {
                console.error('Error refreshing data:', error);
                showMessage('Error refreshing data from database.', 'error');
            }
        }

        // --- Application UI Initialization (Called after successful login) ---
        async function initializeAppUI() {
             console.log("Initializing application UI...");

             // Load data from Supabase
             await loadSavedData();

             // Initial population of dynamic data lists
             updateDynamicDataLists();

             // Populate dashboard filters first
             populateDashboardFilterDropdowns();

             // Calculate and update all employee leave balances
             updateAllEmployeeLeaveBalances();

             // Configure UI based on user role
             configureUIForUserRole();

             // Initial setup for the main app
             showSection('dashboard'); // Show dashboard by default
             populateFilterDropdowns(); // Populate DB filters and modal dropdowns
             populateEmployeeTable(); // Populate DB table with all employees initially
             populateLeaveTable();
             populateExcuseTable();
             populateOvertimeTable();
             populatePenaltyTable();
             populateSalaryTable();
             populatePayrollYearDropdowns(); // Initialize payroll year dropdowns
             populatePayrollHistoryTable(); // Initialize payroll history table
             updateExcuseSummary();
             updateOvertimeSummary();
             updatePenaltySummary();

             // Initialize analog clock
             initializeAnalogClock();

             // Set up leave filter employee code validation
             setupLeaveFilterEmployeeCodeValidation();

             // Set up overtime employee code validation
             setupOvertimeEmployeeCodeValidation();

             // Set up overtime filter employee code validation
             setupOvertimeFilterEmployeeCodeValidation();

             // Set up excuse filter employee code validation
             setupExcuseFilterEmployeeCodeValidation();

             // Set up penalty filter employee code validation
             setupPenaltyFilterEmployeeCodeValidation();

             // Set up salary filter employee code validation
             setupSalaryFilterEmployeeCodeValidation();

             // Set up salary employee code validation
             setupSalaryEmployeeCodeValidation();

             // Add filter buttons to excuse and penalty sections
             addFilterButtonsToExcuseAndPenalty();

             // Update month filter labels to show current year
             updateMonthFilterLabels();

             // Add event listener for overtime form submission
             document.getElementById('overtime-form').addEventListener('submit', handleOvertimeFormSubmit);

             // Initial dashboard update (stats and charts) with all data
             updateDashboard();

             // Update dashboard notifications
             updateDashboardNotifications();

             // Add form submit listeners (ensure they are added only once)
             const employeeForm = document.getElementById('employeeForm');
             const leaveForm = document.getElementById('leave-form');
             const excuseForm = document.getElementById('excuse-form');
             const penaltyForm = document.getElementById('penalty-form');
             const salaryForm = document.getElementById('salary-form');

             employeeForm.removeEventListener('submit', handleEmployeeFormSubmit);
             leaveForm.removeEventListener('submit', handleLeaveFormSubmit);
             excuseForm.removeEventListener('submit', handleExcuseFormSubmit);
             penaltyForm.removeEventListener('submit', handlePenaltyFormSubmit);
             salaryForm.removeEventListener('submit', handleSalaryFormSubmit);

             employeeForm.addEventListener('submit', handleEmployeeFormSubmit);
             leaveForm.addEventListener('submit', handleLeaveFormSubmit);
             excuseForm.addEventListener('submit', handleExcuseFormSubmit);
             penaltyForm.addEventListener('submit', handlePenaltyFormSubmit);
             salaryForm.addEventListener('submit', handleSalaryFormSubmit);

             // Add validation to leave form
             document.getElementById('leave-form').addEventListener('submit', function(event) {
                 if (!validateLeaveDays()) {
                     event.preventDefault();
                     return false;
                 }
             });

             // Add button functionality for all sections
             document.getElementById('add-leave-btn').addEventListener('click', function() {
                 document.getElementById('leave-form-container').classList.remove('hidden');
             });

             document.getElementById('add-excuse-btn').addEventListener('click', function() {
                 document.getElementById('excuse-form-container').classList.remove('hidden');
             });

             document.getElementById('add-overtime-btn').addEventListener('click', function() {
                 document.getElementById('overtime-form-container').classList.remove('hidden');
             });

             document.getElementById('add-penalty-btn').addEventListener('click', function() {
                 document.getElementById('penalty-form-container').classList.remove('hidden');
             });

             document.getElementById('add-salary-btn').addEventListener('click', function() {
                 document.getElementById('salary-form-container').classList.remove('hidden');
             });

             // Add event listener for penalty days input to auto-correct on blur
             const penaltyDaysInput = document.getElementById('penalty-days');
             if (penaltyDaysInput) {
                 penaltyDaysInput.addEventListener('blur', function() {
                     const correctedValue = validatePenaltyDays(this.value);
                     this.value = correctedValue;
                 });
             }

             // Add listener for database search input
             document.getElementById('search-db').addEventListener('input', filterEmployeeTable);

             // Setup theme toggle
             document.getElementById('light-mode-btn').addEventListener('click', () => setTheme('light'));
             document.getElementById('dark-mode-btn').addEventListener('click', () => setTheme('dark'));

             // Mobile menu toggle is handled in the main initialization section below

             console.log("HR System Application UI Initialized");

             // EMERGENCY FIX: Force close any stuck modals
             const employeeCardModal = document.getElementById('employeeCardModal');
             if (employeeCardModal) {
                 employeeCardModal.classList.add('hidden');
                 console.log('Forced employee card modal to close');
             }
        }

        // Load employee data and all requests from Supabase
        async function loadEmployeeData() {
            try {
                console.log('Loading all data from Supabase...');

                // Load employees
                const { data: employeeData, error: employeeError } = await dbHelpers.getAllEmployees();
                if (employeeError) {
                    console.error('Error loading employees:', employeeError);
                } else {
                    employees = employeeData || [];
                    console.log(`Loaded ${employees.length} employees from Supabase`);
                }

                // Load leave requests
                const { data: leaveData, error: leaveError } = await dbHelpers.getAllLeaveRequests();
                if (leaveError) {
                    console.error('Error loading leave requests:', leaveError);
                } else {
                    // Convert Supabase format to local format
                    leaveRecords = (leaveData || []).map(leave => ({
                        id: leave.id,
                        employeeId: leave.employee_id,
                        employeeName: leave.employee_name,
                        startDate: leave.start_date,
                        endDate: leave.end_date,
                        days: leave.days,
                        type: leave.type,
                        status: leave.status
                    }));
                    console.log(`Loaded ${leaveRecords.length} leave requests from Supabase`);
                }

                // Load excuse requests
                const { data: excuseData, error: excuseError } = await dbHelpers.getAllExcuseRequests();
                if (excuseError) {
                    console.error('Error loading excuse requests:', excuseError);
                } else {
                    // Convert Supabase format to local format
                    excuseRecords = (excuseData || []).map(excuse => ({
                        id: excuse.id,
                        employeeId: excuse.employee_id,
                        employeeName: excuse.employee_name,
                        date: excuse.date,
                        type: excuse.type,
                        startTime: excuse.start_time,
                        endTime: excuse.end_time,
                        reason: excuse.reason,
                        status: excuse.status
                    }));
                    console.log(`Loaded ${excuseRecords.length} excuse requests from Supabase`);
                }

                // Load overtime requests
                const { data: overtimeData, error: overtimeError } = await dbHelpers.getAllOvertimeRequests();
                if (overtimeError) {
                    console.error('Error loading overtime requests:', overtimeError);
                } else {
                    // Convert Supabase format to local format
                    overtimeRecords = (overtimeData || []).map(overtime => ({
                        id: overtime.id,
                        employeeId: overtime.employee_id,
                        employeeName: overtime.employee_name,
                        date: overtime.date,
                        startTime: overtime.start_time,
                        endTime: overtime.end_time,
                        hours: overtime.hours,
                        reason: overtime.reason,
                        status: overtime.status
                    }));
                    console.log(`Loaded ${overtimeRecords.length} overtime requests from Supabase`);
                }

                // Load penalties
                const { data: penaltyData, error: penaltyError } = await dbHelpers.getAllPenalties();
                if (penaltyError) {
                    console.error('Error loading penalties:', penaltyError);
                } else {
                    // Convert Supabase format to local format
                    penaltyRecords = (penaltyData || []).map(penalty => ({
                        id: penalty.id,
                        employeeId: penalty.employee_id,
                        employeeName: penalty.employee_name,
                        date: penalty.date,
                        days: penalty.days,
                        reason: penalty.reason,
                        status: penalty.status
                    }));
                    console.log(`Loaded ${penaltyRecords.length} penalties from Supabase`);
                }

                // Load salary details
                const { data: salaryData, error: salaryError } = await dbHelpers.getAllSalaryDetails();
                if (salaryError) {
                    console.error('Error loading salary details:', salaryError);
                } else {
                    // Convert Supabase format to local format
                    salaryRecords = (salaryData || []).map(salary => ({
                        id: salary.id,
                        employeeId: salary.employee_id,
                        employeeName: salary.employee_name,
                        totalSalary: salary.total_salary,
                        basicSalary: salary.basic_salary,
                        fixedAllowance: salary.fixed_allowance,
                        fixedDeduction: salary.fixed_deduction,
                        bankName: salary.bank_name,
                        accountNumber: salary.account_number
                    }));
                    console.log(`Loaded ${salaryRecords.length} salary records from Supabase`);
                }

                // Load payroll data
                const { data: payrollData, error: payrollError } = await dbHelpers.getAllPayroll();
                if (payrollError) {
                    console.error('Error loading payroll data:', payrollError);
                } else {
                    // Convert Supabase format to local format
                    payrollRecords = (payrollData || []).map(payroll => ({
                        id: payroll.id,
                        employeeId: payroll.employee_id,
                        employeeName: payroll.employee_name,
                        month: payroll.month,
                        year: payroll.year,
                        basicSalary: payroll.basic_salary,
                        allowances: payroll.allowances,
                        deductions: payroll.deductions,
                        netSalary: payroll.net_salary
                    }));
                    console.log(`Loaded ${payrollRecords.length} payroll records from Supabase`);
                }

            } catch (error) {
                console.error('Error loading data from Supabase:', error);
            }
        }

        // Load data from Supabase
        async function loadSavedData() {
            try {
                console.log('Loading data from Supabase...');

                // Load employees
                const { data: employeeData, error: employeeError } = await dbHelpers.getAllEmployees();
                if (employeeError) {
                    console.error('Error loading employees:', employeeError);
                } else {
                    employees = employeeData || [];
                    console.log(`Loaded ${employees.length} employees from Supabase`);
                }

                // Load leaves
                const { data: leaveData, error: leaveError } = await dbHelpers.getAllLeaves();
                if (leaveError) {
                    console.error('Error loading leaves:', leaveError);
                } else {
                    // Convert Supabase format to local format (same as loadEmployeeData)
                    leaveRecords = (leaveData || []).map(leave => ({
                        id: leave.id,
                        employeeId: leave.employee_id,
                        employeeName: leave.employee_name,
                        startDate: leave.start_date,
                        endDate: leave.end_date,
                        days: leave.days,
                        type: leave.type,
                        status: leave.status
                    }));
                    console.log(`Loaded ${leaveRecords.length} leave records from Supabase`);
                }

                // Load excuses
                const { data: excuseData, error: excuseError } = await dbHelpers.getAllExcuses();
                if (excuseError) {
                    console.error('Error loading excuses:', excuseError);
                } else {
                    // Convert Supabase format to local format (same as loadEmployeeData)
                    excuseRecords = (excuseData || []).map(excuse => ({
                        id: excuse.id,
                        employeeId: excuse.employee_id,
                        employeeName: excuse.employee_name,
                        date: excuse.date,
                        type: excuse.type,
                        startTime: excuse.start_time,
                        endTime: excuse.end_time,
                        reason: excuse.reason,
                        status: excuse.status
                    }));
                    console.log(`Loaded ${excuseRecords.length} excuse records from Supabase`);
                }

                // Load overtime
                const { data: overtimeData, error: overtimeError } = await dbHelpers.getAllOvertime();
                if (overtimeError) {
                    console.error('Error loading overtime:', overtimeError);
                } else {
                    // Convert Supabase format to local format (same as loadEmployeeData)
                    overtimeRecords = (overtimeData || []).map(overtime => ({
                        id: overtime.id,
                        employeeId: overtime.employee_id,
                        employeeName: overtime.employee_name,
                        date: overtime.date,
                        startTime: overtime.start_time,
                        endTime: overtime.end_time,
                        hours: overtime.hours,
                        reason: overtime.reason,
                        status: overtime.status
                    }));
                    console.log(`Loaded ${overtimeRecords.length} overtime records from Supabase`);
                }

                // Load penalties
                const { data: penaltyData, error: penaltyError } = await dbHelpers.getAllPenalties();
                if (penaltyError) {
                    console.error('Error loading penalties:', penaltyError);
                } else {
                    penaltyRecords = penaltyData || [];
                    console.log(`Loaded ${penaltyRecords.length} penalty records from Supabase`);
                }

                // Load salary details (use the correct function)
                const { data: salaryData, error: salaryError } = await dbHelpers.getAllSalaryDetails();
                if (salaryError) {
                    console.error('Error loading salary details:', salaryError);
                } else {
                    // Convert Supabase format to local format
                    salaryRecords = (salaryData || []).map(salary => ({
                        id: salary.id,
                        employeeId: salary.employee_id,
                        employeeName: salary.employee_name,
                        totalSalary: salary.total_salary,
                        basicSalary: salary.basic_salary,
                        fixedAllowance: salary.fixed_allowance,
                        fixedDeduction: salary.fixed_deduction,
                        bankName: salary.bank_name,
                        accountNumber: salary.account_number
                    }));
                    console.log(`Loaded ${salaryRecords.length} salary records from Supabase`);
                }

                // Load payroll data
                const { data: payrollData, error: payrollError } = await dbHelpers.getAllPayroll();
                if (payrollError) {
                    console.error('Error loading payroll data:', payrollError);
                } else {
                    // Convert Supabase format to local format
                    payrollRecords = (payrollData || []).map(payroll => ({
                        id: payroll.id,
                        employeeId: payroll.employee_id,
                        employeeName: payroll.employee_name,
                        month: payroll.month,
                        year: payroll.year,
                        basicSalary: payroll.basic_salary,
                        allowances: payroll.allowances,
                        deductions: payroll.deductions,
                        netSalary: payroll.net_salary,
                        // Add missing fields for compatibility
                        fixedAllowance: 0,
                        fuelAllowance: 0,
                        reward: 0,
                        overtime: 0,
                        fixedDeduction: 0,
                        penaltiesDays: 0,
                        penaltiesEgp: 0,
                        otherDeductions: 0,
                        date: new Date().toISOString()
                    }));
                    console.log(`Loaded ${payrollRecords.length} payroll records from Supabase`);
                }

                console.log('Data loading from Supabase completed');

            } catch (error) {
                console.error('Error loading data from Supabase:', error);
                showMessage('Error loading data from database. Some features may not work properly.', 'error');
            }
        }

        // Note: User account management is now handled by Supabase
        // Use utils.createInitialAdmin() from browser console to create the first admin user

        // Set theme (light/dark)
        function setTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                localStorage.setItem('hrSystemTheme', 'dark');
            } else {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('hrSystemTheme', 'light');
            }
        }

        // --- Update dynamic data lists (departments, positions, managers) ---
        function updateDynamicDataLists() {
            departments = [...new Set(employees.map(e => e.department))].sort();
            positions = [...new Set(employees.map(e => e.position))].sort();
            managers = employees.filter(e => e.level === 'Manager');
        }

        // --- Configure UI based on user role ---
        function configureUIForUserRole() {
            console.log(`Configuring UI for user role: ${currentUserRole}`);

            // Hide all admin-only elements by default
            document.querySelectorAll('.admin-only').forEach(el => {
                el.classList.add('hidden');
            });

            // Show/hide elements based on user role
            if (currentUserRole === 'admin') {
                // Show all admin-only elements
                document.querySelectorAll('.admin-only').forEach(el => {
                    el.classList.remove('hidden');
                });

                // Admin sees the full dashboard
                showSection('dashboard');
            }
            else if (currentUserRole === 'admin_1') {
                // Show all admin-only elements
                document.querySelectorAll('.admin-only').forEach(el => {
                    el.classList.remove('hidden');
                });

                // Hide salary and payroll sections for admin_1
                const salaryNav = document.getElementById('nav-item-salary');
                const payrollNav = document.getElementById('nav-item-payroll');
                if (salaryNav) salaryNav.classList.add('hidden');
                if (payrollNav) payrollNav.classList.add('hidden');

                // Admin_1 sees the dashboard but with limited access
                showSection('dashboard');
            }
            else if (currentUserRole === 'manager') {
                // Show manager-specific elements
                document.getElementById('nav-item-employee-profile').classList.remove('hidden');
                document.getElementById('nav-item-my-requests').classList.remove('hidden');
                document.getElementById('nav-item-manager-dashboard').classList.remove('hidden');

                // Make sure dashboard is hidden
                document.getElementById('nav-item-dashboard').classList.add('hidden');
                document.getElementById('dashboard').classList.add('hidden');

                // Initialize manager dashboard
                initializeManagerDashboard();

                // Show manager dashboard by default
                showSection('manager-dashboard');
            }
            else if (currentUserRole === 'employee') {
                // Show employee-specific elements
                document.getElementById('nav-item-employee-profile').classList.remove('hidden');
                document.getElementById('nav-item-my-requests').classList.remove('hidden');

                // Make sure dashboard is hidden
                document.getElementById('nav-item-dashboard').classList.add('hidden');
                document.getElementById('dashboard').classList.add('hidden');

                // Initialize employee profile
                initializeEmployeeProfile();

                // Show employee profile by default
                showSection('employee-profile');
            }

            // Set up event listeners for request buttons
            setupRequestButtonListeners();
        }

        // --- Initialize Employee Profile ---
        function initializeEmployeeProfile() {
            if (!currentUserData) return;

            // Set basic profile information
            document.getElementById('profile-name').textContent = currentUserData.fullName;
            document.getElementById('profile-position').textContent = currentUserData.position;

            // Set status badge
            const statusBadge = document.getElementById('profile-status');
            statusBadge.textContent = currentUserData.status;
            if (currentUserData.status === 'Active') {
                statusBadge.classList.add('bg-green-100', 'text-green-800');
            } else {
                statusBadge.classList.add('bg-red-100', 'text-red-800');
            }

            // Set other profile details
            document.getElementById('profile-id').textContent = currentUserData.id;
            document.getElementById('profile-department').textContent = currentUserData.department;
            document.getElementById('profile-email').textContent = currentUserData.email || 'Not provided';
            document.getElementById('profile-phone').textContent = currentUserData.phone || 'Not provided';
            document.getElementById('profile-dob').textContent = formatDate(currentUserData.dob);
            document.getElementById('profile-hiring-date').textContent = formatDate(currentUserData.hiringDate);
            document.getElementById('profile-manager').textContent = currentUserData.directManager || 'None';
            document.getElementById('profile-level').textContent = currentUserData.level;

            // Set leave balance
            document.getElementById('profile-leave-balance').textContent = currentUserData.annualLeaveBalance || 0;

            // Calculate used leaves
            const usedLeaves = calculateUsedLeaves(currentUserData.id);
            document.getElementById('profile-used-leaves').textContent = usedLeaves;

            // Calculate pending requests
            const pendingRequests = calculatePendingRequests(currentUserData.id);
            document.getElementById('profile-pending-requests').textContent = pendingRequests;

            // Populate my requests section
            populateMyRequests();
        }

        // --- Calculate Used Leaves ---
        function calculateUsedLeaves(employeeId) {
            const currentYear = new Date().getFullYear();
            const approvedLeaves = leaveRecords.filter(record =>
                record.employeeId === employeeId &&
                record.status === 'Approved' &&
                new Date(record.startDate).getFullYear() === currentYear &&
                (record.type === 'Annual Leave' || record.type === 'annual')
            );

            return approvedLeaves.reduce((total, record) => total + record.days, 0);
        }

        // --- Calculate Pending Requests ---
        function calculatePendingRequests(employeeId) {
            const pendingLeaves = leaveRecords.filter(record =>
                record.employeeId === employeeId && record.status === 'Pending'
            ).length;

            const pendingExcuses = excuseRecords.filter(record =>
                record.employeeId === employeeId && record.status === 'Pending'
            ).length;

            const pendingOvertime = overtimeRecords.filter(record =>
                record.employeeId === employeeId && record.status === 'Pending'
            ).length;

            return pendingLeaves + pendingExcuses + pendingOvertime;
        }

        // --- Populate My Requests Section ---
        async function populateMyRequests() {
            if (!currentUserData) return;

            const employeeId = currentUserData.id;

            // Reload data from Supabase to ensure we have the latest data
            try {
                await loadEmployeeData();
                console.log('Reloaded data from Supabase for My Requests');
            } catch (error) {
                console.error('Error reloading data for My Requests:', error);
            }

            // Get employee's leave requests
            const myLeaves = leaveRecords.filter(record => record.employeeId === employeeId);
            const myExcuses = excuseRecords.filter(record => record.employeeId === employeeId);
            const myOvertime = overtimeRecords.filter(record => record.employeeId === employeeId);

            // Update counts
            document.getElementById('my-leave-count').textContent = myLeaves.length;
            document.getElementById('my-excuse-count').textContent = myExcuses.length;
            document.getElementById('my-overtime-count').textContent = myOvertime.length;

            // Populate leave requests
            const leaveContainer = document.getElementById('my-leave-requests');
            leaveContainer.innerHTML = '';

            if (myLeaves.length === 0) {
                leaveContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No leave requests found</p>';
            } else {
                myLeaves.forEach(leave => {
                    const statusClass = leave.status === 'Approved' ? 'bg-green-100 text-green-800' :
                                       (leave.status === 'Pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800');

                    leaveContainer.innerHTML += `
                        <div class="p-3 border rounded-lg">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-medium">${leave.type}</p>
                                    <p class="text-sm text-gray-600">${formatDate(leave.startDate)} - ${formatDate(leave.endDate)}</p>
                                    <p class="text-sm text-gray-500">${leave.days} day(s)</p>
                                </div>
                                <span class="px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">${leave.status}</span>
                            </div>
                        </div>
                    `;
                });
            }

            // Populate excuse requests
            const excuseContainer = document.getElementById('my-excuse-requests');
            excuseContainer.innerHTML = '';

            if (myExcuses.length === 0) {
                excuseContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No excuse requests found</p>';
            } else {
                myExcuses.forEach(excuse => {
                    const statusClass = excuse.status === 'Approved' ? 'bg-green-100 text-green-800' :
                                       (excuse.status === 'Pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800');

                    excuseContainer.innerHTML += `
                        <div class="p-3 border rounded-lg">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-medium">${excuse.type}</p>
                                    <p class="text-sm text-gray-600">${formatDate(excuse.date)}</p>
                                    <p class="text-sm text-gray-500">${excuse.startTime} - ${excuse.endTime}</p>
                                </div>
                                <span class="px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">${excuse.status}</span>
                            </div>
                        </div>
                    `;
                });
            }

            // Populate overtime requests
            const overtimeContainer = document.getElementById('my-overtime-requests');
            overtimeContainer.innerHTML = '';

            if (myOvertime.length === 0) {
                overtimeContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No overtime requests found</p>';
            } else {
                myOvertime.forEach(overtime => {
                    const statusClass = overtime.status === 'Approved' ? 'bg-green-100 text-green-800' :
                                       (overtime.status === 'Pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800');

                    overtimeContainer.innerHTML += `
                        <div class="p-3 border rounded-lg">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-medium">Overtime Request</p>
                                    <p class="text-sm text-gray-600">${formatDate(overtime.date)}</p>
                                    <p class="text-sm text-gray-500">${overtime.startTime} - ${overtime.endTime} (${overtime.hours} hours)</p>
                                </div>
                                <span class="px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">${overtime.status}</span>
                            </div>
                        </div>
                    `;
                });
            }
        }

        // --- Initialize Manager Dashboard ---
        function initializeManagerDashboard() {
            if (!currentUserData) return;

            // Add permanent button click handler for manager approval buttons
            document.addEventListener('click', function(e) {
                if (e.target.tagName === 'BUTTON') {
                    const onclick = e.target.getAttribute('onclick');

                    // Handle approval/rejection buttons with syntax error protection
                    if (onclick && (onclick.includes('approve') || onclick.includes('reject')) && onclick.includes('RecordFromManager')) {
                        e.preventDefault();
                        e.stopPropagation();

                        console.log('Manager approval button clicked:', onclick);

                        // Robust parsing for UUIDs with dashes
                        const match = onclick.match(/(approve|reject)(\w+)RecordFromManager\((.+)\)/);

                        if (match) {
                            const action = match[1];
                            const type = match[2];
                            let id = match[3].replace(/['"]/g, '').trim();
                            const functionName = `${action}${type}RecordFromManager`;

                            console.log(`Executing: ${functionName}('${id}')`);

                            if (typeof window[functionName] === 'function') {
                                try {
                                    window[functionName](id);
                                    console.log(` ${functionName} executed successfully`);
                                } catch (error) {
                                    console.error(` Error executing ${functionName}:`, error);
                                }
                            } else {
                                console.error(` Function ${functionName} not found`);
                            }
                        }
                    }
                }
            });

            // Get team members (employees who have this manager as their direct manager)
            const managerName = currentUserData.fullName || currentUserData.full_name;
            const teamMembers = employees.filter(emp => {
                const empManager = emp.directManager || emp.direct_manager;
                return empManager === managerName && emp.id !== currentUserData.id;
            });

            // Populate team members
            const teamContainer = document.getElementById('team-members-container');
            teamContainer.innerHTML = '';

            if (teamMembers.length === 0) {
                teamContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center py-4">No team members found</p>';
            } else {
                teamMembers.forEach(member => {
                    const statusClass = member.status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                    const memberName = member.fullName || member.full_name || 'Unknown';

                    teamContainer.innerHTML += `
                        <div class="bg-white p-4 rounded-lg border">
                            <div class="flex items-center space-x-3">
                                <div class="flex-shrink-0 h-10 w-10 bg-indigo-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-user text-indigo-600"></i>
                                </div>
                                <div>
                                    <p class="font-medium">${memberName}</p>
                                    <p class="text-sm text-gray-500">${member.position}</p>
                                </div>
                            </div>
                            <div class="mt-3 flex justify-between items-center">
                                <span class="px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">${member.status}</span>
                                <span class="text-xs text-gray-500">ID: ${member.id}</span>
                            </div>
                        </div>
                    `;
                });
            }

            // Populate pending approvals
            populatePendingApprovals();
        }

        // --- Populate Pending Approvals ---
        function populatePendingApprovals() {
            if (!currentUserData) return;

            // Get team members IDs - employees who have this manager as their direct manager
            const managerName = currentUserData.fullName || currentUserData.full_name;
            console.log("DEBUG: Current user data:", currentUserData);
            console.log("DEBUG: Manager name:", managerName);
            console.log("DEBUG: All employees:", employees.map(e => ({id: e.id, name: e.fullName || e.full_name, manager: e.directManager || e.direct_manager})));

            const teamMemberIds = employees
                .filter(emp => {
                    const empManager = emp.directManager || emp.direct_manager;
                    const isTeamMember = empManager === managerName && emp.id !== currentUserData.id;
                    console.log(`DEBUG: Employee ${emp.id} (${emp.fullName || emp.full_name}) - Manager: ${empManager}, Is team member: ${isTeamMember}`);
                    return isTeamMember;
                })
                .map(emp => emp.id);

            console.log("Manager:", managerName);
            console.log("Team member IDs:", teamMemberIds);

            // Get pending leave requests from team members
            const pendingLeaves = leaveRecords.filter(record =>
                teamMemberIds.includes(record.employeeId) && record.status === 'Pending'
            );

            // Get pending excuse requests from team members
            const pendingExcuses = excuseRecords.filter(record =>
                teamMemberIds.includes(record.employeeId) && record.status === 'Pending'
            );

            // Get pending overtime requests from team members
            const pendingOvertime = overtimeRecords.filter(record =>
                teamMemberIds.includes(record.employeeId) && record.status === 'Pending'
            );

            console.log("Pending leaves:", pendingLeaves);
            console.log("Pending excuses:", pendingExcuses);
            console.log("Pending overtime:", pendingOvertime);

            // Update counts
            document.getElementById('pending-leaves-count').textContent = pendingLeaves.length;
            document.getElementById('pending-excuses-count').textContent = pendingExcuses.length;
            document.getElementById('pending-overtime-count').textContent = pendingOvertime.length;

            // Populate pending leaves container
            const leavesContainer = document.getElementById('pending-leaves-container');
            leavesContainer.innerHTML = '';

            if (pendingLeaves.length === 0) {
                leavesContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No pending leave requests</p>';
            } else {
                pendingLeaves.forEach(leave => {
                    leavesContainer.innerHTML += `
                        <div class="p-4 border rounded-lg">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <p class="font-medium">${leave.employeeName}</p>
                                    <p class="text-sm text-gray-600">${leave.type}</p>
                                    <p class="text-sm text-gray-500">${formatDate(leave.startDate)} - ${formatDate(leave.endDate)} (${leave.days} days)</p>
                                </div>
                                <span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">Pending</span>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="approveLeaveRecordFromManager(${leave.id})" class="flex-1 bg-green-600 hover:bg-green-700 text-white text-sm font-medium py-2 px-3 rounded">
                                    <i class="fas fa-check mr-1"></i> Approve
                                </button>
                                <button onclick="rejectLeaveRecordFromManager(${leave.id})" class="flex-1 bg-red-600 hover:bg-red-700 text-white text-sm font-medium py-2 px-3 rounded">
                                    <i class="fas fa-times mr-1"></i> Reject
                                </button>
                            </div>
                        </div>
                    `;
                });
            }

            // Populate pending excuses container
            const excusesContainer = document.getElementById('pending-excuses-container');
            excusesContainer.innerHTML = '';

            if (pendingExcuses.length === 0) {
                excusesContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No pending excuse requests</p>';
            } else {
                pendingExcuses.forEach(excuse => {
                    excusesContainer.innerHTML += `
                        <div class="p-4 border rounded-lg">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <p class="font-medium">${excuse.employeeName}</p>
                                    <p class="text-sm text-gray-600">${excuse.type}</p>
                                    <p class="text-sm text-gray-500">${formatDate(excuse.date)}: ${excuse.startTime} - ${excuse.endTime}</p>
                                    <p class="text-xs text-gray-500 mt-1">Reason: ${excuse.reason}</p>
                                </div>
                                <span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">Pending</span>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="approveExcuseRecordFromManager(${excuse.id})" class="flex-1 bg-green-600 hover:bg-green-700 text-white text-sm font-medium py-2 px-3 rounded">
                                    <i class="fas fa-check mr-1"></i> Approve
                                </button>
                                <button onclick="rejectExcuseRecordFromManager(${excuse.id})" class="flex-1 bg-red-600 hover:bg-red-700 text-white text-sm font-medium py-2 px-3 rounded">
                                    <i class="fas fa-times mr-1"></i> Reject
                                </button>
                            </div>
                        </div>
                    `;
                });
            }

            // Populate pending overtime container
            const overtimeContainer = document.getElementById('pending-overtime-container');
            overtimeContainer.innerHTML = '';

            if (pendingOvertime.length === 0) {
                overtimeContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No pending overtime requests</p>';
            } else {
                pendingOvertime.forEach(overtime => {
                    overtimeContainer.innerHTML += `
                        <div class="p-4 border rounded-lg">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <p class="font-medium">${overtime.employeeName}</p>
                                    <p class="text-sm text-gray-600">Overtime Request</p>
                                    <p class="text-sm text-gray-500">${formatDate(overtime.date)}: ${overtime.startTime} - ${overtime.endTime} (${overtime.hours} hours)</p>
                                    <p class="text-xs text-gray-500 mt-1">Reason: ${overtime.reason}</p>
                                </div>
                                <span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">Pending</span>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="approveOvertimeRecordFromManager(${overtime.id})" class="flex-1 bg-green-600 hover:bg-green-700 text-white text-sm font-medium py-2 px-3 rounded">
                                    <i class="fas fa-check mr-1"></i> Approve
                                </button>
                                <button onclick="rejectOvertimeRecordFromManager(${overtime.id})" class="flex-1 bg-red-600 hover:bg-red-700 text-white text-sm font-medium py-2 px-3 rounded">
                                    <i class="fas fa-times mr-1"></i> Reject
                                </button>
                            </div>
                        </div>
                    `;
                });
            }
        }

        // --- Manager Approval Functions ---
        async function approveLeaveRecordFromManager(leaveId) {
            try {
                // Update status in Supabase
                const { data, error } = await dbHelpers.updateLeaveStatus(leaveId, 'Approved');
                if (error) {
                    console.error('Error approving leave in Supabase:', error);
                    showMessage(`Error approving leave: ${error.message}`, 'error');
                    return;
                }

                console.log('Leave approved in Supabase:', data);

                // Update local array
                const leaveIndex = leaveRecords.findIndex(record => record.id == leaveId);
                if (leaveIndex !== -1) {
                    leaveRecords[leaveIndex].status = 'Approved';

                    // Note: We don't update employee table balance anymore
                    // Balance is calculated dynamically based on approved leave records
                    if (leaveRecords[leaveIndex].type === 'Annual Leave' || leaveRecords[leaveIndex].type === 'annual') {
                        console.log('Annual leave approved by manager - balance calculation is dynamic');
                    }

                    // Show success message
                    showMessage(`Leave request for ${leaveRecords[leaveIndex].employeeName} has been approved.`);
                }

                // Refresh the manager dashboard
                populatePendingApprovals();

                // Update My Requests view if the employee is currently logged in
                if (currentUserRole === 'employee' || currentUserRole === 'manager') {
                    populateMyRequests();
                }
            } catch (error) {
                console.error('Error in approveLeaveRecordFromManager:', error);
                showMessage(`Error approving leave: ${error.message}`, 'error');
            }
        }

        async function rejectLeaveRecordFromManager(leaveId) {
            try {
                // Update status in Supabase
                const { data, error } = await dbHelpers.updateLeaveStatus(leaveId, 'Rejected');
                if (error) {
                    console.error('Error rejecting leave in Supabase:', error);
                    showMessage(`Error rejecting leave: ${error.message}`, 'error');
                    return;
                }

                console.log('Leave rejected in Supabase:', data);

                // Update local array
                const leaveIndex = leaveRecords.findIndex(record => record.id == leaveId);
                if (leaveIndex !== -1) {
                    leaveRecords[leaveIndex].status = 'Rejected';

                    // Show success message
                    showMessage(`Leave request for ${leaveRecords[leaveIndex].employeeName} has been rejected.`);
                }

                // Refresh the manager dashboard
                populatePendingApprovals();

                // Update My Requests view if the employee is currently logged in
                if (currentUserRole === 'employee' || currentUserRole === 'manager') {
                    populateMyRequests();
                }
            } catch (error) {
                console.error('Error in rejectLeaveRecordFromManager:', error);
                showMessage(`Error rejecting leave: ${error.message}`, 'error');
            }
        }

        async function approveExcuseRecordFromManager(excuseId) {
            try {
                // Update status in Supabase
                const { data, error } = await dbHelpers.updateExcuseStatus(excuseId, 'Approved');
                if (error) {
                    console.error('Error approving excuse in Supabase:', error);
                    showMessage(`Error approving excuse: ${error.message}`, 'error');
                    return;
                }

                console.log('Excuse approved in Supabase:', data);

                // Update local array
                const excuseIndex = excuseRecords.findIndex(record => record.id == excuseId);
                if (excuseIndex !== -1) {
                    excuseRecords[excuseIndex].status = 'Approved';

                    // Show success message
                    showMessage(`Excuse request for ${excuseRecords[excuseIndex].employeeName} has been approved.`);
                }

                // Refresh the manager dashboard
                populatePendingApprovals();

                // Update My Requests view if the employee is currently logged in
                if (currentUserRole === 'employee' || currentUserRole === 'manager') {
                    populateMyRequests();
                }
            } catch (error) {
                console.error('Error in approveExcuseRecordFromManager:', error);
                showMessage(`Error approving excuse: ${error.message}`, 'error');
            }
        }

        async function rejectExcuseRecordFromManager(excuseId) {
            try {
                // Update status in Supabase
                const { data, error } = await dbHelpers.updateExcuseStatus(excuseId, 'Rejected');
                if (error) {
                    console.error('Error rejecting excuse in Supabase:', error);
                    showMessage(`Error rejecting excuse: ${error.message}`, 'error');
                    return;
                }

                console.log('Excuse rejected in Supabase:', data);

                // Update local array
                const excuseIndex = excuseRecords.findIndex(record => record.id == excuseId);
                if (excuseIndex !== -1) {
                    excuseRecords[excuseIndex].status = 'Rejected';

                    // Show success message
                    showMessage(`Excuse request for ${excuseRecords[excuseIndex].employeeName} has been rejected.`);
                }

                // Refresh the manager dashboard
                populatePendingApprovals();

                // Update My Requests view if the employee is currently logged in
                if (currentUserRole === 'employee' || currentUserRole === 'manager') {
                    populateMyRequests();
                }
            } catch (error) {
                console.error('Error in rejectExcuseRecordFromManager:', error);
                showMessage(`Error rejecting excuse: ${error.message}`, 'error');
            }
        }

        async function approveOvertimeRecordFromManager(overtimeId) {
            try {
                // Update status in Supabase
                const { data, error } = await dbHelpers.updateOvertimeStatus(overtimeId, 'Approved');
                if (error) {
                    console.error('Error approving overtime in Supabase:', error);
                    showMessage(`Error approving overtime: ${error.message}`, 'error');
                    return;
                }

                console.log('Overtime approved in Supabase:', data);

                // Update local array
                const overtimeIndex = overtimeRecords.findIndex(record => record.id == overtimeId);
                if (overtimeIndex !== -1) {
                    overtimeRecords[overtimeIndex].status = 'Approved';

                    // Show success message
                    showMessage(`Overtime request for ${overtimeRecords[overtimeIndex].employeeName} has been approved.`);
                }

                // Refresh the manager dashboard
                populatePendingApprovals();

                // Update My Requests view if the employee is currently logged in
                if (currentUserRole === 'employee' || currentUserRole === 'manager') {
                    populateMyRequests();
                }
            } catch (error) {
                console.error('Error in approveOvertimeRecordFromManager:', error);
                showMessage(`Error approving overtime: ${error.message}`, 'error');
            }
        }

        async function rejectOvertimeRecordFromManager(overtimeId) {
            try {
                // Update status in Supabase
                const { data, error } = await dbHelpers.updateOvertimeStatus(overtimeId, 'Rejected');
                if (error) {
                    console.error('Error rejecting overtime in Supabase:', error);
                    showMessage(`Error rejecting overtime: ${error.message}`, 'error');
                    return;
                }

                console.log('Overtime rejected in Supabase:', data);

                // Update local array
                const overtimeIndex = overtimeRecords.findIndex(record => record.id == overtimeId);
                if (overtimeIndex !== -1) {
                    overtimeRecords[overtimeIndex].status = 'Rejected';

                    // Show success message
                    showMessage(`Overtime request for ${overtimeRecords[overtimeIndex].employeeName} has been rejected.`);
                }

                // Refresh the manager dashboard
                populatePendingApprovals();

                // Update My Requests view if the employee is currently logged in
                if (currentUserRole === 'employee' || currentUserRole === 'manager') {
                    populateMyRequests();
                }
            } catch (error) {
                console.error('Error in rejectOvertimeRecordFromManager:', error);
                showMessage(`Error rejecting overtime: ${error.message}`, 'error');
            }
        }

        // --- Switch Approval Tab ---
        function switchApprovalTab(tabId) {
            // Hide all tab contents
            document.querySelectorAll('.approval-tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            // Show selected tab content
            document.getElementById(`${tabId}-content`).classList.remove('hidden');

            // Update tab button styles
            document.querySelectorAll('[id^="tab-pending-"]').forEach(tab => {
                tab.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                tab.classList.add('text-gray-500', 'hover:text-gray-700');
            });

            document.getElementById(`tab-${tabId}`).classList.remove('text-gray-500', 'hover:text-gray-700');
            document.getElementById(`tab-${tabId}`).classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
        }

        // --- Setup Request Button Listeners ---
        function setupRequestButtonListeners() {
            // New leave request button
            document.getElementById('new-leave-request-btn').addEventListener('click', function() {
                showSection('leaves');
                document.getElementById('leave-form-container').classList.remove('hidden');

                // Pre-fill employee code if employee is logged in
                if (currentUserData) {
                    document.getElementById('leave-employee-code').value = currentUserData.id;
                    // Trigger the input event to populate employee name
                    const event = new Event('input', { bubbles: true });
                    document.getElementById('leave-employee-code').dispatchEvent(event);
                }
            });

            // New excuse request button
            document.getElementById('new-excuse-request-btn').addEventListener('click', function() {
                showSection('excuses');
                document.getElementById('excuse-form-container').classList.remove('hidden');

                // Pre-fill employee code if employee is logged in
                if (currentUserData) {
                    document.getElementById('excuse-employee-code').value = currentUserData.id;
                    // Trigger the input event to populate employee name
                    const event = new Event('input', { bubbles: true });
                    document.getElementById('excuse-employee-code').dispatchEvent(event);
                }
            });

            // New overtime request button
            document.getElementById('new-overtime-request-btn').addEventListener('click', function() {
                showSection('overtime');
                document.getElementById('overtime-form-container').classList.remove('hidden');

                // Pre-fill employee code if employee is logged in
                if (currentUserData) {
                    document.getElementById('overtime-employee-code').value = currentUserData.id;
                    // Trigger the input event to populate employee name
                    const event = new Event('input', { bubbles: true });
                    document.getElementById('overtime-employee-code').dispatchEvent(event);
                }
            });
        }

        // --- Navigation ---
        function showSection(sectionId) {
            document.querySelectorAll('#app-container main section').forEach(section => {
                section.classList.add('hidden');
            });
            const sectionToShow = document.getElementById(sectionId);
            if (sectionToShow) {
                 sectionToShow.classList.remove('hidden');
            }

            document.querySelectorAll('.sidebar-link').forEach(link => link.classList.remove('active'));
            const activeLink = document.getElementById(`nav-${sectionId}`);
             if(activeLink) {
                activeLink.classList.add('active');
             }

            // Re-initialize charts only if switching TO the dashboard
            if (sectionId === 'dashboard') {
                updateDashboard(); // Update dashboard with current filter state
            }

            // Update manager dashboard if switching to it
            if (sectionId === 'manager-dashboard' && currentUserRole === 'manager') {
                initializeManagerDashboard();
            }

            // Update my requests if switching to it
            if (sectionId === 'my-requests' && (currentUserRole === 'employee' || currentUserRole === 'manager')) {
                populateMyRequests();
            }
        }

        // Function to reset dashboard filters
        function resetDashboardFilters() {
            // Reset all filter dropdowns to default values
            document.getElementById('dept-filter-dash').value = 'all';
            document.getElementById('pos-filter-dash').value = 'all';
            document.getElementById('status-filter-dash').value = 'all';

            // Update dashboard with all data
            updateDashboard();
        }

        // Handle dashboard filter button click
        function handleDashboardFilter(button) {
            // Toggle the button color and check if we need to reset
            const wasActive = toggleFilterButtonColor(button, resetDashboardFilters);

            // Only apply filters if we're not resetting
            if (!wasActive) {
                updateDashboard();
            }
        }

        // --- Dashboard Update Logic (Handles Filters) ---
        function updateDashboard() {
            const selectedDept = document.getElementById('dept-filter-dash').value;
            const selectedPos = document.getElementById('pos-filter-dash').value;
            const selectedStatus = document.getElementById('status-filter-dash').value;

            // Remove onchange event handlers from the filter selects
            // This prevents the dashboard from updating automatically when a filter is changed
            document.getElementById('dept-filter-dash').removeAttribute('onchange');
            document.getElementById('pos-filter-dash').removeAttribute('onchange');
            document.getElementById('status-filter-dash').removeAttribute('onchange');

            // Filter employees based on dashboard selections
            const filteredEmployees = employees.filter(emp => {
                const matchesDept = selectedDept === 'all' || emp.department === selectedDept;
                const matchesPos = selectedPos === 'all' || emp.position === selectedPos;
                const matchesStatus = selectedStatus === 'all' || emp.status === selectedStatus;
                return matchesDept && matchesPos && matchesStatus;
            });

            // Update stats and charts with the filtered data
            updateDashboardStats(filteredEmployees);
            initializeDashboardCharts(filteredEmployees);
        }


        // --- Dashboard Stats and Charts ---
        function updateDashboardStats(currentEmployees = employees) { // Accepts filtered list
            const totalEmployees = currentEmployees.length;
            const activeEmployees = currentEmployees.filter(e => e.status === 'Active').length;
            const inactiveEmployees = totalEmployees - activeEmployees;
            // Calculate turnover based ONLY on the currently filtered subset's inactive members
            // Handle both field name formats for resign date
            const resignations = currentEmployees.filter(e => {
                const resignDate = e.resignDate || e.resign_date;
                return e.status === 'Inactive' && resignDate;
            }).length;
            const turnoverRate = totalEmployees > 0 ? ((resignations / totalEmployees) * 100).toFixed(1) : 0;

            // Calculate average leaves based on the departments PRESENT in the filtered list
            const currentDepartments = [...new Set(currentEmployees.map(e => e.department))];
            const leavesByDept = {};
            currentDepartments.forEach(dept => leavesByDept[dept] = { totalLeaves: 0, employeeCount: 0 });

            // Count leaves ONLY for employees in the filtered list
            leaveRecords.forEach(lr => {
                 const emp = currentEmployees.find(e => e.id === lr.employeeId); // Check against filtered list
                 if(emp && emp.department && leavesByDept[emp.department]){
                     leavesByDept[emp.department].totalLeaves += lr.days;
                 }
            });
             // Count employees per dept ONLY from the filtered list
             currentEmployees.forEach(emp => {
                 if(emp.department && leavesByDept[emp.department]){
                    leavesByDept[emp.department].employeeCount++;
                 }
             });

            let totalAvgLeaves = 0;
            let deptsWithLeaves = 0;
             Object.values(leavesByDept).forEach(deptData => {
                 if(deptData.employeeCount > 0){
                     const avg = deptData.totalLeaves / deptData.employeeCount;
                     totalAvgLeaves += avg;
                     deptsWithLeaves++;
                 }
             });
            const avgLeaves = deptsWithLeaves > 0 ? (totalAvgLeaves / deptsWithLeaves).toFixed(1) : 0;

            document.getElementById('stat-total-employees').textContent = totalEmployees;
            document.getElementById('stat-active-employees').textContent = activeEmployees;
            document.getElementById('stat-avg-leaves').textContent = avgLeaves;
            document.getElementById('stat-turnover').textContent = `${turnoverRate}%`;

            // Debug logging
            console.log('Dashboard Stats Updated:', {
                totalEmployees,
                activeEmployees,
                resignations,
                turnoverRate: `${turnoverRate}%`,
                avgLeaves
            });
        }

        function initializeDashboardCharts(currentEmployees = employees) { // Accepts filtered list
            const ctxDept = document.getElementById('deptChart')?.getContext('2d');
            const ctxLevel = document.getElementById('levelChart')?.getContext('2d');
            const ctxHiring = document.getElementById('hiringChart')?.getContext('2d');
            const ctxLeavesDept = document.getElementById('leavesDeptChart')?.getContext('2d');
            const ctxGender = document.getElementById('genderChart')?.getContext('2d');
            const ctxAge = document.getElementById('ageChart')?.getContext('2d');
            const ctxMonthlyHiring = document.getElementById('monthlyHiringChart')?.getContext('2d');

            if (!ctxDept || !ctxLevel || !ctxHiring || !ctxLeavesDept || !ctxGender || !ctxAge || !ctxMonthlyHiring) return;

            // --- Data processing based on currentEmployees ---
            const currentDepartments = [...new Set(currentEmployees.map(e => e.department))].sort();

            const deptCounts = currentDepartments.reduce((acc, dept) => {
                acc[dept] = currentEmployees.filter(e => e.department === dept).length;
                return acc;
            }, {});

            const levelCounts = currentEmployees.reduce((acc, emp) => {
                acc[emp.level] = (acc[emp.level] || 0) + 1;
                return acc;
            }, { 'Manager': 0, 'Non-manager': 0 });

             const genderCounts = currentEmployees.reduce((acc, emp) => { // Calculate gender counts
                acc[emp.gender] = (acc[emp.gender] || 0) + 1;
                return acc;
            }, { 'Male': 0, 'Female': 0 }); // Initialize to show labels even if count is 0

            const hiringTrends = currentEmployees.reduce((acc, emp) => {
                 // Handle both field name formats
                 const hiringDate = emp.hiringDate || emp.hiring_date;
                 if (hiringDate) {
                    const year = new Date(hiringDate).getFullYear();
                    acc[year] = (acc[year] || 0) + 1;
                 }
                return acc;
            }, {});
            const sortedYears = Object.keys(hiringTrends).sort((a, b) => a - b);
            const hiringData = sortedYears.map(year => hiringTrends[year]);

            // Add resign trends for the hiring vs resigns chart
            const resignTrends = currentEmployees.reduce((acc, emp) => {
                const resignDate = emp.resignDate || emp.resign_date;
                if (resignDate) {
                    const year = new Date(resignDate).getFullYear();
                    acc[year] = (acc[year] || 0) + 1;
                }
                return acc;
            }, {});

            // Combine years from both hiring and resigning
            const allYears = [...new Set([...Object.keys(hiringTrends), ...Object.keys(resignTrends)])].sort((a, b) => a - b);
            const combinedHiringData = allYears.map(year => hiringTrends[year] || 0);
            const combinedResignData = allYears.map(year => resignTrends[year] || 0);

            const leavesPerDept = currentDepartments.reduce((acc, dept) => { // Use currentDepartments
                acc[dept] = leaveRecords
                    .filter(lr => currentEmployees.find(e => e.id === lr.employeeId && e.department === dept)) // Filter leaves based on currentEmployees
                    .reduce((sum, lr) => sum + lr.days, 0);
                return acc;
            }, {});

            // --- Destroy existing charts ---
            if (deptChartInstance) deptChartInstance.destroy();
            if (levelChartInstance) levelChartInstance.destroy();
            if (hiringChartInstance) hiringChartInstance.destroy();
            if (leavesDeptChartInstance) leavesDeptChartInstance.destroy();
            if (genderChartInstance) genderChartInstance.destroy();
            if (ageChartInstance) ageChartInstance.destroy();
            if (monthlyHiringChartInstance) monthlyHiringChartInstance.destroy();

            // --- Create new charts ---
            const chartOptions = {
                 responsive: true,
                 maintainAspectRatio: false, // Allow chart to fill container height
                 scales: { y: { beginAtZero: true } } // Default Y-axis options
            };
            const pieChartOptions = { responsive: true, maintainAspectRatio: false };


            deptChartInstance = new Chart(ctxDept, {
                type: 'bar',
                data: { labels: Object.keys(deptCounts), datasets: [{ label: '# of Employees', data: Object.values(deptCounts), backgroundColor: 'rgba(59, 130, 246, 0.7)', borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 1, borderRadius: 5 }] },
                options: { ...chartOptions, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } } // Integer steps for employee counts
            });

            levelChartInstance = new Chart(ctxLevel, {
                type: 'pie',
                data: { labels: Object.keys(levelCounts), datasets: [{ label: 'Employee Levels', data: Object.values(levelCounts), backgroundColor: ['rgba(16, 185, 129, 0.7)', 'rgba(245, 158, 11, 0.7)'], borderColor: ['rgba(16, 185, 129, 1)', 'rgba(245, 158, 11, 1)'], borderWidth: 1 }] },
                 options: pieChartOptions
            });

             // New Gender Chart
             genderChartInstance = new Chart(ctxGender, {
                type: 'pie', // Or 'doughnut'
                data: {
                    labels: Object.keys(genderCounts),
                    datasets: [{
                        label: 'Gender Distribution',
                        data: Object.values(genderCounts),
                        backgroundColor: ['rgba(59, 130, 246, 0.7)', 'rgba(236, 72, 153, 0.7)'], // Blue, Pink
                        borderColor: ['rgba(59, 130, 246, 1)', 'rgba(236, 72, 153, 1)'],
                        borderWidth: 1
                    }]
                },
                options: pieChartOptions
            });

            hiringChartInstance = new Chart(ctxHiring, {
                type: 'line',
                data: {
                    labels: allYears,
                    datasets: [
                        {
                            label: 'New Hires per Year',
                            data: combinedHiringData,
                            fill: false,
                            borderColor: 'rgb(16, 185, 129)',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.1
                        },
                        {
                            label: 'Resignations per Year',
                            data: combinedResignData,
                            fill: false,
                            borderColor: 'rgb(239, 68, 68)',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.1
                        }
                    ]
                },
                options: { ...chartOptions, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } } // Integer steps for hire counts
            });

             leavesDeptChartInstance = new Chart(ctxLeavesDept, {
                type: 'bar',
                data: { labels: Object.keys(leavesPerDept), datasets: [{ label: 'Total Leave Days', data: Object.values(leavesPerDept), backgroundColor: 'rgba(239, 68, 68, 0.7)', borderColor: 'rgba(239, 68, 68, 1)', borderWidth: 1, borderRadius: 5 }] },
                options: chartOptions
            });

            // Age Distribution Chart (Doughnut)
            // Calculate age from DOB
            function calculateAge(dob) {
                const birthDate = new Date(dob);
                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                return age;
            }

            // Define age segments
            const ageSegments = {
                'Below 20': 0,
                '20-25': 0,
                '25-30': 0,
                '30-35': 0,
                '35-40': 0,
                '40-45': 0,
                '45-50': 0,
                'Above 50': 0
            };

            // Count employees in each age segment
            currentEmployees.forEach(emp => {
                if (emp.dob) {
                    const age = calculateAge(emp.dob);
                    if (age < 20) ageSegments['Below 20']++;
                    else if (age >= 20 && age < 25) ageSegments['20-25']++;
                    else if (age >= 25 && age < 30) ageSegments['25-30']++;
                    else if (age >= 30 && age < 35) ageSegments['30-35']++;
                    else if (age >= 35 && age < 40) ageSegments['35-40']++;
                    else if (age >= 40 && age < 45) ageSegments['40-45']++;
                    else if (age >= 45 && age < 50) ageSegments['45-50']++;
                    else ageSegments['Above 50']++;
                }
            });

            // Create age distribution chart
            ageChartInstance = new Chart(ctxAge, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(ageSegments),
                    datasets: [{
                        label: 'Age Distribution',
                        data: Object.values(ageSegments),
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(153, 102, 255, 0.7)',
                            'rgba(255, 159, 64, 0.7)',
                            'rgba(199, 199, 199, 0.7)',
                            'rgba(83, 102, 255, 0.7)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)',
                            'rgba(199, 199, 199, 1)',
                            'rgba(83, 102, 255, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 15,
                                padding: 15
                            }
                        },
                        title: {
                            display: true,
                            text: 'Employee Age Distribution',
                            font: {
                                size: 16
                            }
                        }
                    }
                }
            });

            // Monthly Hiring vs Resigns Chart (Year to Date)
            const currentYear = new Date().getFullYear();
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            const currentMonth = new Date().getMonth(); // 0-11

            // Initialize monthly data arrays
            const hiresPerMonth = Array(12).fill(0);
            const resignsPerMonth = Array(12).fill(0);

            // Count hires and resigns per month for current year
            currentEmployees.forEach(emp => {
                // Handle both field name formats for hiring date
                const hiringDate = emp.hiringDate || emp.hiring_date;
                if (hiringDate) {
                    const hireDate = new Date(hiringDate);
                    if (hireDate.getFullYear() === currentYear) {
                        hiresPerMonth[hireDate.getMonth()]++;
                    }
                }

                // Handle both field name formats for resign date
                const resignDate = emp.resignDate || emp.resign_date;
                if (resignDate) {
                    const resignDateObj = new Date(resignDate);
                    if (resignDateObj.getFullYear() === currentYear) {
                        resignsPerMonth[resignDateObj.getMonth()]++;
                    }
                }
            });

            // Only include months up to the current month (YTD)
            const ytdMonthNames = monthNames.slice(0, currentMonth + 1);
            const ytdHiresData = hiresPerMonth.slice(0, currentMonth + 1);
            const ytdResignsData = resignsPerMonth.slice(0, currentMonth + 1);

            // Debug logging for charts
            console.log('Chart Data Debug:', {
                currentYear,
                currentMonth,
                hiringTrends,
                resignTrends,
                ytdHiresData,
                ytdResignsData,
                allYears,
                combinedHiringData,
                combinedResignData
            });

            // Create monthly hiring vs resigns chart
            monthlyHiringChartInstance = new Chart(ctxMonthlyHiring, {
                type: 'bar',
                data: {
                    labels: ytdMonthNames,
                    datasets: [
                        {
                            label: 'Hires',
                            data: ytdHiresData,
                            backgroundColor: 'rgba(16, 185, 129, 0.7)', // Green
                            borderColor: 'rgba(16, 185, 129, 1)',
                            borderWidth: 1,
                            borderRadius: 5
                        },
                        {
                            label: 'Resigns',
                            data: ytdResignsData,
                            backgroundColor: 'rgba(239, 68, 68, 0.7)', // Red
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 1,
                            borderRadius: 5
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            },
                            title: {
                                display: true,
                                text: 'Number of Employees'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: `Months (${currentYear})`
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `Year-to-Date Hires vs Resigns (${currentYear})`,
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                footer: (tooltipItems) => {
                                    const index = tooltipItems[0].dataIndex;
                                    const hires = ytdHiresData[index];
                                    const resigns = ytdResignsData[index];
                                    const netChange = hires - resigns;
                                    return `Net Change: ${netChange > 0 ? '+' : ''}${netChange}`;
                                }
                            }
                        }
                    }
                }
            });
        }


        // --- Employee Database ---
        function populateEmployeeTable(filteredEmployees = employees) {
            const tableBody = document.getElementById('employeeTableBody');
             if (!tableBody) return;
            tableBody.innerHTML = '';

            if (filteredEmployees.length === 0) {
                // Updated colspan to 18
                tableBody.innerHTML = '<tr><td colspan="18" class="text-center py-4 text-gray-500">No employees found matching criteria.</td></tr>';
                return;
            }

            filteredEmployees.forEach(emp => {
                // Handle field name compatibility
                const fullName = emp.fullName || emp.full_name || 'Unknown';
                const hiringDate = emp.hiringDate || emp.hiring_date;
                const idNumber = emp.idNumber || emp.id_number;
                const socialInsurance = emp.socialInsurance || emp.social_insurance;
                const militaryStatus = emp.militaryStatus || emp.military_status;
                const directManager = emp.directManager || emp.direct_manager;
                const maritalStatus = emp.maritalStatus || emp.marital_status;
                const gradYear = emp.gradYear || emp.grad_year;
                const resignDate = emp.resignDate || emp.resign_date;
                const annualLeaveBalance = emp.annualLeaveBalance || emp.annual_leave_balance;

                const row = `
                    <tr class="hover:bg-gray-50 transition duration-150">
                        <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${emp.id}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">
                            <a href="#" onclick="openEmployeeCardModal('${emp.id}'); return false;" class="text-indigo-600 hover:text-indigo-900 hover:underline font-medium">
                                ${fullName}
                            </a>
                        </td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${emp.gender || 'N/A'}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${formatDate(hiringDate)}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${emp.position}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${emp.department}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${formatDate(emp.dob)}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${emp.phone || 'N/A'}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${emp.email || 'N/A'}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${emp.address || 'N/A'}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${idNumber}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${socialInsurance || 'N/A'}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${emp.status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${emp.status}
                            </span>
                        </td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${militaryStatus || 'N/A'}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${emp.level}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${directManager || 'N/A'}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${resignDate ? formatDate(resignDate) : 'N/A'}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${maritalStatus || 'N/A'}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${emp.faculty || 'N/A'}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${gradYear || 'N/A'}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${annualLeaveBalance || '0'}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm font-medium space-x-2">
                            <button onclick="openEditEmployeeModal('${emp.id}')" class="text-indigo-600 hover:text-indigo-900" title="Edit"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteEmployee('${emp.id}')" class="text-red-600 hover:text-red-900" title="Delete"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }

        // Function to reset employee filters
        function resetEmployeeFilters() {
            // Reset all filter inputs to default values
            document.getElementById('search-db').value = '';
            document.getElementById('dept-filter-db').value = 'all';
            document.getElementById('status-filter-db').value = 'all';

            // Repopulate the table with all employees
            populateEmployeeTable();
        }

        // Handle employee filter button click
        function handleEmployeeFilter(button) {
            // Toggle the button color and check if we need to reset
            const wasActive = toggleFilterButtonColor(button, resetEmployeeFilters);

            // Only apply filters if we're not resetting
            if (!wasActive) {
                filterEmployeeTable();
            }
        }

        function filterEmployeeTable() {
            const searchTerm = document.getElementById('search-db').value.toLowerCase();
            const selectedDept = document.getElementById('dept-filter-db').value;
            const selectedStatus = document.getElementById('status-filter-db').value;

            const filtered = employees.filter(emp => {
                const fullName = emp.fullName || emp.full_name || '';
                const nameMatch = fullName.toLowerCase().includes(searchTerm);
                const codeMatch = emp.id.toLowerCase().includes(searchTerm);
                const posMatch = emp.position.toLowerCase().includes(searchTerm);
                const matchesSearch = searchTerm === '' || nameMatch || codeMatch || posMatch;

                const matchesDept = selectedDept === 'all' || emp.department === selectedDept;
                const matchesStatus = selectedStatus === 'all' || emp.status === selectedStatus;
                return matchesSearch && matchesDept && matchesStatus;
            });
            populateEmployeeTable(filtered);
        }

        function exportTableToExcel(tableID, filename = ''){
            const table = document.getElementById(tableID);
            if (!table) {
                 showMessage('Error: Could not find table to export.', 'error'); return;
            }
            // Clone table to exclude the 'Actions' column before export
            const tableClone = table.cloneNode(true);
            // Remove the last cell (Actions) from each row in the cloned table body
            const rows = tableClone.querySelectorAll('tbody tr');
            rows.forEach(row => {
                if (row.cells.length > 0) {
                     row.deleteCell(-1); // Delete the last cell
                }
            });
             // Remove the last header cell (Actions) from the cloned table head
             const headerRow = tableClone.querySelector('thead tr');
             if (headerRow && headerRow.cells.length > 0) {
                 headerRow.deleteCell(-1); // Delete the last header cell
             }


            const wb = XLSX.utils.table_to_book(tableClone, {sheet:"Employee Data"});
            filename = filename ? filename + '.xlsx' : 'employee_data.xlsx';
            XLSX.writeFile(wb, filename);
             showMessage('Table exported to Excel successfully!');
        }

        // Function to toggle filter button color and reset filters if needed
        function toggleFilterButtonColor(button, resetFunction) {
            // Check if the button is already active (red)
            const isActive = button.classList.contains('bg-red-600');

            if (isActive) {
                // If active, revert to original color
                button.classList.remove('bg-red-600', 'hover:bg-red-700');
                button.classList.add('bg-indigo-600', 'hover:bg-indigo-700');

                // Reset all filters if a reset function was provided
                if (typeof resetFunction === 'function') {
                    resetFunction();
                }
            } else {
                // If not active, change to red
                button.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                button.classList.add('bg-red-600', 'hover:bg-red-700');
            }

            return isActive; // Return whether it was active (so we know if we're resetting)
        }

        // Function to update leave summary based on filters
        function updateLeaveSummary(employeeId = 'all', month = 'all') {
            console.log('DEBUGGING LEAVE SUMMARY:');
            console.log('Employee ID:', employeeId);
            console.log('Month:', month);
            console.log('All leave records:', leaveRecords);

            const totalLeaveDaysElement = document.getElementById('total-leave-days');
            const remainingLeaveBalanceElement = document.getElementById('remaining-leave-balance');
            const usedLeavePercentageElement = document.getElementById('used-leave-percentage');

            if (!totalLeaveDaysElement || !remainingLeaveBalanceElement || !usedLeavePercentageElement) {
                console.error('Summary elements not found!');
                return;
            }

            // Get current year
            const currentYear = new Date().getFullYear();
            console.log('Current Year:', currentYear);

            // DIRECT CALCULATION: Get the filtered records based on the current filters
            let filteredRecords = [...leaveRecords];
            console.log('Initial records count:', filteredRecords.length);

            // Apply employee filter
            if (employeeId !== 'all') {
                console.log('Filtering for employee:', employeeId);
                filteredRecords = filteredRecords.filter(record => record.employeeId === employeeId);
                console.log('After employee filter, records count:', filteredRecords.length);
                console.log('Filtered records for employee:', filteredRecords);
            }

            // Apply month filter
            if (month !== 'all') {
                const monthNum = parseInt(month);
                console.log('Filtering for month:', monthNum);
                filteredRecords = filteredRecords.filter(record => {
                    const startDate = new Date(record.startDate);
                    const recordMonth = startDate.getMonth() + 1;
                    console.log(`Record ${record.id} date: ${record.startDate}, month: ${recordMonth}`);
                    return recordMonth === monthNum;
                });
                console.log('After month filter, records count:', filteredRecords.length);
            }

            // Filter for current year only
            console.log('Filtering for year:', currentYear);
            filteredRecords = filteredRecords.filter(record => {
                const startDate = new Date(record.startDate);
                const recordYear = startDate.getFullYear();
                console.log(`Record ${record.id} date: ${record.startDate}, year: ${recordYear}`);
                // Include only current year
                return recordYear === currentYear;
            });
            console.log('After year filter, records count:', filteredRecords.length);
            console.log('Final filtered records:', filteredRecords);

            // Calculate total leave days from filtered records (include ALL types, not just annual leave)
            // Only exclude rejected records
            let totalLeaveDays = 0;

            // Log all records to see what we're working with
            console.log('ALL FILTERED RECORDS:');
            filteredRecords.forEach(record => {
                console.log(`Record ID: ${record.id}, Type: ${record.type}, Status: ${record.status}, Days: ${record.days}`);
            });

            // Calculate total leave days including ALL types (annual, casual, sick, etc.)
            // IMPORTANT: Include ALL leave types, regardless of type
            filteredRecords.forEach(record => {
                if (record.status !== 'Rejected') {
                    const parsedDays = parseFloat(record.days || 0);
                    console.log(`Adding ${parsedDays} days from record ${record.id} (${record.type})`);
                    totalLeaveDays += parsedDays;
                } else {
                    console.log(`Skipping rejected record ${record.id} (${record.type})`);
                }
            });
            console.log('Calculated Total Leave Days (ALL types):', totalLeaveDays);

            // Calculate remaining leave balance
            let remainingLeaveBalance = 0;

            if (employeeId !== 'all') {
                // For a specific employee - calculate dynamically
                const employee = employees.find(e => e.id === employeeId);
                if (employee) {
                    remainingLeaveBalance = calculateRemainingLeaveBalance(employeeId);
                    console.log('Employee found:', employee.fullName || employee.full_name);
                    console.log('Employee calculated remaining balance:', remainingLeaveBalance);
                } else {
                    console.error('Employee not found for ID:', employeeId);
                }
            } else {
                // For all employees - calculate dynamically for each
                let relevantEmployees = [...employees].filter(e => e.status === 'Active');
                console.log('Active employees count:', relevantEmployees.length);
                relevantEmployees.forEach(employee => {
                    const empRemainingBalance = calculateRemainingLeaveBalance(employee.id);
                    remainingLeaveBalance += empRemainingBalance;
                    console.log(`Adding ${empRemainingBalance} remaining from ${employee.fullName || employee.full_name}`);
                });
                console.log('Total remaining balance for all employees:', remainingLeaveBalance);
            }

            // Calculate annual leave days only (for balance calculation)
            // NOTE: This is ONLY for the balance calculation, not for the total leave days
            let annualLeaveDays = 0;
            filteredRecords.forEach(record => {
                if (record.status !== 'Rejected') {
                    // Only include annual leave types for balance calculation
                    const leaveType = record.type.toLowerCase();
                    if (leaveType.includes('annual')) {
                        const parsedDays = parseFloat(record.days || 0);
                        console.log(`Adding ${parsedDays} ANNUAL days from record ${record.id} (${record.type})`);
                        annualLeaveDays += parsedDays;
                    }
                }
            });
            console.log('Annual Leave Days (for balance calculation):', annualLeaveDays);

            // Calculate total annual allowance and used percentage
            // Only use annual leave days for this calculation
            const totalAnnualAllowance = remainingLeaveBalance + annualLeaveDays;
            const usedPercentage = totalAnnualAllowance > 0 ? Math.round((annualLeaveDays / totalAnnualAllowance) * 100) : 0;
            console.log('Total Annual Allowance:', totalAnnualAllowance);
            console.log('Used Percentage:', usedPercentage);

            // Update the UI
            totalLeaveDaysElement.textContent = totalLeaveDays.toFixed(1);
            remainingLeaveBalanceElement.textContent = remainingLeaveBalance.toFixed(1);
            usedLeavePercentageElement.textContent = `${usedPercentage}%`;

            console.log('UI Updated with:');
            console.log('- Total Leave Days:', totalLeaveDays.toFixed(1));
            console.log('- Remaining Balance:', remainingLeaveBalance.toFixed(1));
            console.log('- Used Percentage:', `${usedPercentage}%`);
        }

        // Populates dropdowns in DB filters and Add/Edit modal
        function populateFilterDropdowns() {
            // Ensure lists are up-to-date
            updateDynamicDataLists();

            const deptFilterDb = document.getElementById('dept-filter-db');
            const managerSelectModal = document.getElementById('directManager');
            const leaveFilterDepartment = document.getElementById('leave-filter-department');

            // Get datalists for department and position
            const departmentList = document.getElementById('departmentList');
            const positionList = document.getElementById('positionList');

            // Clear existing options except 'All'/'Select...'
            deptFilterDb.innerHTML = '<option value="all">All</option>';
            managerSelectModal.innerHTML = '<option value="">Select Manager</option>';

            // No longer need to populate department dropdown for leave filter

            // Clear datalists
            departmentList.innerHTML = '';
            positionList.innerHTML = '';

            // Populate department datalist
            departments.forEach(dept => {
                deptFilterDb.appendChild(new Option(dept, dept));

                // Add to datalist
                const option = document.createElement('option');
                option.value = dept;
                departmentList.appendChild(option);
            });

            // Populate position datalist
            positions.forEach(pos => {
                // Add to datalist
                const option = document.createElement('option');
                option.value = pos;
                positionList.appendChild(option);
            });

            managers.forEach(manager => {
                const managerName = manager.fullName || manager.full_name || 'Unknown';
                // Use the manager's name as both display and value (this is what gets saved to database)
                managerSelectModal.appendChild(new Option(`${managerName} (${manager.id})`, managerName));
            });
        }

        // Populates dropdowns ONLY for the dashboard filters
        function populateDashboardFilterDropdowns() {
             updateDynamicDataLists(); // Ensure lists are fresh

             const deptFilterDash = document.getElementById('dept-filter-dash');
             const posFilterDash = document.getElementById('pos-filter-dash');

             // Clear existing options except 'All'
             deptFilterDash.innerHTML = '<option value="all">All Departments</option>';
             posFilterDash.innerHTML = '<option value="all">All Positions</option>';

             departments.forEach(dept => {
                 deptFilterDash.appendChild(new Option(dept, dept));
             });
             positions.forEach(pos => {
                 posFilterDash.appendChild(new Option(pos, pos));
             });
        }

        // --- Employee Modal (Add/Edit) ---
        function openAddEmployeeModal() {
            console.log('Add Employee button clicked - opening modal');

            document.getElementById('employeeForm').reset();
            document.getElementById('employeeId').value = '';
            document.getElementById('modalTitle').textContent = 'Add New Employee';
            document.getElementById('empCode').readOnly = false;

            // Clear all date dropdowns completely
            clearAllDateDropdowns();

            // Repopulate department dropdown in modal in case it changed
            populateFilterDropdowns();

            // Fix: Reset both CSS class and inline style
            const modal = document.getElementById('employeeModal');
            modal.classList.remove('hidden');
            modal.style.display = 'block';

            setupStatusChangeHandler();
        }

         function openEditEmployeeModal(employeeId) {
            const emp = employees.find(e => e.id === employeeId);
            if (!emp) {
                console.error('Employee not found:', employeeId);
                return;
            }

            console.log('Opening edit modal for employee:', emp);

            // Clear form first
            document.getElementById('employeeForm').reset();

            // Repopulate dropdowns before setting values
            populateFilterDropdowns();

            // Handle field name compatibility (Supabase uses full_name, local uses fullName)
            document.getElementById('employeeId').value = emp.id;
            document.getElementById('modalTitle').textContent = 'Edit Employee';
            document.getElementById('empCode').value = emp.id;
            document.getElementById('empCode').readOnly = true;
            document.getElementById('fullName').value = emp.fullName || emp.full_name || '';
            document.getElementById('gender').value = emp.gender || '';
            document.getElementById('position').value = emp.position || '';
            document.getElementById('department').value = emp.department || '';
            document.getElementById('phone').value = emp.phone || '';
            document.getElementById('email').value = emp.email || '';
            document.getElementById('address').value = emp.address || '';
            document.getElementById('idNumber').value = emp.idNumber || emp.id_number || '';
            document.getElementById('socialInsurance').value = emp.socialInsurance || emp.social_insurance || '';
            document.getElementById('status').value = emp.status || 'Active';
            document.getElementById('militaryStatus').value = emp.militaryStatus || emp.military_status || '';
            document.getElementById('level').value = emp.level || '';
            document.getElementById('directManager').value = emp.directManager || emp.direct_manager || '';
            document.getElementById('maritalStatus').value = emp.maritalStatus || emp.marital_status || '';
            document.getElementById('faculty').value = emp.faculty || '';
            document.getElementById('gradYear').value = emp.gradYear || emp.grad_year || '';
            document.getElementById('leaveBalance').value = emp.annualLeaveBalance || emp.annual_leave_balance || '';

             // Set date dropdowns for editing
             setDateDropdowns('hiring', emp.hiringDate || emp.hiring_date);
             setDateDropdowns('dob', emp.dob || emp.date_of_birth);
             setDateDropdowns('resign', emp.resignDate || emp.resign_date);

            // Fix: Reset both CSS class and inline style
            const modal = document.getElementById('employeeModal');
            modal.classList.remove('hidden');
            modal.style.display = 'block';

            setupStatusChangeHandler();
        }

        function closeEmployeeModal() {
            const modal = document.getElementById('employeeModal');
            modal.classList.add('hidden');
            modal.style.display = 'none';
        }

        // Helper function to clear all date dropdowns
        function clearAllDateDropdowns() {
            const dateTypes = ['hiring', 'dob', 'resign'];
            dateTypes.forEach(type => {
                const daySelect = document.getElementById(`${type}Day`);
                const monthSelect = document.getElementById(`${type}Month`);
                const yearSelect = document.getElementById(`${type}Year`);
                const hiddenInput = document.getElementById(`${type}Date`);

                if (daySelect) {
                    daySelect.value = '';
                    daySelect.selectedIndex = 0;
                }
                if (monthSelect) {
                    monthSelect.value = '';
                    monthSelect.selectedIndex = 0;
                }
                if (yearSelect) {
                    yearSelect.value = '';
                    yearSelect.selectedIndex = 0;
                }
                if (hiddenInput) {
                    hiddenInput.value = '';
                }
            });
            console.log('All date dropdowns cleared completely');
        }

        // Helper function to set date dropdowns from a date string
        function setDateDropdowns(type, dateString) {
            if (!dateString) {
                console.log(`No date provided for ${type}, skipping`);
                return;
            }

            try {
                const date = new Date(dateString);
                const day = date.getDate();
                const month = date.getMonth() + 1; // getMonth() returns 0-11
                const year = date.getFullYear();

                const daySelect = document.getElementById(`${type}Day`);
                const monthSelect = document.getElementById(`${type}Month`);
                const yearSelect = document.getElementById(`${type}Year`);
                const hiddenInput = document.getElementById(`${type}Date`);

                console.log(`Setting ${type} date dropdowns:`, { day, month, year, dateString });

                if (daySelect) {
                    daySelect.value = day;
                    console.log(`Set ${type}Day to:`, day);
                }
                if (monthSelect) {
                    monthSelect.value = month;
                    console.log(`Set ${type}Month to:`, month);
                }
                if (yearSelect) {
                    yearSelect.value = year;
                    console.log(`Set ${type}Year to:`, year);
                }
                if (hiddenInput) {
                    hiddenInput.value = dateString;
                    console.log(`Set ${type}Date hidden field to:`, dateString);
                }

                // Trigger the update event to ensure sync
                if (daySelect && monthSelect && yearSelect) {
                    const event = new Event('change');
                    daySelect.dispatchEvent(event);
                }

                console.log(`Successfully set ${type} date dropdowns:`, { day, month, year, dateString });
            } catch (error) {
                console.error(`Error setting ${type} date dropdowns:`, error);
            }
        }

        // Setup status change handler for resign date logic
        function setupStatusChangeHandler() {
            const statusField = document.getElementById('status');
            const resignDateField = document.getElementById('resignDate');
            const resignDateContainer = resignDateField.closest('div');

            // Remove any existing event listeners
            statusField.removeEventListener('change', handleStatusChange);

            // Add new event listener
            statusField.addEventListener('change', handleStatusChange);

            // Initial setup based on current status
            handleStatusChange();

            function handleStatusChange() {
                const status = statusField.value;
                const resignDateLabel = resignDateContainer.querySelector('label');

                if (status === 'Inactive') {
                    // Make resign date required and visible
                    resignDateField.required = true;
                    resignDateContainer.style.display = 'block';
                    resignDateLabel.textContent = 'Resign Date*';
                    resignDateContainer.classList.remove('hidden');
                } else {
                    // Make resign date optional and clear it
                    resignDateField.required = false;
                    resignDateField.value = '';
                    resignDateLabel.textContent = 'Resign Date';
                    // Keep it visible but optional for Active employees
                    resignDateContainer.style.display = 'block';
                    resignDateContainer.classList.remove('hidden');
                }
            }
        }

        // Employee Card Modal Functions
        let currentCardEmployeeId = null;

        function openEmployeeCardModal(employeeId) {
            const emp = employees.find(e => e.id === employeeId);
            if (!emp) return;

            currentCardEmployeeId = employeeId;

            // Handle field name compatibility
            const fullName = emp.fullName || emp.full_name || 'Unknown';
            const hiringDate = emp.hiringDate || emp.hiring_date;
            const idNumber = emp.idNumber || emp.id_number;
            const socialInsurance = emp.socialInsurance || emp.social_insurance;
            const militaryStatus = emp.militaryStatus || emp.military_status;
            const directManager = emp.directManager || emp.direct_manager;
            const maritalStatus = emp.maritalStatus || emp.marital_status;
            const gradYear = emp.gradYear || emp.grad_year;
            const resignDate = emp.resignDate || emp.resign_date;
            const annualLeaveBalance = emp.annualLeaveBalance || emp.annual_leave_balance;

            // Populate the employee card content
            const cardContent = document.getElementById('employeeCardContent');

            // Create a visually appealing card with all employee details
            const cardHTML = `
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-lg shadow-inner">
                    <div class="flex flex-col md:flex-row md:items-start">
                        <div class="flex-shrink-0 mb-4 md:mb-0 md:mr-6">
                            <div class="w-24 h-24 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-700 text-3xl font-bold border-2 border-indigo-300">
                                ${fullName.split(' ').map(n => n[0]).join('')}
                            </div>
                        </div>
                        <div class="flex-grow">
                            <h2 class="text-2xl font-bold text-gray-800 mb-1">${fullName}</h2>
                            <div class="flex items-center mb-3">
                                <span class="px-2 py-1 text-xs rounded-full ${emp.status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'} mr-2">
                                    ${emp.status}
                                </span>
                                <span class="text-gray-600">${emp.position}  ${emp.department}</span>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                <div class="space-y-3">
                                    <div>
                                        <h3 class="text-xs font-semibold text-gray-500 uppercase">Employee ID</h3>
                                        <p class="text-gray-800">${emp.id}</p>
                                    </div>
                                    <div>
                                        <h3 class="text-xs font-semibold text-gray-500 uppercase">Gender</h3>
                                        <p class="text-gray-800">${emp.gender || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <h3 class="text-xs font-semibold text-gray-500 uppercase">Date of Birth</h3>
                                        <p class="text-gray-800">${formatDate(emp.dob)}</p>
                                    </div>
                                    <div>
                                        <h3 class="text-xs font-semibold text-gray-500 uppercase">Hiring Date</h3>
                                        <p class="text-gray-800">${formatDate(hiringDate)}</p>
                                    </div>
                                    <div>
                                        <h3 class="text-xs font-semibold text-gray-500 uppercase">Level</h3>
                                        <p class="text-gray-800">${emp.level}</p>
                                    </div>
                                    <div>
                                        <h3 class="text-xs font-semibold text-gray-500 uppercase">Direct Manager</h3>
                                        <p class="text-gray-800">${directManager || 'N/A'}</p>
                                    </div>
                                </div>
                                <div class="space-y-3">
                                    <div>
                                        <h3 class="text-xs font-semibold text-gray-500 uppercase">Phone</h3>
                                        <p class="text-gray-800">${emp.phone || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <h3 class="text-xs font-semibold text-gray-500 uppercase">Email</h3>
                                        <p class="text-gray-800">${emp.email || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <h3 class="text-xs font-semibold text-gray-500 uppercase">ID Number</h3>
                                        <p class="text-gray-800">${idNumber}</p>
                                    </div>
                                    <div>
                                        <h3 class="text-xs font-semibold text-gray-500 uppercase">Social Insurance</h3>
                                        <p class="text-gray-800">${socialInsurance || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <h3 class="text-xs font-semibold text-gray-500 uppercase">Military Status</h3>
                                        <p class="text-gray-800">${militaryStatus || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <h3 class="text-xs font-semibold text-gray-500 uppercase">Marital Status</h3>
                                        <p class="text-gray-800">${maritalStatus || 'N/A'}</p>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <h3 class="text-xs font-semibold text-gray-500 uppercase">Address</h3>
                                        <p class="text-gray-800">${emp.address || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <h3 class="text-xs font-semibold text-gray-500 uppercase">Education</h3>
                                        <p class="text-gray-800">${emp.faculty ? `${emp.faculty} (${gradYear || 'N/A'})` : 'N/A'}</p>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <h3 class="text-xs font-semibold text-gray-500 uppercase">Annual Leave Balance</h3>
                                        <p class="text-xl font-semibold text-blue-600">${annualLeaveBalance || '0'} days</p>
                                    </div>
                                    ${resignDate ? `
                                    <div>
                                        <h3 class="text-xs font-semibold text-gray-500 uppercase">Resignation Date</h3>
                                        <p class="text-xl font-semibold text-red-600">${formatDate(resignDate)}</p>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            cardContent.innerHTML = cardHTML;

            // Show the modal
            const modal = document.getElementById('employeeCardModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            modal.style.display = 'flex';
        }

        function closeEmployeeCardModal() {
            const modal = document.getElementById('employeeCardModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            modal.style.display = 'none';
            currentCardEmployeeId = null;
        }

        function openEditEmployeeModalFromCard() {
            if (currentCardEmployeeId) {
                closeEmployeeCardModal();
                openEditEmployeeModal(currentCardEmployeeId);
            }
        }

        async function handleEmployeeFormSubmit(event) {
            event.preventDefault();
            const employeeId = document.getElementById('employeeId').value;
            const isEditing = !!employeeId;
            const empCode = document.getElementById('empCode').value.trim();

            if (!empCode) { showMessage('Employee Code is required.', 'error'); return; }
            if (!isEditing && employees.some(e => e.id === empCode)) { showMessage('Employee code already exists.', 'error'); return; }
            if (!document.getElementById('gender').value) { showMessage('Gender is required.', 'error'); return; }
            if (!document.getElementById('phone').value) { showMessage('Phone number is required.', 'error'); return; }
            if (!document.getElementById('email').value) { showMessage('Email address is required.', 'error'); return; }
            if (!document.getElementById('address').value) { showMessage('Address is required.', 'error'); return; }
            // Add more validation...

            // Get department and position values
            const departmentValue = document.getElementById('department').value.trim();
            const positionValue = document.getElementById('position').value.trim();

            // Check if department and position are provided
            if (!departmentValue) { showMessage('Department is required.', 'error'); return; }
            if (!positionValue) { showMessage('Position is required.', 'error'); return; }

            // Validate resign date based on status
            const status = document.getElementById('status').value;
            const resignDate = document.getElementById('resignDate').value;

            if (status === 'Inactive' && !resignDate) {
                showMessage('Resign date is required when employee status is Inactive.', 'error');
                return;
            }

            // Helper function to get valid date or null
            function getValidDateOrNull(fieldId) {
                const value = document.getElementById(fieldId).value;
                console.log(`Checking date field ${fieldId}:`, value);

                if (!value || value.trim() === '') {
                    console.log(`Date field ${fieldId} is empty`);
                    return null;
                }
                // Validate date format
                const date = new Date(value);
                if (isNaN(date.getTime())) {
                    console.log(`Date field ${fieldId} has invalid date:`, value);
                    return null;
                }
                console.log(`Date field ${fieldId} is valid:`, value);
                return value;
            }

            const formData = {
                id: isEditing ? employeeId : empCode,
                fullName: document.getElementById('fullName').value,
                gender: document.getElementById('gender').value,
                hiringDate: getValidDateOrNull('hiringDate'),
                position: positionValue,
                department: departmentValue,
                dob: getValidDateOrNull('dob'),
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value,
                address: document.getElementById('address').value,
                idNumber: document.getElementById('idNumber').value,
                socialInsurance: document.getElementById('socialInsurance').value || null,
                status: document.getElementById('status').value,
                militaryStatus: document.getElementById('militaryStatus').value || null,
                level: document.getElementById('level').value,
                directManager: document.getElementById('directManager').value || null,
                resignDate: status === 'Active' ? null : getValidDateOrNull('resignDate'),
                maritalStatus: document.getElementById('maritalStatus').value || null,
                faculty: document.getElementById('faculty').value || null,
                gradYear: document.getElementById('gradYear').value ? parseInt(document.getElementById('gradYear').value) : null,
                annualLeaveBalance: document.getElementById('leaveBalance').value ? parseInt(document.getElementById('leaveBalance').value) : null,
            };

            // Debug: Log all form data
            console.log('Complete form data:', formData);
            console.log('DOB value from form:', formData.dob);
            console.log('Hiring date value from form:', formData.hiringDate);

            // Check hidden field values directly
            console.log('Hidden field values:');
            console.log('- hiringDate field:', document.getElementById('hiringDate').value);
            console.log('- dob field:', document.getElementById('dob').value);
            console.log('- resignDate field:', document.getElementById('resignDate').value);

            // Check dropdown values
            console.log('DOB dropdown values:');
            console.log('- dobDay:', document.getElementById('dobDay').value);
            console.log('- dobMonth:', document.getElementById('dobMonth').value);
            console.log('- dobYear:', document.getElementById('dobYear').value);

            // Validate required dates
            if (!formData.hiringDate) {
                showMessage('Hiring date is required.', 'error');
                return;
            }

            if (!formData.dob) {
                showMessage('Date of birth is required.', 'error');
                return;
            }

            try {
                // Prepare data for Supabase (convert field names to match database schema)
                const supabaseData = {
                    id: formData.id, // This serves as both id and employee_code
                    full_name: formData.fullName,
                    gender: formData.gender,
                    hiring_date: formData.hiringDate,
                    position: formData.position,
                    department: formData.department,
                    dob: formData.dob,
                    phone: formData.phone,
                    email: formData.email,
                    address: formData.address,
                    id_number: formData.idNumber,
                    social_insurance: formData.socialInsurance,
                    status: formData.status,
                    military_status: formData.militaryStatus,
                    level: formData.level,
                    direct_manager: formData.directManager,
                    resign_date: formData.resignDate,
                    marital_status: formData.maritalStatus,
                    faculty: formData.faculty,
                    grad_year: formData.gradYear,
                    annual_leave_balance: formData.annualLeaveBalance
                };

                console.log('Sending data to Supabase:', supabaseData);
                console.log('Form data being processed:', formData);
                console.log('Is editing:', isEditing, 'Employee ID:', employeeId);
                console.log('Direct manager value:', formData.directManager);
                console.log('Managers array:', managers);
                console.log('Available managers:', managers.map(m => ({id: m.id, name: m.fullName || m.full_name})));

                if (isEditing) {
                    // Update employee in Supabase
                    const { data, error } = await dbHelpers.updateEmployee(employeeId, supabaseData);
                    if (error) {
                        console.error('Error updating employee:', error);
                        console.error('Error details:', error.message, error.details, error.hint);
                        console.error('Supabase data that failed:', supabaseData);
                        showMessage(`Error updating employee: ${error.message}`, 'error');
                        return;
                    }

                    // Update local array
                    const index = employees.findIndex(e => e.id === employeeId);
                    if (index !== -1) {
                        employees[index] = formData;
                    }
                    showMessage('Employee updated successfully!');
                } else {
                    // Add employee to Supabase
                    const { data, error } = await dbHelpers.addEmployee(supabaseData);
                    if (error) {
                        console.error('Error adding employee:', error);
                        console.error('Error details:', error.message, error.details, error.hint);
                        showMessage(`Error adding employee: ${error.message}`, 'error');
                        return;
                    }

                    console.log('Employee added successfully to Supabase:', data);
                    // Add to local array
                    employees.push(formData);
                    showMessage('Employee added successfully!');
                }

                // Check if a new department was added
                if (!departments.includes(departmentValue)) {
                    console.log(`New department added: ${departmentValue}`);
                    showMessage(`New department "${departmentValue}" has been added.`, 'success');
                }

                // Check if a new position was added
                if (!positions.includes(positionValue)) {
                    console.log(`New position added: ${positionValue}`);
                    showMessage(`New position "${positionValue}" has been added.`, 'success');
                }

                // Employee data is now automatically saved to Supabase
            } catch (error) {
                console.error('Error in employee form submission:', error);
                showMessage('Error saving employee data.', 'error');
                return;
            }

            // Create or update user account for the employee
            const email = document.getElementById('email').value.trim();
            if (email) {
                // Check if user account already exists
                const existingAccountIndex = userAccounts.findIndex(account =>
                    account.employeeId === formData.id || account.username === email
                );

                // Determine role based on employee level
                const role = formData.level === 'Manager' ? 'manager' : 'employee';

                if (existingAccountIndex !== -1) {
                    // Update existing account
                    const oldRole = userAccounts[existingAccountIndex].role;
                    userAccounts[existingAccountIndex] = {
                        ...userAccounts[existingAccountIndex],
                        username: email,
                        employeeId: formData.id,
                        role: role
                    };

                    // Show message about updated account
                    if (oldRole !== role) {
                        showMessage(`User account updated: ${email} (Role changed from ${oldRole} to ${role})`, 'success');
                    } else {
                        showMessage(`User account updated: ${email}`, 'success');
                    }
                } else {
                    // Create new account with default password
                    userAccounts.push({
                        username: email,
                        password: 'user123',
                        role: role,
                        employeeId: formData.id
                    });

                    // Show message about new account creation
                    showMessage(`New user account created: ${email} (Role: ${role}, Password: user123)`, 'success');
                }

                // Save user accounts to localStorage
                localStorage.setItem('hrSystemUserAccounts', JSON.stringify(userAccounts));

                // Log the updated user accounts for debugging
                console.log('Updated user accounts:', userAccounts);
            }

            // Reload ALL data from Supabase to ensure synchronization
            await loadSavedData();

            // Refresh UI
            updateDynamicDataLists(); // Update lists like departments, positions
            populateFilterDropdowns(); // Update ALL dropdowns
            populateDashboardFilterDropdowns(); // Update dashboard dropdowns specifically
            populateEmployeeTable(); // Update DB table
            updateDashboard(); // Update dashboard stats & charts
            closeEmployeeModal();
        }

        async function deleteEmployee(employeeId) {
            if (confirm(`Are you sure you want to delete employee ${employeeId}? This action cannot be undone.`)) {
                try {
                    const index = employees.findIndex(e => e.id === employeeId);
                    if (index !== -1) {
                        // Get the employee's email before deleting
                        const employeeEmail = employees[index].email;

                        // Delete from Supabase database first
                        const { data, error } = await dbHelpers.deleteEmployee(employeeId);
                        if (error) {
                            console.error('Error deleting employee from database:', error);
                            showMessage(`Error deleting employee from database: ${error.message}`, 'error');
                            return;
                        }

                        console.log('Employee deleted from Supabase successfully:', data);

                        // Delete from local arrays
                        employees.splice(index, 1);

                        // Delete related records (these should also be deleted from Supabase in a real system)
                        leaveRecords = leaveRecords.filter(lr => lr.employeeId !== employeeId);
                        excuseRecords = excuseRecords.filter(er => er.employeeId !== employeeId);
                        overtimeRecords = overtimeRecords.filter(or => or.employeeId !== employeeId);
                        penaltyRecords = penaltyRecords.filter(pr => pr.employeeId !== employeeId);

                        // Delete user account
                        if (employeeEmail) {
                            const accountIndex = userAccounts.findIndex(account =>
                                account.employeeId === employeeId || account.username === employeeEmail
                            );

                            if (accountIndex !== -1) {
                                userAccounts.splice(accountIndex, 1);
                                localStorage.setItem('hrSystemUserAccounts', JSON.stringify(userAccounts));
                            }
                        }

                        // All data is now automatically managed in Supabase

                        // Refresh UI
                        updateDynamicDataLists();
                        populateFilterDropdowns();
                        populateDashboardFilterDropdowns();
                        populateEmployeeTable();
                        populateLeaveTable();
                        populateExcuseTable();
                        populateOvertimeTable();
                        populatePenaltyTable();
                        populateSalaryTable();
                        updateDashboard(); // Update dashboard after deletion
                        showMessage(`Employee ${employeeId} deleted successfully from database and system.`);
                    } else {
                        showMessage(`Error: Employee ${employeeId} not found.`, 'error');
                    }
                } catch (error) {
                    console.error('Error in deleteEmployee function:', error);
                    showMessage(`Error deleting employee: ${error.message}`, 'error');
                }
            }
        }


        // Helper function to calculate remaining leave balance dynamically
        function calculateRemainingLeaveBalance(employeeId) {
            const employee = employees.find(e => e.id === employeeId);
            if (!employee) return 0;

            // Get original allocated balance (this never changes)
            const originalBalance = employee.annualLeaveBalance ?? employee.annual_leave_balance ?? 0;

            // Calculate total approved annual leave days
            const approvedAnnualLeaves = leaveRecords.filter(r =>
                r.employeeId === employeeId &&
                r.status === 'Approved' &&
                r.type.toLowerCase().includes('annual')
            );

            const totalUsedDays = approvedAnnualLeaves.reduce((sum, leave) => sum + parseFloat(leave.days), 0);
            const remainingBalance = originalBalance - totalUsedDays;

            console.log(`Employee ${employeeId} balance calculation:`, {
                original: originalBalance,
                used: totalUsedDays,
                remaining: remainingBalance
            });

            return Math.max(0, remainingBalance); // Never go below 0
        }

        // --- Employee Leaves ---
        function populateLeaveTable() {
            const tableBody = document.getElementById('leaveTableBody');
            if (!tableBody) return;
            tableBody.innerHTML = '';

            // Filter records based on user role
            let filteredLeaveRecords = [];

            if (currentUserRole === 'admin' || currentUserRole === 'admin_1') {
                // Admin and admin_1 see all records
                filteredLeaveRecords = leaveRecords;
            }
            else if (currentUserRole === 'manager') {
                // Manager sees only their team's records
                const managerName = currentUserData.fullName || currentUserData.full_name;
                const teamMemberIds = employees
                    .filter(emp => {
                        const empManager = emp.directManager || emp.direct_manager;
                        return empManager === managerName;
                    })
                    .map(emp => emp.id);

                console.log('DEBUG Leave Filter - Manager:', managerName, 'Team IDs:', teamMemberIds);

                // Include manager's own records and team members' records
                const managerId = currentUserData ? currentUserData.id : currentUserId;
                filteredLeaveRecords = leaveRecords.filter(record =>
                    teamMemberIds.includes(record.employeeId) || record.employeeId === managerId
                );
            }
            else {
                // Employee sees only their own records
                if (currentUserData && currentUserData.id) {
                    filteredLeaveRecords = leaveRecords.filter(record => record.employeeId === currentUserData.id);
                } else {
                    // Fallback to currentUserId if currentUserData is not available
                    filteredLeaveRecords = leaveRecords.filter(record => record.employeeId === currentUserId);
                }
            }

            if (filteredLeaveRecords.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">No leave records found.</td></tr>';
                return;
            }

            // Get filter values
            const employeeFilter = document.getElementById('leave-filter-employee').value;
            const monthFilter = document.getElementById('leave-filter-month').value;

            // Get current year
            const currentYear = new Date().getFullYear();

            // DIRECT CALCULATION: Get the filtered records based on the current filters
            let filteredRecords = [...filteredLeaveRecords];

            // Apply employee filter
            if (employeeFilter !== 'all') {
                console.log('Applying employee filter:', employeeFilter);
                filteredRecords = filteredRecords.filter(record => record.employeeId === employeeFilter);
                console.log('Records after employee filter:', filteredRecords.length);
            }

            // Apply month filter
            if (monthFilter !== 'all') {
                const monthNum = parseInt(monthFilter);
                filteredRecords = filteredRecords.filter(record => {
                    const startDate = new Date(record.startDate);
                    return startDate.getMonth() + 1 === monthNum;
                });
            }

            // IMPORTANT: For demo purposes, we'll include 2024 records as well
            // This is because our mock data has records from 2024
            filteredRecords = filteredRecords.filter(record => {
                const startDate = new Date(record.startDate);
                const recordYear = startDate.getFullYear();
                // Include both current year and 2024 (for demo data)
                return recordYear === currentYear || recordYear === 2024;
            });

            // Sort by date (newest first)
            filteredRecords.sort((a, b) => new Date(b.startDate) - new Date(a.startDate));

            // Check if we have any records after filtering
            if (filteredRecords.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">No leave records found with the selected filters.</td></tr>';

                // Make sure to update the leave summary even when no records are found
                updateLeaveSummary(employeeFilter, monthFilter);
                return;
            }

            // Populate table with filtered records
            filteredRecords.forEach(record => {
                const statusColor = record.status === 'Approved' ? 'bg-green-100 text-green-800' : (record.status === 'Pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800');
                // Try multiple ways to get employee name
                const employee = employees.find(e => e.id === record.employeeId);
                const empName = employee?.fullName || employee?.full_name || record.employeeName || record.employee_name || record.employeeId;

                // Format days display to show "0.5" as "Half Day"
                let daysDisplay = parseFloat(record.days);
                if (daysDisplay === 0.5) {
                    daysDisplay = '<span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">Half Day</span>';
                }

                // Only show action buttons for admin users
                const actionButtons = (currentUserRole === 'admin' || currentUserRole === 'admin_1') ? `
                    <td class="px-4 py-2 whitespace-nowrap text-sm font-medium space-x-2">
                        <button onclick="editLeaveRecord('${record.id}')" class="text-indigo-600 hover:text-indigo-900" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteLeaveRecord('${record.id}')" class="text-red-600 hover:text-red-900" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                        ${record.status === 'Pending' ? `
                        <button onclick="approveLeaveRecord('${record.id}')" class="text-green-600 hover:text-green-900" title="Approve">
                            <i class="fas fa-check"></i>
                        </button>
                        <button onclick="rejectLeaveRecord('${record.id}')" class="text-red-600 hover:text-red-900" title="Reject">
                            <i class="fas fa-times"></i>
                        </button>
                        ` : ''}
                    </td>
                ` : `<td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">-</td>`;

                const row = `
                    <tr class="hover:bg-gray-50 transition duration-150">
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${empName}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${formatDate(record.startDate)}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${formatDate(record.endDate)}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${daysDisplay}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${record.type}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                                ${record.status}
                            </span>
                        </td>
                        ${actionButtons}
                    </tr>
                `;
                tableBody.innerHTML += row;
            });

            // Update leave summary based on the same filters
            updateLeaveSummary(employeeFilter, monthFilter);
        }

        async function handleLeaveFormSubmit(event) {
            event.preventDefault();
            const employeeCode = document.getElementById('leave-employee-code').value.trim();
            const employeeId = document.getElementById('leave-employee').value;
            const startDate = document.getElementById('leave-start-date').value;
            const endDate = document.getElementById('leave-end-date').value;
            const leaveType = document.getElementById('leave-type').value;
            const leaveDays = parseFloat(document.getElementById('leave-days').value);
            const editId = document.getElementById('leave-edit-id')?.value;

            if (!employeeCode || !startDate || !endDate) {
                showMessage('Please enter employee code and select dates.', 'error');
                return;
            }

            if (!employeeId) {
                showMessage('Invalid employee code. Please enter a valid employee code.', 'error');
                return;
            }

            const employee = employees.find(e => e.id === employeeId);
            if (!employee) {
                showMessage('Selected employee not found.', 'error');
                return;
            }

            // Validate that selected days match calendar selection
            const calculatedDays = calculateLeaveDays(startDate, endDate);
            if (calculatedDays !== leaveDays) {
                showMessage(`Selected days (${leaveDays}) don't match calendar selection (${calculatedDays} days)`, 'error');
                return;
            }

            // Set status based on current user role
            const status = (currentUserRole === 'admin' || currentUserRole === 'admin_1') ? 'Approved' : 'Pending';

            // For annual leave, check if employee has sufficient balance
            if (leaveType === 'annual') {
                console.log('Processing annual leave:', leaveType);

                // Get the employee's REMAINING leave balance (calculated dynamically)
                const remainingBalance = calculateRemainingLeaveBalance(employeeId);
                console.log('Remaining leave balance:', remainingBalance);
                console.log('Employee data:', employee);

                // Check if employee has a leave balance set
                if (remainingBalance === null || remainingBalance === undefined || remainingBalance === 0) {
                    showMessage(`Employee has no leave balance remaining. Please check with admin.`, 'error');
                    return;
                }

                if (remainingBalance < leaveDays) {
                    showMessage(`Insufficient leave balance (${remainingBalance.toFixed(1)} days remaining). Requested: ${leaveDays} days.`, 'error');
                    return;
                }

                // Note: We don't deduct from employee table balance anymore
                // Balance is calculated dynamically based on approved leave records
                console.log(`Leave request will be ${status}. Balance calculation is dynamic.`);
            }

            // Check if we're editing an existing record
            if (editId) {
                // Find the existing record
                const recordIndex = leaveRecords.findIndex(r => r.id == editId);
                if (recordIndex === -1) {
                    showMessage('Record not found.', 'error');
                    return;
                }

                // Check if we're changing the status from Approved to something else or vice versa
                const oldRecord = leaveRecords[recordIndex];
                const oldStatus = oldRecord.status;
                const newStatus = status;
                const isAnnualLeave = oldRecord.type.toLowerCase().includes('annual');

                // Note: We don't update employee table balance anymore
                // Balance is calculated dynamically based on approved leave records
                if (oldStatus === 'Approved' && newStatus !== 'Approved' && isAnnualLeave) {
                    console.log('Leave status changed from Approved to non-Approved - balance calculation is dynamic');
                    showMessage(`Leave status changed. Balance calculation is dynamic.`);
                }
                else if (oldStatus !== 'Approved' && newStatus === 'Approved' && isAnnualLeave) {
                    // Check if employee has sufficient remaining balance using dynamic calculation
                    const remainingBalance = calculateRemainingLeaveBalance(employeeId);
                    if (remainingBalance < leaveDays) {
                        showMessage(`Insufficient leave balance (${remainingBalance.toFixed(1)} days remaining). Requested: ${leaveDays} days.`, 'error');
                        return;
                    }
                    console.log('Leave status changed to Approved - balance calculation is dynamic');
                    showMessage(`Leave status changed to Approved. Balance calculation is dynamic.`);
                }

                // Update the record
                leaveRecords[recordIndex] = {
                    ...leaveRecords[recordIndex],
                    employeeId: employeeId,
                    employeeName: employee.fullName || employee.full_name || 'Unknown',
                    startDate: startDate,
                    endDate: endDate,
                    days: leaveDays,
                    type: document.getElementById('leave-type').options[document.getElementById('leave-type').selectedIndex].text,
                    status: status
                };

                // Remove the edit ID field
                document.getElementById('leave-edit-id').remove();

                // Change the submit button text back
                const submitBtn = document.querySelector('#leave-form button[type="submit"]');
                if (submitBtn) {
                    submitBtn.textContent = 'Submit Leave';
                }

                // Remove the cancel button
                const cancelBtn = document.getElementById('leave-cancel-edit');
                if (cancelBtn) {
                    cancelBtn.remove();
                }

                showMessage('Leave record updated successfully!');
            } else {
                // Create a new record for Supabase
                const supabaseLeaveData = {
                    employee_id: employeeId,
                    employee_name: employee.fullName || employee.full_name || 'Unknown',
                    start_date: startDate,
                    end_date: endDate,
                    days: leaveDays,
                    type: document.getElementById('leave-type').options[document.getElementById('leave-type').selectedIndex].text,
                    status: status
                };

                // Save to Supabase
                const { data, error } = await dbHelpers.addLeaveRequest(supabaseLeaveData);
                if (error) {
                    console.error('Error saving leave request to Supabase:', error);
                    showMessage(`Error saving leave request: ${error.message}`, 'error');
                    return;
                }

                console.log('Leave request saved to Supabase:', data);

                // Also add to local array for immediate UI update
                const newRecord = {
                    id: data.id,
                    employeeId: employeeId,
                    employeeName: employee.fullName || employee.full_name || 'Unknown',
                    startDate: startDate,
                    endDate: endDate,
                    days: leaveDays,
                    type: document.getElementById('leave-type').options[document.getElementById('leave-type').selectedIndex].text,
                    status: status
                };

                leaveRecords.push(newRecord);
                showMessage('Leave request submitted successfully!');
            }

            // Data is now automatically saved to Supabase

            // Reset form
            document.getElementById('leave-form').reset();
            document.getElementById('leave-employee-name').value = '';
            document.getElementById('leave-balance').value = '';

            // Hide the leave form container after submission
            document.getElementById('leave-form-container').classList.add('hidden');

            // If employee or manager is submitting their own request, redirect to My Requests
            if (currentUserRole === 'employee' || currentUserRole === 'manager') {
                showSection('my-requests');
                populateMyRequests();
            } else {
                // For admin, show the regular leave table
                populateLeaveTable();
                updateDashboard(); // Update dashboard as leaves affect stats/charts

                // Update leave summary with current filters
                const employeeFilter = document.getElementById('leave-filter-employee').value;
                const monthFilter = document.getElementById('leave-filter-month').value;
                updateLeaveSummary(employeeFilter, monthFilter);
            }
        }

        // Note: All data arrays are now declared at the top and will be populated from Supabase

        // Handle excuse form submission
        async function handleExcuseFormSubmit(event) {
            event.preventDefault();
            const employeeCode = document.getElementById('excuse-employee-code').value.trim();
            const employeeId = document.getElementById('excuse-employee').value;
            const excuseDate = document.getElementById('excuse-date').value;
            const excuseType = document.getElementById('excuse-type').value;
            const startTime = document.getElementById('excuse-start-time').value;
            const endTime = document.getElementById('excuse-end-time').value;
            const startTimeDisplay = document.getElementById('excuse-start-time-display').value;
            const endTimeDisplay = document.getElementById('excuse-end-time-display').value;
            const excuseReason = document.getElementById('excuse-reason').value;
            const editId = document.getElementById('excuse-edit-id')?.value;

            if (!employeeCode || !excuseDate) {
                showMessage('Please enter employee code and date.', 'error');
                return;
            }

            if (!startTime || !endTime) {
                showMessage('Please select both start and end times.', 'error');
                return;
            }

            if (!employeeId) {
                showMessage('Invalid employee code. Please enter a valid employee code.', 'error');
                return;
            }

            const employee = employees.find(e => e.id === employeeId);
            if (!employee) {
                showMessage('Selected employee not found.', 'error');
                return;
            }

            // Validate that end time is after start time
            if (startTime && endTime) {
                const startHour = parseInt(startTime.split(':')[0]);
                const endHour = parseInt(endTime.split(':')[0]);

                if (endHour < startHour) {
                    showMessage('End time must be after start time.', 'error');
                    return;
                }

                if (startHour === endHour) {
                    showMessage('Start and end times cannot be the same.', 'error');
                    return;
                }
            }

            // Set status based on current user role
            const status = (currentUserRole === 'admin' || currentUserRole === 'admin_1') ? 'Approved' : 'Pending';

            // Check if we're editing an existing record
            if (editId) {
                // Find the existing record
                const recordIndex = excuseRecords.findIndex(r => r.id == editId);
                if (recordIndex === -1) {
                    showMessage('Record not found.', 'error');
                    return;
                }

                // Update the record
                excuseRecords[recordIndex] = {
                    ...excuseRecords[recordIndex],
                    employeeId: employeeId,
                    employeeName: employee.fullName || employee.full_name || 'Unknown',
                    date: excuseDate,
                    type: document.getElementById('excuse-type').options[document.getElementById('excuse-type').selectedIndex].text,
                    startTime: startTimeDisplay,
                    endTime: endTimeDisplay,
                    reason: excuseReason || 'No reason provided',
                    status: status
                };

                // Remove the edit ID field
                document.getElementById('excuse-edit-id').remove();

                // Change the submit button text back
                const submitBtn = document.querySelector('#excuse-form button[type="submit"]');
                if (submitBtn) {
                    submitBtn.textContent = 'Submit Excuse Request';
                }

                // Remove the cancel button
                const cancelBtn = document.getElementById('excuse-cancel-edit');
                if (cancelBtn) {
                    cancelBtn.remove();
                }

                showMessage('Excuse record updated successfully!');
            } else {
                // Create new excuse record for Supabase
                const supabaseExcuseData = {
                    employee_id: employeeId,
                    employee_name: employee.fullName || employee.full_name || 'Unknown',
                    date: excuseDate,
                    type: document.getElementById('excuse-type').options[document.getElementById('excuse-type').selectedIndex].text,
                    start_time: startTimeDisplay,
                    end_time: endTimeDisplay,
                    reason: excuseReason || 'No reason provided',
                    status: status
                };

                // Save to Supabase
                const { data, error } = await dbHelpers.addExcuseRequest(supabaseExcuseData);
                if (error) {
                    console.error('Error saving excuse request to Supabase:', error);
                    showMessage(`Error saving excuse request: ${error.message}`, 'error');
                    return;
                }

                console.log('Excuse request saved to Supabase:', data);

                // Also add to local array for immediate UI update
                const newExcuse = {
                    id: data.id,
                    employeeId: employeeId,
                    employeeName: employee.fullName || employee.full_name || 'Unknown',
                    date: excuseDate,
                    type: document.getElementById('excuse-type').options[document.getElementById('excuse-type').selectedIndex].text,
                    startTime: startTimeDisplay,
                    endTime: endTimeDisplay,
                    reason: excuseReason || 'No reason provided',
                    status: status
                };

                // Add to records
                if (!excuseRecords) excuseRecords = [];
                excuseRecords.push(newExcuse);

                showMessage('Excuse request submitted successfully!');
            }

            // Data is now automatically saved to Supabase

            // Reset form
            document.getElementById('excuse-form').reset();
            document.getElementById('excuse-employee-name').value = '';

            // Hide the form container
            document.getElementById('excuse-form-container').classList.add('hidden');

            // If employee or manager is submitting their own request, redirect to My Requests
            if (currentUserRole === 'employee' || currentUserRole === 'manager') {
                showSection('my-requests');
                populateMyRequests();
            } else {
                // For admin, show the regular excuse table
                populateExcuseTable();
                updateExcuseSummary();
            }
        }

        // Function to validate and auto-correct penalty days to nearest 0.25 increment
        function validatePenaltyDays(value) {
            // Parse the input value to a float
            let days = parseFloat(value);

            // Check if it's a valid number
            if (isNaN(days) || days < 0.25) {
                return 0.25; // Minimum value
            }

            // Round to nearest 0.25 increment
            return Math.round(days * 4) / 4;
        }

        // Handle penalty form submission
        async function handlePenaltyFormSubmit(event) {
            event.preventDefault();
            const employeeCode = document.getElementById('penalty-employee-code').value.trim();
            const employeeId = document.getElementById('penalty-employee').value;
            const penaltyDate = document.getElementById('penalty-date').value;

            // Get the penalty days value and validate/auto-correct it
            const penaltyDaysInput = document.getElementById('penalty-days');
            const penaltyDays = validatePenaltyDays(penaltyDaysInput.value);

            // Update the input field with the corrected value
            penaltyDaysInput.value = penaltyDays;

            const penaltyReason = document.getElementById('penalty-reason').value;
            const editId = document.getElementById('penalty-edit-id')?.value;

            if (!employeeCode || !penaltyDate) {
                showMessage('Please enter employee code and date.', 'error');
                return;
            }

            if (!employeeId) {
                showMessage('Invalid employee code. Please enter a valid employee code.', 'error');
                return;
            }

            const employee = employees.find(e => e.id === employeeId);
            if (!employee) {
                showMessage('Selected employee not found.', 'error');
                return;
            }

            // Set status based on current user role
            const status = (currentUserRole === 'admin' || currentUserRole === 'admin_1') ? 'Approved' : 'Pending';

            // Check if we're editing an existing record
            if (editId) {
                // Find the existing record
                const recordIndex = penaltyRecords.findIndex(r => r.id == editId);
                if (recordIndex === -1) {
                    showMessage('Record not found.', 'error');
                    return;
                }

                // Update the record
                penaltyRecords[recordIndex] = {
                    ...penaltyRecords[recordIndex],
                    employeeId: employeeId,
                    employeeName: employee.fullName || employee.full_name,
                    date: penaltyDate,
                    days: penaltyDays,
                    reason: penaltyReason,
                    status: status
                };

                // Remove the edit ID field
                document.getElementById('penalty-edit-id').remove();

                // Change the submit button text back
                const submitBtn = document.querySelector('#penalty-form button[type="submit"]');
                if (submitBtn) {
                    submitBtn.textContent = 'Submit Penalty';
                }

                // Remove the cancel button
                const cancelBtn = document.getElementById('penalty-cancel-edit');
                if (cancelBtn) {
                    cancelBtn.remove();
                }

                showMessage('Penalty record updated successfully!');
            } else {
                // Create new penalty record for Supabase
                const supabasePenaltyData = {
                    employee_id: employeeId,
                    employee_name: employee.fullName || employee.full_name,
                    date: penaltyDate,
                    days: penaltyDays,
                    reason: penaltyReason,
                    status: status
                };

                // Save to Supabase
                const { data, error } = await dbHelpers.addPenalty(supabasePenaltyData);
                if (error) {
                    console.error('Error saving penalty to Supabase:', error);
                    showMessage(`Error saving penalty: ${error.message}`, 'error');
                    return;
                }

                console.log('Penalty saved to Supabase:', data);

                // Also add to local array for immediate UI update
                const newPenalty = {
                    id: data.id,
                    employeeId: employeeId,
                    employeeName: employee.fullName || employee.full_name,
                    date: penaltyDate,
                    days: penaltyDays,
                    reason: penaltyReason,
                    status: status
                };

                // Add to records
                if (!penaltyRecords) penaltyRecords = [];
                penaltyRecords.push(newPenalty);

                showMessage('Penalty added successfully!');
            }

            // Update UI
            populatePenaltyTable();
            updatePenaltySummary();

            // Reset form
            document.getElementById('penalty-form').reset();
            document.getElementById('penalty-employee-name').value = '';

            // Hide the form container
            document.getElementById('penalty-form-container').classList.add('hidden');
        }

        // Handle overtime form submission
        async function handleOvertimeFormSubmit(event) {
            event.preventDefault();
            const employeeCode = document.getElementById('overtime-employee-code').value.trim();
            const employeeId = document.getElementById('overtime-employee').value;
            const overtimeDate = document.getElementById('overtime-date').value;
            const startTime = document.getElementById('overtime-start-time').value;
            const endTime = document.getElementById('overtime-end-time').value;
            const startTimeDisplay = document.getElementById('overtime-start-time-display').value;
            const endTimeDisplay = document.getElementById('overtime-end-time-display').value;
            const overtimeReason = document.getElementById('overtime-reason').value;
            const editId = document.getElementById('overtime-edit-id')?.value;

            if (!employeeCode || !overtimeDate) {
                showMessage('Please enter employee code and date.', 'error');
                return;
            }

            if (!startTime || !endTime) {
                showMessage('Please select both start and end times.', 'error');
                return;
            }

            if (!employeeId) {
                showMessage('Invalid employee code. Please enter a valid employee code.', 'error');
                return;
            }

            const employee = employees.find(e => e.id === employeeId);
            if (!employee) {
                showMessage('Selected employee not found.', 'error');
                return;
            }

            // Validate that end time is after start time
            if (startTime && endTime) {
                const startHour = parseInt(startTime.split(':')[0]);
                const endHour = parseInt(endTime.split(':')[0]);

                if (endHour <= startHour) {
                    showMessage('End time must be after start time.', 'error');
                    return;
                }
            }

            // Calculate hours
            const startHour = parseInt(startTime.split(':')[0]);
            const endHour = parseInt(endTime.split(':')[0]);
            const hours = endHour - startHour;

            // Set status based on current user role
            const status = (currentUserRole === 'admin' || currentUserRole === 'admin_1') ? 'Approved' : 'Pending';

            // Check if we're editing an existing record
            if (editId) {
                // Find the existing record
                const recordIndex = overtimeRecords.findIndex(r => r.id == editId);
                if (recordIndex === -1) {
                    showMessage('Record not found.', 'error');
                    return;
                }

                // Update the record
                overtimeRecords[recordIndex] = {
                    ...overtimeRecords[recordIndex],
                    employeeId: employeeId,
                    employeeName: employee.fullName || employee.full_name || 'Unknown',
                    date: overtimeDate,
                    startTime: startTimeDisplay,
                    endTime: endTimeDisplay,
                    hours: hours,
                    reason: overtimeReason || 'No reason provided',
                    status: status
                };

                // Remove the edit ID field
                document.getElementById('overtime-edit-id').remove();

                // Change the submit button text back
                const submitBtn = document.querySelector('#overtime-form button[type="submit"]');
                if (submitBtn) {
                    submitBtn.textContent = 'Submit Overtime Request';
                }

                // Remove the cancel button
                const cancelBtn = document.getElementById('overtime-cancel-edit');
                if (cancelBtn) {
                    cancelBtn.remove();
                }

                showMessage('Overtime record updated successfully!');
            } else {
                // Create new overtime record for Supabase
                const supabaseOvertimeData = {
                    employee_id: employeeId,
                    employee_name: employee.fullName || employee.full_name || 'Unknown',
                    date: overtimeDate,
                    start_time: startTimeDisplay,
                    end_time: endTimeDisplay,
                    hours: hours,
                    reason: overtimeReason || 'No reason provided',
                    status: status
                };

                // Save to Supabase
                const { data, error } = await dbHelpers.addOvertimeRequest(supabaseOvertimeData);
                if (error) {
                    console.error('Error saving overtime request to Supabase:', error);
                    showMessage(`Error saving overtime request: ${error.message}`, 'error');
                    return;
                }

                console.log('Overtime request saved to Supabase:', data);

                // Also add to local array for immediate UI update
                const newOvertime = {
                    id: data.id,
                    employeeId: employeeId,
                    employeeName: employee.fullName || employee.full_name || 'Unknown',
                    date: overtimeDate,
                    startTime: startTimeDisplay,
                    endTime: endTimeDisplay,
                    hours: hours,
                    reason: overtimeReason || 'No reason provided',
                    status: status
                };

                // Add to records
                if (!overtimeRecords) overtimeRecords = [];
                overtimeRecords.push(newOvertime);

                showMessage('Overtime request submitted successfully!');
            }

            // Data is now automatically saved to Supabase

            // Reset form
            document.getElementById('overtime-form').reset();
            document.getElementById('overtime-employee-name').value = '';

            // Hide the form container
            document.getElementById('overtime-form-container').classList.add('hidden');

            // If employee or manager is submitting their own request, redirect to My Requests
            if (currentUserRole === 'employee' || currentUserRole === 'manager') {
                showSection('my-requests');
                populateMyRequests();
            } else {
                // For admin, show the regular overtime table
                populateOvertimeTable();
                updateOvertimeSummary();
            }
        }

        // Edit overtime record
        function editOvertimeRecord(recordId) {
            // Find the record
            const record = overtimeRecords.find(r => r.id == recordId);
            if (!record) {
                showMessage('Record not found.', 'error');
                return;
            }

            // Populate the overtime form with the record data
            document.getElementById('overtime-employee-code').value = record.employeeId;
            document.getElementById('overtime-employee-name').value = record.employeeName;
            document.getElementById('overtime-employee').value = record.employeeId;

            // Set the date
            document.getElementById('overtime-date').value = record.date;

            // Set the time
            if (record.startTime) {
                document.getElementById('overtime-start-time-display').value = record.startTime;
            }
            if (record.endTime) {
                document.getElementById('overtime-end-time-display').value = record.endTime;
            }

            // Set the reason
            document.getElementById('overtime-reason').value = record.reason || '';

            // Show the overtime section and make the form visible
            showSection('overtime');
            document.getElementById('overtime-form-container').classList.remove('hidden');
            document.getElementById('overtime-form').scrollIntoView({ behavior: 'smooth' });

            // Add a hidden field to track that we're editing
            let editIdField = document.getElementById('overtime-edit-id');
            if (!editIdField) {
                editIdField = document.createElement('input');
                editIdField.type = 'hidden';
                editIdField.id = 'overtime-edit-id';
                document.getElementById('overtime-form').appendChild(editIdField);
            }
            editIdField.value = recordId;

            // Change the submit button text
            const submitBtn = document.querySelector('#overtime-form button[type="submit"]');
            if (submitBtn) {
                submitBtn.textContent = 'Update Overtime Record';
            }

            // Add a cancel button if it doesn't exist
            if (!document.getElementById('overtime-cancel-edit')) {
                const cancelBtn = document.createElement('button');
                cancelBtn.id = 'overtime-cancel-edit';
                cancelBtn.type = 'button';
                cancelBtn.className = 'px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition duration-150';
                cancelBtn.textContent = 'Cancel';
                cancelBtn.onclick = cancelOvertimeEdit;
                submitBtn.parentNode.insertBefore(cancelBtn, submitBtn);
            }
        }

        // Cancel overtime edit
        function cancelOvertimeEdit() {
            // Reset the form
            document.getElementById('overtime-form').reset();
            document.getElementById('overtime-employee-name').value = '';

            // Remove the edit ID field
            const editIdField = document.getElementById('overtime-edit-id');
            if (editIdField) {
                editIdField.remove();
            }

            // Change the submit button text back
            const submitBtn = document.querySelector('#overtime-form button[type="submit"]');
            if (submitBtn) {
                submitBtn.textContent = 'Submit Overtime Request';
            }

            // Remove the cancel button
            const cancelBtn = document.getElementById('overtime-cancel-edit');
            if (cancelBtn) {
                cancelBtn.remove();
            }

            // Hide the form container
            document.getElementById('overtime-form-container').classList.add('hidden');
        }

        // Delete overtime record
        async function deleteOvertimeRecord(recordId) {
            if (!confirm('Are you sure you want to delete this overtime record?')) {
                return;
            }

            try {
                // Delete from Supabase
                const { data, error } = await dbHelpers.deleteOvertimeRequest(recordId);
                if (error) {
                    console.error('Error deleting overtime from Supabase:', error);
                    showMessage(`Error deleting overtime: ${error.message}`, 'error');
                    return;
                }

                console.log('Overtime deleted from Supabase:', data);

                // Remove from local array
                const recordIndex = overtimeRecords.findIndex(r => r.id == recordId);
                if (recordIndex !== -1) {
                    overtimeRecords.splice(recordIndex, 1);
                }

                // Update the UI
                populateOvertimeTable();

                // Show success message
                showMessage('Overtime record deleted successfully.');
            } catch (error) {
                console.error('Error in deleteOvertimeRecord:', error);
                showMessage(`Error deleting overtime: ${error.message}`, 'error');
            }
        }

        // Approve overtime record
        async function approveOvertimeRecord(recordId) {
            try {
                // Update status in Supabase
                const { data, error } = await dbHelpers.updateOvertimeStatus(recordId, 'Approved');
                if (error) {
                    console.error('Error approving overtime in Supabase:', error);
                    showMessage(`Error approving overtime: ${error.message}`, 'error');
                    return;
                }

                console.log('Overtime approved in Supabase:', data);

                // Update local array
                const record = overtimeRecords.find(r => r.id == recordId);
                if (record) {
                    record.status = 'Approved';
                    showMessage(`Overtime request for ${record.employeeName} has been approved.`);
                }

                // Update the UI
                populateOvertimeTable();
            } catch (error) {
                console.error('Error in approveOvertimeRecord:', error);
                showMessage(`Error approving overtime: ${error.message}`, 'error');
            }
        }

        // Reject overtime record
        async function rejectOvertimeRecord(recordId) {
            if (!confirm('Are you sure you want to reject this overtime request?')) {
                return;
            }

            try {
                // Update status in Supabase
                const { data, error } = await dbHelpers.updateOvertimeStatus(recordId, 'Rejected');
                if (error) {
                    console.error('Error rejecting overtime in Supabase:', error);
                    showMessage(`Error rejecting overtime: ${error.message}`, 'error');
                    return;
                }

                console.log('Overtime rejected in Supabase:', data);

                // Update local array
                const record = overtimeRecords.find(r => r.id == recordId);
                if (record) {
                    record.status = 'Rejected';
                    showMessage(`Overtime request for ${record.employeeName} has been rejected.`);
                }

                // Update the UI
                populateOvertimeTable();
            } catch (error) {
                console.error('Error in rejectOvertimeRecord:', error);
                showMessage(`Error rejecting overtime: ${error.message}`, 'error');
            }
        }

        // Populate overtime table
        function populateOvertimeTable() {
            const tableBody = document.getElementById('overtimeTableBody');
            if (!tableBody) return;
            tableBody.innerHTML = '';

            // Filter records based on user role
            let filteredOvertimeRecords = [];

            if (currentUserRole === 'admin' || currentUserRole === 'admin_1') {
                // Admin and admin_1 see all records
                filteredOvertimeRecords = overtimeRecords;
            }
            else if (currentUserRole === 'manager') {
                // Manager sees only their team's records
                const managerName = currentUserData.fullName || currentUserData.full_name;
                const teamMemberIds = employees
                    .filter(emp => {
                        const empManager = emp.directManager || emp.direct_manager;
                        return empManager === managerName;
                    })
                    .map(emp => emp.id);

                console.log('DEBUG Overtime Filter - Manager:', managerName, 'Team IDs:', teamMemberIds);

                // Include manager's own records and team members' records
                const managerId = currentUserData ? currentUserData.id : currentUserId;
                filteredOvertimeRecords = overtimeRecords.filter(record =>
                    teamMemberIds.includes(record.employeeId) || record.employeeId === managerId
                );
            }
            else {
                // Employee sees only their own records
                if (currentUserData && currentUserData.id) {
                    filteredOvertimeRecords = overtimeRecords.filter(record => record.employeeId === currentUserData.id);
                } else {
                    // Fallback to currentUserId if currentUserData is not available
                    filteredOvertimeRecords = overtimeRecords.filter(record => record.employeeId === currentUserId);
                }
            }

            if (!filteredOvertimeRecords || filteredOvertimeRecords.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">No overtime records found.</td></tr>';
                return;
            }

            // Get filter values
            const employeeFilter = document.getElementById('overtime-filter-employee').value;
            const monthFilter = document.getElementById('overtime-filter-month').value;

            // Get current year
            const currentYear = new Date().getFullYear();

            // Filter records
            let filteredRecords = [...filteredOvertimeRecords];

            // Apply employee filter
            if (employeeFilter !== 'all') {
                console.log('Applying overtime employee filter:', employeeFilter);
                filteredRecords = filteredRecords.filter(record => record.employeeId === employeeFilter);
                console.log('Records after overtime employee filter:', filteredRecords.length);
            }

            // Apply month filter
            if (monthFilter !== 'all') {
                const month = parseInt(monthFilter);
                console.log('Filtering overtime for month:', month);
                filteredRecords = filteredRecords.filter(record => {
                    const overtimeDate = new Date(record.date);
                    const recordMonth = overtimeDate.getMonth() + 1;
                    console.log(`Overtime record ${record.id} date: ${record.date}, month: ${recordMonth}`);
                    // Only filter by month, not by year
                    return recordMonth === month;
                });
                console.log('After month filter, overtime count:', filteredRecords.length);
            }

            filteredRecords.sort((a, b) => new Date(b.date) - new Date(a.date));

            filteredRecords.forEach(record => {
                const statusColor = record.status === 'Approved' ? 'bg-green-100 text-green-800' : (record.status === 'Pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800');

                // Get employee name from employees array (handle both field name formats)
                const employee = employees.find(e => e.id === record.employeeId);
                const empName = employee?.fullName || employee?.full_name || record.employeeName || record.employee_name || record.employeeId;

                // Handle both old and new time format
                let timeDisplay;
                if (record.startTime && record.endTime) {
                    timeDisplay = `${record.startTime} - ${record.endTime}`;
                } else if (record.time) {
                    timeDisplay = record.time;
                } else {
                    timeDisplay = 'N/A';
                }

                // Only show action buttons for admin users
                const actionButtons = (currentUserRole === 'admin' || currentUserRole === 'admin_1') ? `
                    <td class="px-4 py-2 whitespace-nowrap text-sm font-medium space-x-2">
                        <button onclick="editOvertimeRecord('${record.id}')" class="text-indigo-600 hover:text-indigo-900" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteOvertimeRecord('${record.id}')" class="text-red-600 hover:text-red-900" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                        ${record.status === 'Pending' ? `
                        <button onclick="approveOvertimeRecord('${record.id}')" class="text-green-600 hover:text-green-900" title="Approve">
                            <i class="fas fa-check"></i>
                        </button>
                        <button onclick="rejectOvertimeRecord('${record.id}')" class="text-red-600 hover:text-red-900" title="Reject">
                            <i class="fas fa-times"></i>
                        </button>
                        ` : ''}
                    </td>
                ` : `<td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">-</td>`;

                const row = `
                    <tr class="hover:bg-gray-50 transition duration-150">
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${empName}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${formatDate(record.date)}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${timeDisplay}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${record.hours} hours</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${record.reason}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                                ${record.status}
                            </span>
                        </td>
                        ${actionButtons}
                    </tr>
                `;
                tableBody.innerHTML += row;
            });

            // Update the overtime summary with the same filters
            // Note: We don't call updateOvertimeSummary here anymore as it's handled by the filter button
            // This prevents double-updating when the filter button is clicked
        }

        // Update overtime summary based on filters
        function updateOvertimeSummary(employeeId = 'all', month = 'all') {
            const currentYear = new Date().getFullYear();

            // Get the elements to update
            const totalMonthElement = document.getElementById('total-overtime-hours-month');
            const totalYearElement = document.getElementById('total-overtime-hours-year');

            if (!totalMonthElement || !totalYearElement) return;

            // Get filtered records based on user role
            let roleFilteredRecords = [];

            if (currentUserRole === 'admin' || currentUserRole === 'admin_1') {
                // Admin and admin_1 see all records
                roleFilteredRecords = overtimeRecords;
            }
            else if (currentUserRole === 'manager') {
                // Manager sees only their team's records
                const teamMemberIds = employees
                    .filter(emp => emp.directManager === currentUserData.fullName)
                    .map(emp => emp.id);

                // Include manager's own records and team members' records
                const managerId = currentUserData ? currentUserData.id : currentUserId;
                roleFilteredRecords = overtimeRecords.filter(record =>
                    teamMemberIds.includes(record.employeeId) || record.employeeId === managerId
                );
            }
            else {
                // Employee sees only their own records
                if (currentUserData && currentUserData.id) {
                    roleFilteredRecords = overtimeRecords.filter(record => record.employeeId === currentUserData.id);
                } else {
                    // Fallback to currentUserId if currentUserData is not available
                    roleFilteredRecords = overtimeRecords.filter(record => record.employeeId === currentUserId);
                }
            }

            // Filter records for the current month
            const currentMonth = new Date().getMonth() + 1;
            let monthlyRecords = roleFilteredRecords.filter(record => {
                const recordDate = new Date(record.date);
                const recordMonth = recordDate.getMonth() + 1;
                console.log(`Overtime record ${record.id} date: ${record.date}, month: ${recordMonth}`);
                // Only filter by month, not by year
                return recordMonth === (month === 'all' ? currentMonth : parseInt(month)) &&
                       (employeeId === 'all' || record.employeeId === employeeId) &&
                       record.status === 'Approved';
            });
            console.log('Monthly overtime records count:', monthlyRecords.length);

            // Filter records for the current year
            let yearlyRecords = roleFilteredRecords.filter(record => {
                const recordDate = new Date(record.date);
                return recordDate.getFullYear() === currentYear &&
                       (employeeId === 'all' || record.employeeId === employeeId) &&
                       record.status === 'Approved';
            });

            // Calculate total hours
            const totalMonthHours = monthlyRecords.reduce((total, record) => total + record.hours, 0);
            const totalYearHours = yearlyRecords.reduce((total, record) => total + record.hours, 0);

            // Update the UI
            totalMonthElement.textContent = totalMonthHours;
            totalYearElement.textContent = totalYearHours;
        }

        // Function to set up employee code validation for overtime filter
        function setupOvertimeFilterEmployeeCodeValidation() {
            const employeeCodeInput = document.getElementById('overtime-filter-employee-code');
            const employeeNameInput = document.getElementById('overtime-filter-employee-name');
            const employeeIdInput = document.getElementById('overtime-filter-employee');
            const applyFiltersButton = document.getElementById('overtime-filter-btn');

            if (!employeeCodeInput || !employeeNameInput || !employeeIdInput || !applyFiltersButton) return;

            employeeCodeInput.addEventListener('input', function() {
                const code = this.value.trim();

                // Reset fields if empty
                if (!code) {
                    employeeNameInput.value = '';
                    employeeIdInput.value = 'all';
                    employeeNameInput.classList.remove('border-green-500', 'border-red-500');
                    return;
                }

                // Find employee by code
                const employee = employees.find(e => e.id.toLowerCase() === code.toLowerCase());

                if (employee) {
                    // Valid employee code - handle both field name formats
                    const employeeName = employee.fullName || employee.full_name || 'Unknown';
                    employeeNameInput.value = employeeName;
                    employeeIdInput.value = employee.id;
                    employeeNameInput.classList.remove('border-red-500');
                    employeeNameInput.classList.add('border-green-500');

                    // Update overtime summary immediately when a valid employee is selected
                    const monthFilter = document.getElementById('overtime-filter-month').value;
                    updateOvertimeSummary(employee.id, monthFilter);
                } else {
                    // Invalid employee code
                    employeeNameInput.value = 'Employee not found';
                    employeeIdInput.value = 'all';
                    employeeNameInput.classList.remove('border-green-500');
                    employeeNameInput.classList.add('border-red-500');
                }
            });

            // Function to reset overtime filters
            function resetOvertimeFilters() {
                // Reset all filter dropdowns to default values
                document.getElementById('overtime-filter-employee-code').value = '';
                document.getElementById('overtime-filter-employee-name').value = '';
                document.getElementById('overtime-filter-employee').value = 'all';
                document.getElementById('overtime-filter-month').value = 'all';

                // Remove any styling from the employee name field
                document.getElementById('overtime-filter-employee-name').classList.remove('border-green-500', 'border-red-500');

                // Repopulate the table with all records
                populateOvertimeTable();
            }

            // Add click event listener to apply filters button
            applyFiltersButton.addEventListener('click', function() {
                console.log('Overtime filter button clicked');
                // Toggle the button color and check if we need to reset
                const wasActive = toggleFilterButtonColor(this, resetOvertimeFilters);
                console.log('Was active:', wasActive);

                // Only apply filters if we're not resetting
                if (!wasActive) {
                    // Get the current filter values
                    const employeeId = document.getElementById('overtime-filter-employee').value;
                    const month = document.getElementById('overtime-filter-month').value;
                    console.log('Applying overtime filters:', { employeeId, month });

                    // Force the filter values to be applied
                    document.getElementById('overtime-filter-employee').value = employeeId;
                    document.getElementById('overtime-filter-month').value = month;

                    // Update both the table and the summary with the same filters
                    populateOvertimeTable();
                    updateOvertimeSummary(employeeId, month);
                }
            });
        }

        // Validate employee code and update employee name for overtime form
        function setupOvertimeEmployeeCodeValidation() {
            const employeeCodeInput = document.getElementById('overtime-employee-code');
            const nameInput = document.getElementById('overtime-employee-name');
            const hiddenEmployeeInput = document.getElementById('overtime-employee');

            if (!employeeCodeInput || !nameInput || !hiddenEmployeeInput) return;

            employeeCodeInput.addEventListener('input', function() {
                const employeeCode = this.value.trim();

                // Reset fields
                nameInput.value = '';
                hiddenEmployeeInput.value = '';

                if (employeeCode) {
                    // Find employee by code
                    const employee = employees.find(e => e.id === employeeCode);

                    if (employee) {
                        // Valid employee code - handle both field name formats
                        const employeeName = employee.fullName || employee.full_name || 'Unknown';
                        nameInput.value = employeeName;
                        hiddenEmployeeInput.value = employee.id;

                        // Add success styling
                        nameInput.classList.remove('bg-red-50');
                        nameInput.classList.add('bg-green-50');
                    } else {
                        // Employee not found, show error styling
                        nameInput.value = 'Employee not found';
                        nameInput.classList.remove('bg-green-50');
                        nameInput.classList.add('bg-red-50');
                    }
                }
            });
        }

        // Set up filter buttons for excuse and penalty sections
        function addFilterButtonsToExcuseAndPenalty() {
            // Function to reset excuse filters
            function resetExcuseFilters() {
                // Reset all filter inputs to default values
                document.getElementById('excuse-filter-employee-code').value = '';
                document.getElementById('excuse-filter-employee-name').value = '';
                document.getElementById('excuse-filter-employee').value = 'all';
                document.getElementById('excuse-filter-month').value = 'all';

                // Remove any styling from the employee name field
                document.getElementById('excuse-filter-employee-name').classList.remove('border-green-500', 'border-red-500');

                // Repopulate the table with all records
                populateExcuseTable();

                // Update the summary with default values
                updateExcuseSummary('all', 'all');
            }

            // Function to reset penalty filters
            function resetPenaltyFilters() {
                // Reset all filter inputs to default values
                document.getElementById('penalty-filter-employee-code').value = '';
                document.getElementById('penalty-filter-employee-name').value = '';
                document.getElementById('penalty-filter-employee').value = 'all';
                document.getElementById('penalty-filter-month').value = 'all';

                // Remove any styling from the employee name field
                document.getElementById('penalty-filter-employee-name').classList.remove('border-green-500', 'border-red-500');

                // Repopulate the table with all records
                populatePenaltyTable();

                // Update the summary with default values
                updatePenaltySummary('all', 'all');
            }

            // Set up excuse filter button
            const excuseFilterBtn = document.getElementById('excuse-filter-btn');
            if (excuseFilterBtn) {
                // Remove any existing event listeners
                const newExcuseFilterBtn = excuseFilterBtn.cloneNode(true);
                excuseFilterBtn.parentNode.replaceChild(newExcuseFilterBtn, excuseFilterBtn);

                // Add event listener
                newExcuseFilterBtn.addEventListener('click', function() {
                    console.log('Excuse filter button clicked');
                    // Toggle the button color and check if we need to reset
                    const wasActive = toggleFilterButtonColor(this, resetExcuseFilters);
                    console.log('Was active:', wasActive);

                    // Only apply filters if we're not resetting
                    if (!wasActive) {
                        // Get the current filter values
                        const employeeId = document.getElementById('excuse-filter-employee').value;
                        const month = document.getElementById('excuse-filter-month').value;
                        console.log('Applying excuse filters:', { employeeId, month });

                        // Force the filter values to be applied
                        document.getElementById('excuse-filter-employee').value = employeeId;
                        document.getElementById('excuse-filter-month').value = month;

                        // Update both the table and the summary with the same filters
                        populateExcuseTable();
                        updateExcuseSummary(employeeId, month);
                    }
                });
            } else {
                console.error('Excuse filter button not found!');
            }

            // Set up penalty filter button
            const penaltyFilterBtn = document.getElementById('penalty-filter-btn');
            if (penaltyFilterBtn) {
                // Remove any existing event listeners
                const newPenaltyFilterBtn = penaltyFilterBtn.cloneNode(true);
                penaltyFilterBtn.parentNode.replaceChild(newPenaltyFilterBtn, penaltyFilterBtn);

                // Add event listener
                newPenaltyFilterBtn.addEventListener('click', function() {
                    console.log('Penalty filter button clicked');
                    // Toggle the button color and check if we need to reset
                    const wasActive = toggleFilterButtonColor(this, resetPenaltyFilters);
                    console.log('Was active:', wasActive);

                    // Only apply filters if we're not resetting
                    if (!wasActive) {
                        // Get the current filter values
                        const employeeId = document.getElementById('penalty-filter-employee').value;
                        const month = document.getElementById('penalty-filter-month').value;
                        console.log('Applying penalty filters:', { employeeId, month });

                        // Force the filter values to be applied
                        document.getElementById('penalty-filter-employee').value = employeeId;
                        document.getElementById('penalty-filter-month').value = month;

                        // Update both the table and the summary with the same filters
                        populatePenaltyTable();
                        updatePenaltySummary(employeeId, month);
                    }
                });
            } else {
                console.error('Penalty filter button not found!');
            }

            // Set up salary filter button
            const salaryFilterBtn = document.getElementById('salary-filter-btn');
            if (salaryFilterBtn) {
                // Remove any existing event listeners
                const newSalaryFilterBtn = salaryFilterBtn.cloneNode(true);
                salaryFilterBtn.parentNode.replaceChild(newSalaryFilterBtn, salaryFilterBtn);

                // Add event listener
                newSalaryFilterBtn.addEventListener('click', function() {
                    console.log('Salary filter button clicked');
                    // Toggle the button color and check if we need to reset
                    const wasActive = toggleFilterButtonColor(this, resetSalaryFilters);
                    console.log('Was active:', wasActive);

                    // Only apply filters if we're not resetting
                    if (!wasActive) {
                        // Get the current filter values
                        const employeeId = document.getElementById('salary-filter-employee').value;
                        console.log('Applying salary filters:', { employeeId });

                        // Force the filter values to be applied
                        document.getElementById('salary-filter-employee').value = employeeId;

                        // Update the table with the filters
                        populateSalaryTable();
                    }
                });
            } else {
                console.error('Salary filter button not found!');
            }

            // Remove onchange event listeners
            document.getElementById('excuse-filter-employee')?.removeAttribute('onchange');
            document.getElementById('excuse-filter-month')?.removeAttribute('onchange');
            document.getElementById('penalty-filter-employee')?.removeAttribute('onchange');
            document.getElementById('penalty-filter-month')?.removeAttribute('onchange');
        }

        // --- Salary Details Functions ---

        // Handle salary form submission
        async function handleSalaryFormSubmit(event) {
            event.preventDefault();
            console.log('Salary form submitted');

            const employeeCode = document.getElementById('salary-employee-code').value.trim();
            const employeeId = document.getElementById('salary-employee').value;
            const totalSalary = parseFloat(document.getElementById('salary-total').value);
            const basicSalary = parseFloat(document.getElementById('salary-basic').value);
            const fixedAllowance = parseFloat(document.getElementById('salary-allowance').value) || 0;
            const fixedDeduction = parseFloat(document.getElementById('salary-deduction').value) || 0;
            const bankName = document.getElementById('salary-bank').value.trim();
            const accountNumber = document.getElementById('salary-account').value.trim();
            const editId = document.getElementById('salary-edit-id')?.value;

            console.log('Form data:', {
                employeeCode,
                employeeId,
                totalSalary,
                basicSalary,
                fixedAllowance,
                fixedDeduction,
                bankName,
                accountNumber,
                editId
            });

            if (!employeeCode) {
                showMessage('Please enter employee code.', 'error');
                return;
            }

            if (!employeeId) {
                showMessage('Invalid employee code. Please enter a valid employee code.', 'error');
                return;
            }

            const employee = employees.find(e => e.id === employeeId);
            if (!employee) {
                showMessage('Selected employee not found.', 'error');
                return;
            }

            // Validate that the employee is active
            if (employee.status !== 'Active') {
                showMessage('Cannot add salary details for inactive employees.', 'error');
                return;
            }

            // Check if we're editing an existing record
            if (editId) {
                // Find the existing record
                const recordIndex = salaryRecords.findIndex(r => r.id == editId);
                if (recordIndex === -1) {
                    showMessage('Record not found.', 'error');
                    return;
                }

                // Update the record
                salaryRecords[recordIndex] = {
                    ...salaryRecords[recordIndex],
                    employeeId: employeeId,
                    employeeName: employee.fullName,
                    totalSalary: totalSalary,
                    basicSalary: basicSalary,
                    fixedAllowance: fixedAllowance,
                    fixedDeduction: fixedDeduction,
                    bankName: bankName,
                    accountNumber: accountNumber
                };

                // Remove the edit ID field
                document.getElementById('salary-edit-id').remove();

                // Change the submit button text back
                const submitBtn = document.querySelector('#salary-form button[type="submit"]');
                if (submitBtn) {
                    submitBtn.textContent = 'Save Salary Details';
                }

                // Remove the cancel button
                const cancelBtn = document.getElementById('salary-cancel-edit');
                if (cancelBtn) {
                    cancelBtn.remove();
                }

                showMessage('Salary details updated successfully!');
            } else {
                // Check if salary details already exist for this employee
                const existingSalary = salaryRecords.find(sr => sr.employeeId === employeeId);
                if (existingSalary) {
                    // Instead of showing an error, we'll update the existing record
                    existingSalary.totalSalary = totalSalary;
                    existingSalary.basicSalary = basicSalary;
                    existingSalary.fixedAllowance = fixedAllowance;
                    existingSalary.fixedDeduction = fixedDeduction;
                    existingSalary.bankName = bankName;
                    existingSalary.accountNumber = accountNumber;

                    showMessage('Existing salary details updated successfully!');
                } else {
                    // Create new salary record for Supabase
                    const supabaseSalaryData = {
                        employee_id: employeeId,
                        employee_name: employee.fullName || employee.full_name,
                        total_salary: totalSalary,
                        basic_salary: basicSalary,
                        fixed_allowance: fixedAllowance,
                        fixed_deduction: fixedDeduction,
                        bank_name: bankName,
                        account_number: accountNumber
                    };

                    // Save to Supabase
                    const { data, error } = await dbHelpers.addSalary(supabaseSalaryData);
                    if (error) {
                        console.error('Error saving salary to Supabase:', error);
                        showMessage(`Error saving salary: ${error.message}`, 'error');
                        return;
                    }

                    console.log('Salary saved to Supabase:', data);

                    // Also add to local array for immediate UI update
                    const newSalary = {
                        id: data.id,
                        employeeId: employeeId,
                        employeeName: employee.fullName || employee.full_name,
                        totalSalary: totalSalary,
                        basicSalary: basicSalary,
                        fixedAllowance: fixedAllowance,
                        fixedDeduction: fixedDeduction,
                        bankName: bankName,
                        accountNumber: accountNumber
                    };

                    // Add to records
                    if (!salaryRecords) {
                        console.log('Initializing empty salary records array');
                        salaryRecords = [];
                    }
                    salaryRecords.push(newSalary);
                    console.log('Updated salary records:', salaryRecords);

                    showMessage('Salary details added successfully!');
                }
            }

            // Data is now automatically saved to Supabase

            // Update UI
            populateSalaryTable();

            // Reset form
            document.getElementById('salary-form').reset();
            document.getElementById('salary-employee-name').value = '';

            // Hide the form container
            document.getElementById('salary-form-container').classList.add('hidden');
        }

        // Populate salary table
        function populateSalaryTable() {
            const tableBody = document.getElementById('salaryTableBody');
            if (!tableBody) {
                console.error('Salary table body not found!');
                return;
            }
            tableBody.innerHTML = '';

            console.log('Populating salary table...');
            console.log('Total employees:', employees.length);

            // Get filter values
            const employeeFilter = document.getElementById('salary-filter-employee')?.value || 'all';
            console.log('Employee filter:', employeeFilter);

            // Get ALL employees (not just active ones) to show all salary records
            let allEmployees = [...employees];
            console.log('All employees:', allEmployees.length, allEmployees);

            // Apply employee filter if specified
            if (employeeFilter !== 'all') {
                allEmployees = allEmployees.filter(emp => emp.id === employeeFilter);
                console.log('After employee filter, employees:', allEmployees.length);
            }

            // Sort employees by name (handle both fullName and full_name)
            allEmployees.sort((a, b) => {
                const nameA = a.fullName || a.full_name || '';
                const nameB = b.fullName || b.full_name || '';
                return nameA.localeCompare(nameB);
            });

            if (allEmployees.length === 0) {
                console.warn('No employees found to display in salary table');
                tableBody.innerHTML = '<tr><td colspan="9" class="text-center py-4 text-gray-500">No employees found.</td></tr>';
                return;
            }

            // Check salary records
            console.log('Salary records:', salaryRecords);

            // Populate table with ALL employees (show salary records for both active and inactive)
            allEmployees.forEach(employee => {
                // Check if employee has salary record
                const salaryRecord = salaryRecords.find(sr => sr.employeeId === employee.id);
                const employeeName = employee.fullName || employee.full_name || 'Unknown';
                console.log(`Checking salary for ${employee.id} (${employeeName}):`, salaryRecord);

                if (salaryRecord) {
                    // Employee has salary record - show full details
                    const statusBadge = employee.status === 'Active'
                        ? '<span class="px-2 py-1 text-xs bg-green-100 text-green-800 rounded-full">Active</span>'
                        : '<span class="px-2 py-1 text-xs bg-red-100 text-red-800 rounded-full">Inactive</span>';

                    const row = `
                        <tr class="hover:bg-gray-50 transition duration-150 ${employee.status !== 'Active' ? 'bg-gray-50' : ''}">
                            <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${employee.id}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${employeeName} ${statusBadge}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${salaryRecord.totalSalary.toFixed(2)}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${salaryRecord.basicSalary.toFixed(2)}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${salaryRecord.fixedAllowance.toFixed(2)}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${(salaryRecord.fixedDeduction || 0).toFixed(2)}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${salaryRecord.bankName || 'N/A'}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${salaryRecord.accountNumber || 'N/A'}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm font-medium space-x-2">
                                <button onclick="editSalaryRecord(${salaryRecord.id})" class="text-indigo-600 hover:text-indigo-900" title="Edit"><i class="fas fa-edit"></i></button>
                                <button onclick="deleteSalaryRecord(${salaryRecord.id})" class="text-red-600 hover:text-red-900" title="Delete"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                } else {
                    // Employee has no salary record - show empty fields with Add button (only for active employees)
                    const statusBadge = employee.status === 'Active'
                        ? '<span class="px-2 py-1 text-xs bg-green-100 text-green-800 rounded-full">Active</span>'
                        : '<span class="px-2 py-1 text-xs bg-red-100 text-red-800 rounded-full">Inactive</span>';

                    const addButton = employee.status === 'Active'
                        ? `<button onclick="addSalaryForEmployee('${employee.id}')" class="text-green-600 hover:text-green-900" title="Add Salary Details">
                               <i class="fas fa-plus-circle"></i> Add
                           </button>`
                        : '<span class="text-gray-400">No salary (Inactive)</span>';

                    const row = `
                        <tr class="hover:bg-gray-50 transition duration-150 bg-gray-50 ${employee.status !== 'Active' ? 'opacity-75' : ''}">
                            <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${employee.id}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${employeeName} ${statusBadge}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-400 italic">Not set</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-400 italic">Not set</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-400 italic">Not set</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-400 italic">Not set</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-400 italic">Not set</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-400 italic">Not set</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm font-medium">
                                ${addButton}
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                }
            });
        }

        // Function to add salary for a specific employee
        function addSalaryForEmployee(employeeId) {
            const employee = employees.find(e => e.id === employeeId);
            if (!employee) {
                showMessage('Employee not found.', 'error');
                return;
            }

            // Populate the form with employee details
            const employeeName = employee.fullName || employee.full_name || 'Unknown';
            document.getElementById('salary-employee-code').value = employee.id;
            document.getElementById('salary-employee-name').value = employeeName;
            document.getElementById('salary-employee').value = employee.id;

            // Show the form
            document.getElementById('salary-form-container').classList.remove('hidden');
            document.getElementById('salary-form').scrollIntoView({ behavior: 'smooth' });
        }

        // Edit salary record
        function editSalaryRecord(recordId) {
            const record = salaryRecords.find(sr => sr.id == recordId);
            if (!record) {
                showMessage('Record not found.', 'error');
                return;
            }

            // Populate the salary form with the record data
            document.getElementById('salary-employee-code').value = record.employeeId;
            document.getElementById('salary-employee-name').value = record.employeeName;
            document.getElementById('salary-employee').value = record.employeeId;
            document.getElementById('salary-total').value = record.totalSalary;
            document.getElementById('salary-basic').value = record.basicSalary;
            document.getElementById('salary-allowance').value = record.fixedAllowance || '';
            document.getElementById('salary-deduction').value = record.fixedDeduction || '';
            document.getElementById('salary-bank').value = record.bankName || '';
            document.getElementById('salary-account').value = record.accountNumber || '';

            // Show the salary section and make the form visible
            showSection('salary');
            document.getElementById('salary-form-container').classList.remove('hidden');
            document.getElementById('salary-form').scrollIntoView({ behavior: 'smooth' });

            // Add a hidden field to track that we're editing
            let editIdField = document.getElementById('salary-edit-id');
            if (!editIdField) {
                editIdField = document.createElement('input');
                editIdField.type = 'hidden';
                editIdField.id = 'salary-edit-id';
                document.getElementById('salary-form').appendChild(editIdField);
            }
            editIdField.value = recordId;

            // Change the submit button text
            const submitBtn = document.querySelector('#salary-form button[type="submit"]');
            if (submitBtn) {
                submitBtn.textContent = 'Update Salary Details';
            }

            // Add a cancel button if it doesn't exist
            if (!document.getElementById('salary-cancel-edit')) {
                const cancelBtn = document.createElement('button');
                cancelBtn.type = 'button';
                cancelBtn.id = 'salary-cancel-edit';
                cancelBtn.className = 'mt-3 w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-md shadow transition duration-150';
                cancelBtn.textContent = 'Cancel Edit';
                cancelBtn.onclick = function() {
                    document.getElementById('salary-form').reset();
                    document.getElementById('salary-employee-name').value = '';
                    document.getElementById('salary-edit-id').remove();
                    this.remove();

                    // Change the submit button text back
                    const submitBtn = document.querySelector('#salary-form button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.textContent = 'Save Salary Details';
                    }

                    // Hide the form
                    document.getElementById('salary-form-container').classList.add('hidden');
                };

                document.getElementById('salary-form').appendChild(cancelBtn);
            }
        }

        // Delete salary record
        async function deleteSalaryRecord(recordId) {
            if (!confirm('Are you sure you want to delete this salary record? This action cannot be undone.')) {
                return;
            }

            try {
                // Delete from Supabase
                const { data, error } = await dbHelpers.deleteSalary(recordId);
                if (error) {
                    console.error('Error deleting salary from Supabase:', error);
                    showMessage(`Error deleting salary: ${error.message}`, 'error');
                    return;
                }

                console.log('Salary deleted from Supabase:', data);

                // Remove from local array
                const index = salaryRecords.findIndex(sr => sr.id == recordId);
                if (index !== -1) {
                    salaryRecords.splice(index, 1);
                }

                populateSalaryTable();
                showMessage('Salary record deleted successfully!');
            } catch (error) {
                console.error('Error in deleteSalaryRecord:', error);
                showMessage(`Error deleting salary: ${error.message}`, 'error');
            }
        }

        // Setup salary filter employee code validation
        function setupSalaryFilterEmployeeCodeValidation() {
            const employeeCodeInput = document.getElementById('salary-filter-employee-code');
            const employeeNameInput = document.getElementById('salary-filter-employee-name');
            const employeeIdInput = document.getElementById('salary-filter-employee');

            if (!employeeCodeInput || !employeeNameInput || !employeeIdInput) return;

            // Add input event listener to validate employee code
            employeeCodeInput.addEventListener('input', function() {
                const code = this.value.trim();

                // Reset fields if empty
                if (code === '') {
                    employeeNameInput.value = '';
                    employeeIdInput.value = 'all';
                    employeeNameInput.classList.remove('border-green-500', 'border-red-500');
                    return;
                }

                // Find employee by code
                const employee = employees.find(e => e.id.toLowerCase() === code.toLowerCase());

                if (employee) {
                    // Valid employee code - handle both field name formats
                    const employeeName = employee.fullName || employee.full_name || 'Unknown';
                    employeeNameInput.value = employeeName;
                    employeeIdInput.value = employee.id;
                    employeeNameInput.classList.remove('border-red-500');
                    employeeNameInput.classList.add('border-green-500');
                } else {
                    // Invalid employee code
                    employeeNameInput.value = 'Employee not found';
                    employeeIdInput.value = 'all';
                    employeeNameInput.classList.remove('border-green-500');
                    employeeNameInput.classList.add('border-red-500');
                }
            });
        }

        // Validate employee code and update employee name for salary form
        function setupSalaryEmployeeCodeValidation() {
            const employeeCodeInput = document.getElementById('salary-employee-code');
            const nameInput = document.getElementById('salary-employee-name');
            const hiddenEmployeeInput = document.getElementById('salary-employee');

            if (!employeeCodeInput || !nameInput || !hiddenEmployeeInput) return;

            employeeCodeInput.addEventListener('input', function() {
                const employeeCode = this.value.trim();

                // Reset fields
                nameInput.value = '';
                hiddenEmployeeInput.value = '';

                if (!employeeCode) return;

                // Find employee by code
                const employee = employees.find(e => e.id.toLowerCase() === employeeCode.toLowerCase());

                if (employee) {
                    // Valid employee code - handle both field name formats
                    const employeeName = employee.fullName || employee.full_name || 'Unknown';
                    nameInput.value = employeeName;
                    hiddenEmployeeInput.value = employee.id;
                    nameInput.classList.remove('border-red-500');
                    nameInput.classList.add('border-green-500');

                    // Check if employee is active
                    if (employee.status !== 'Active') {
                        showMessage('Warning: This employee is not active.', 'error');
                    }
                } else {
                    // Invalid employee code
                    nameInput.value = 'Employee not found';
                    nameInput.classList.remove('border-green-500');
                    nameInput.classList.add('border-red-500');
                }
            });
        }

        // Function to reset salary filters
        function resetSalaryFilters() {
            // Reset all filter inputs to default values
            document.getElementById('salary-filter-employee-code').value = '';
            document.getElementById('salary-filter-employee-name').value = '';
            document.getElementById('salary-filter-employee').value = 'all';

            // Remove any styling from the employee name field
            document.getElementById('salary-filter-employee-name').classList.remove('border-green-500', 'border-red-500');

            // Repopulate the table with all records
            populateSalaryTable();
        }

        // Populate excuse table
        function populateExcuseTable() {
            const tableBody = document.getElementById('excuseTableBody');
            if (!tableBody) return;
            tableBody.innerHTML = '';

            // Filter records based on user role
            let filteredExcuseRecords = [];

            if (currentUserRole === 'admin' || currentUserRole === 'admin_1') {
                // Admin and admin_1 see all records
                filteredExcuseRecords = excuseRecords;
            }
            else if (currentUserRole === 'manager') {
                // Manager sees only their team's records
                const managerName = currentUserData.fullName || currentUserData.full_name;
                const teamMemberIds = employees
                    .filter(emp => {
                        const empManager = emp.directManager || emp.direct_manager;
                        return empManager === managerName;
                    })
                    .map(emp => emp.id);

                console.log('DEBUG Excuse Filter - Manager:', managerName, 'Team IDs:', teamMemberIds);

                // Include manager's own records and team members' records
                const managerId = currentUserData ? currentUserData.id : currentUserId;
                filteredExcuseRecords = excuseRecords.filter(record =>
                    teamMemberIds.includes(record.employeeId) || record.employeeId === managerId
                );
            }
            else {
                // Employee sees only their own records
                if (currentUserData && currentUserData.id) {
                    filteredExcuseRecords = excuseRecords.filter(record => record.employeeId === currentUserData.id);
                } else {
                    // Fallback to currentUserId if currentUserData is not available
                    filteredExcuseRecords = excuseRecords.filter(record => record.employeeId === currentUserId);
                }
            }

            if (!filteredExcuseRecords || filteredExcuseRecords.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">No excuse records found.</td></tr>';
                return;
            }

            // Get filter values
            const employeeFilter = document.getElementById('excuse-filter-employee').value;
            const monthFilter = document.getElementById('excuse-filter-month').value;

            console.log('Populating excuse table with filters:', { employeeFilter, monthFilter });

            // Get current year
            const currentYear = new Date().getFullYear();

            // Filter records
            let filteredRecords = [...filteredExcuseRecords];
            console.log('Total excuse records before filtering:', filteredRecords.length);

            // Apply employee filter
            if (employeeFilter !== 'all') {
                console.log('Applying employee filter:', employeeFilter);
                filteredRecords = filteredRecords.filter(record => record.employeeId === employeeFilter);
                console.log('Records after employee filter:', filteredRecords.length);
            }

            // Filter for current year
            filteredRecords = filteredRecords.filter(record => {
                const excuseDate = new Date(record.date);
                return excuseDate.getFullYear() === currentYear;
            });
            console.log('After year filter, excuses count:', filteredRecords.length);

            // Apply month filter
            if (monthFilter !== 'all') {
                const month = parseInt(monthFilter);
                console.log('Filtering excuses for month:', month);
                filteredRecords = filteredRecords.filter(record => {
                    const excuseDate = new Date(record.date);
                    const recordMonth = excuseDate.getMonth() + 1;
                    console.log(`Excuse record ${record.id} date: ${record.date}, month: ${recordMonth}`);
                    return recordMonth === month;
                });
                console.log('After month filter, excuses count:', filteredRecords.length);
            }

            filteredRecords.sort((a, b) => new Date(b.date) - new Date(a.date));

            filteredRecords.forEach(record => {
                const statusColor = record.status === 'Approved' ? 'bg-green-100 text-green-800' : (record.status === 'Pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800');

                // Handle both old and new time format
                let timeDisplay;
                if (record.startTime && record.endTime) {
                    timeDisplay = `${record.startTime} - ${record.endTime}`;
                } else if (record.time) {
                    timeDisplay = record.time;
                } else {
                    timeDisplay = 'N/A';
                }

                // Only show action buttons for admin users
                const actionButtons = (currentUserRole === 'admin' || currentUserRole === 'admin_1') ? `
                    <td class="px-4 py-2 whitespace-nowrap text-sm font-medium space-x-2">
                        <button onclick="editExcuseRecord('${record.id}')" class="text-indigo-600 hover:text-indigo-900" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteExcuseRecord('${record.id}')" class="text-red-600 hover:text-red-900" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                        ${record.status === 'Pending' ? `
                        <button onclick="approveExcuseRecord('${record.id}')" class="text-green-600 hover:text-green-900" title="Approve">
                            <i class="fas fa-check"></i>
                        </button>
                        <button onclick="rejectExcuseRecord('${record.id}')" class="text-red-600 hover:text-red-900" title="Reject">
                            <i class="fas fa-times"></i>
                        </button>
                        ` : ''}
                    </td>
                ` : `<td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">-</td>`;

                const row = `
                    <tr class="hover:bg-gray-50 transition duration-150">
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${record.employeeName}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${formatDate(record.date)}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${record.type}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${timeDisplay}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${record.reason}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                                ${record.status}
                            </span>
                        </td>
                        ${actionButtons}
                    </tr>
                `;
                tableBody.innerHTML += row;
            });

            // Update the excuse summary with the same filters
            // Note: We don't call updateExcuseSummary here anymore as it's handled by the filter button
            // This prevents double-updating when the filter button is clicked
        }

        // Populate penalty table
        function populatePenaltyTable() {
            const tableBody = document.getElementById('penaltyTableBody');
            if (!tableBody) return;
            tableBody.innerHTML = '';

            if (!penaltyRecords || penaltyRecords.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">No penalty records found.</td></tr>';
                return;
            }

            // Get filter values
            const employeeFilter = document.getElementById('penalty-filter-employee').value;
            const monthFilter = document.getElementById('penalty-filter-month').value;

            console.log('Populating penalty table with filters:', { employeeFilter, monthFilter });

            // Get current year
            const currentYear = new Date().getFullYear();

            // Filter records
            let filteredRecords = [...penaltyRecords];
            console.log('Total penalty records before filtering:', filteredRecords.length);

            // Apply employee filter
            if (employeeFilter !== 'all') {
                console.log('Applying employee filter:', employeeFilter);
                filteredRecords = filteredRecords.filter(record => record.employeeId === employeeFilter);
                console.log('Records after employee filter:', filteredRecords.length);
            }

            // Filter for current year
            filteredRecords = filteredRecords.filter(record => {
                const penaltyDate = new Date(record.date);
                return penaltyDate.getFullYear() === currentYear;
            });
            console.log('After year filter, penalties count:', filteredRecords.length);

            // Apply month filter
            if (monthFilter !== 'all') {
                const month = parseInt(monthFilter);
                console.log('Filtering penalties for month:', month);
                filteredRecords = filteredRecords.filter(record => {
                    const penaltyDate = new Date(record.date);
                    const recordMonth = penaltyDate.getMonth() + 1;
                    console.log(`Penalty record ${record.id} date: ${record.date}, month: ${recordMonth}`);
                    return recordMonth === month;
                });
                console.log('After month filter, penalties count:', filteredRecords.length);
            }

            filteredRecords.sort((a, b) => new Date(b.date) - new Date(a.date));

            filteredRecords.forEach(record => {
                // Format days display to show "0.5" as "Half Day"
                let daysDisplay = record.days;
                if (record.days === 0.5) {
                    daysDisplay = '<span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">Half Day</span>';
                }

                // Determine status color
                const statusColor = record.status === 'Approved' ? 'bg-green-100 text-green-800' : (record.status === 'Pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800');

                // Get employee name with proper field name handling
                const employee = employees.find(e => e.id === record.employeeId);
                const employeeName = employee?.fullName || employee?.full_name || record.employeeName || record.employee_name || 'Unknown Employee';

                // Only show action buttons for admin users
                const actionButtons = (currentUserRole === 'admin' || currentUserRole === 'admin_1') ? `
                    <td class="px-4 py-2 whitespace-nowrap text-sm font-medium space-x-2">
                        <button onclick="editPenaltyRecord('${record.id}')" class="text-indigo-600 hover:text-indigo-900" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deletePenaltyRecord('${record.id}')" class="text-red-600 hover:text-red-900" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                ` : `<td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">-</td>`;

                const row = `
                    <tr class="hover:bg-gray-50 transition duration-150">
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${employeeName}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${formatDate(record.date)}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${daysDisplay}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${record.reason}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                                ${record.status || 'Pending'}
                            </span>
                        </td>
                        ${actionButtons}
                    </tr>
                `;
                tableBody.innerHTML += row;
            });

            // Update the penalty summary with the same filters
            // Note: We don't call updatePenaltySummary here anymore as it's handled by the filter button
            // This prevents double-updating when the filter button is clicked
        }

        // Update excuse summary based on filters
        function updateExcuseSummary(employeeId = 'all', month = 'all') {
            console.log('Updating excuse summary with filters:', { employeeId, month });
            const currentYear = new Date().getFullYear();

            // Get the elements to update
            const totalMonthElement = document.getElementById('total-excuses-month');
            const totalYearElement = document.getElementById('total-excuses-year');

            if (!totalMonthElement || !totalYearElement) return;

            // Filter records based on parameters
            let filteredRecords = [...excuseRecords];
            console.log('Total excuse records:', filteredRecords.length);

            // Apply employee filter
            if (employeeId !== 'all') {
                console.log('Filtering for employee:', employeeId);
                filteredRecords = filteredRecords.filter(record => record.employeeId === employeeId);
                console.log('After employee filter, records count:', filteredRecords.length);
            }

            // Filter for current year only
            filteredRecords = filteredRecords.filter(record => {
                const date = new Date(record.date);
                return date.getFullYear() === currentYear;
            });
            console.log('After year filter, records count:', filteredRecords.length);

            // Calculate total for the selected month (or current month if none selected)
            let selectedMonth = month !== 'all' ? parseInt(month) : new Date().getMonth() + 1;
            console.log('Selected month for summary:', selectedMonth);

            // Calculate total excuses for the selected month (current year only)
            const totalMonthExcuses = filteredRecords
                .filter(er => {
                    const date = new Date(er.date);
                    const recordMonth = date.getMonth() + 1;
                    console.log(`Record ${er.id} date: ${er.date}, month: ${recordMonth}`);
                    return recordMonth === selectedMonth;
                }).length;
            console.log('Total month excuses:', totalMonthExcuses);

            // Calculate total excuses for the current year
            const totalYearExcuses = filteredRecords.length;
            console.log('Total year excuses:', totalYearExcuses);

            // Update the summary display
            totalMonthElement.textContent = totalMonthExcuses;
            totalYearElement.textContent = totalYearExcuses;

            // Update the month label to show which month is being displayed
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            const monthLabel = document.querySelector('.bg-blue-50 h3');

            if (monthLabel) {
                if (month !== 'all') {
                    monthLabel.textContent = `${monthNames[selectedMonth - 1]} ${currentYear} Excuses`;
                } else {
                    monthLabel.textContent = 'Current Month Excuses';
                }
            }
        }

        // --- Record Management Functions ---

        // Edit leave record
        function editLeaveRecord(recordId) {
            // Find the record
            const record = leaveRecords.find(r => r.id == recordId);
            if (!record) {
                showMessage('Record not found.', 'error');
                return;
            }

            // Populate the leave form with the record data
            document.getElementById('leave-employee-code').value = record.employeeId;
            document.getElementById('leave-employee-name').value = record.employeeName;
            document.getElementById('leave-employee').value = record.employeeId;

            // Set the leave balance (calculated dynamically)
            const employee = employees.find(e => e.id === record.employeeId);
            if (employee) {
                const remainingBalance = calculateRemainingLeaveBalance(record.employeeId);
                document.getElementById('leave-balance').value = parseFloat(remainingBalance).toFixed(1);
            }

            // Set the dates
            document.getElementById('leave-start-date').value = record.startDate;
            document.getElementById('leave-end-date').value = record.endDate;

            // Set the days
            const daysSelect = document.getElementById('leave-days');
            for (let i = 0; i < daysSelect.options.length; i++) {
                if (parseFloat(daysSelect.options[i].value) === record.days) {
                    daysSelect.selectedIndex = i;
                    break;
                }
            }

            // Set the type
            const typeSelect = document.getElementById('leave-type');
            for (let i = 0; i < typeSelect.options.length; i++) {
                if (typeSelect.options[i].text === record.type) {
                    typeSelect.selectedIndex = i;
                    break;
                }
            }

            // Show the leave section and make the form visible
            showSection('leaves');
            document.getElementById('leave-form-container').classList.remove('hidden');
            document.getElementById('leave-form').scrollIntoView({ behavior: 'smooth' });

            // Add a hidden field to track that we're editing
            let editIdField = document.getElementById('leave-edit-id');
            if (!editIdField) {
                editIdField = document.createElement('input');
                editIdField.type = 'hidden';
                editIdField.id = 'leave-edit-id';
                document.getElementById('leave-form').appendChild(editIdField);
            }
            editIdField.value = recordId;

            // Change the submit button text
            const submitBtn = document.querySelector('#leave-form button[type="submit"]');
            if (submitBtn) {
                submitBtn.textContent = 'Update Leave Record';
            }

            // Add a cancel button if it doesn't exist
            if (!document.getElementById('leave-cancel-edit')) {
                const cancelBtn = document.createElement('button');
                cancelBtn.id = 'leave-cancel-edit';
                cancelBtn.type = 'button';
                cancelBtn.className = 'px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition duration-150';
                cancelBtn.textContent = 'Cancel';
                cancelBtn.onclick = cancelLeaveEdit;
                submitBtn.parentNode.insertBefore(cancelBtn, submitBtn);
            }
        }

        // Cancel leave edit
        function cancelLeaveEdit() {
            // Reset the form
            document.getElementById('leave-form').reset();
            document.getElementById('leave-employee-name').value = '';
            document.getElementById('leave-balance').value = '';

            // Remove the edit ID field
            const editIdField = document.getElementById('leave-edit-id');
            if (editIdField) {
                editIdField.remove();
            }

            // Change the submit button text back
            const submitBtn = document.querySelector('#leave-form button[type="submit"]');
            if (submitBtn) {
                submitBtn.textContent = 'Submit Leave Request';
            }

            // Remove the cancel button
            const cancelBtn = document.getElementById('leave-cancel-edit');
            if (cancelBtn) {
                cancelBtn.remove();
            }

            // Hide the form container
            document.getElementById('leave-form-container').classList.add('hidden');
        }

        // Approve leave record
        async function approveLeaveRecord(recordId) {
            // Find the record
            const record = leaveRecords.find(r => r.id == recordId);
            if (!record) {
                showMessage('Record not found.', 'error');
                return;
            }

            // Check if already approved to prevent double deduction
            if (record.status === 'Approved') {
                showMessage('This leave request is already approved.', 'warning');
                return;
            }

            console.log('Approving leave record:', record);

            // If it's an annual leave, check balance but DON'T update employee table
            const leaveType = record.type.toLowerCase();
            if (leaveType.includes('annual')) {
                console.log('This is an annual leave type:', leaveType);

                // Find the employee
                const employee = employees.find(e => e.id === record.employeeId);
                if (employee) {
                    console.log('Found employee:', employee);

                    // Get the ORIGINAL balance from employee table (this stays unchanged)
                    const originalBalance = employee.annualLeaveBalance ?? employee.annual_leave_balance ?? 0;
                    if (originalBalance === null || originalBalance === undefined || originalBalance === 0) {
                        showMessage(`Cannot approve leave: Employee has no leave balance set. Please set a leave balance first.`, 'error');
                        return;
                    }

                    // Calculate CURRENT remaining balance dynamically
                    const approvedAnnualLeaves = leaveRecords.filter(r =>
                        r.employeeId === record.employeeId &&
                        r.status === 'Approved' &&
                        r.type.toLowerCase().includes('annual') &&
                        r.id !== recordId // Exclude current record being approved
                    );

                    const totalUsedDays = approvedAnnualLeaves.reduce((sum, leave) => sum + parseFloat(leave.days), 0);
                    const currentRemainingBalance = originalBalance - totalUsedDays;

                    console.log(`Original balance: ${originalBalance}`);
                    console.log(`Previously used days: ${totalUsedDays}`);
                    console.log(`Current remaining balance: ${currentRemainingBalance}`);

                    // Parse the leave days as a float to ensure proper calculation
                    const leaveDays = parseFloat(record.days);
                    console.log('Leave days to approve:', leaveDays);

                    // Check if employee has sufficient remaining balance
                    if (currentRemainingBalance < leaveDays) {
                        showMessage(`Cannot approve leave: Insufficient leave balance (${currentRemainingBalance.toFixed(1)} days remaining). Requested: ${leaveDays} days.`, 'error');
                        return;
                    }

                    // DON'T update employee table balance - it stays as the original allocation
                    console.log(` Leave approved. Employee table balance stays: ${originalBalance}`);
                    console.log(` Calculated remaining balance after approval: ${(currentRemainingBalance - leaveDays).toFixed(1)}`);

                    showMessage(`Leave request approved. Employee will have ${(currentRemainingBalance - leaveDays).toFixed(1)} day(s) remaining from original ${originalBalance} day allocation.`);
                } else {
                    showMessage('Employee not found. Cannot validate leave balance.', 'warning');
                    return;
                }
            } else {
                console.log('This is NOT an annual leave type:', leaveType);
                showMessage(`Leave request for ${record.employeeName} has been approved.`);
            }

            // Update status in Supabase
            try {
                const { data, error } = await dbHelpers.updateLeaveStatus(recordId, 'Approved');
                if (error) {
                    console.error('Error approving leave in Supabase:', error);
                    showMessage(`Error approving leave: ${error.message}`, 'error');
                    return;
                }

                console.log('Leave approved in Supabase:', data);

                // Update the status locally
                record.status = 'Approved';

                // Reload employee data to ensure balance sync
                await loadSavedData();

                // Update the UI
                populateLeaveTable();
                updateDashboard();
            } catch (error) {
                console.error('Error in approveLeaveRecord:', error);
                showMessage(`Error approving leave: ${error.message}`, 'error');
            }
        }

        // Reject leave record
        async function rejectLeaveRecord(recordId) {
            if (!confirm('Are you sure you want to reject this leave request?')) {
                return;
            }

            // Find the record
            const record = leaveRecords.find(r => r.id == recordId);
            if (!record) {
                showMessage('Record not found.', 'error');
                return;
            }

            console.log('Rejecting leave record:', record);

            // Note: We don't update employee table balance anymore
            // Balance is calculated dynamically based on approved leave records
            const leaveType = record.type.toLowerCase();
            if (leaveType.includes('annual')) {
                console.log('Annual leave rejected - balance calculation is dynamic');
                showMessage(`Annual leave request for ${record.employeeName} has been rejected. Balance calculation is dynamic.`);
            } else {
                console.log('This is NOT an annual leave type:', leaveType);
                showMessage(`Leave request for ${record.employeeName} has been rejected.`);
            }

            // Update status in Supabase
            try {
                const { data, error } = await dbHelpers.updateLeaveStatus(recordId, 'Rejected');
                if (error) {
                    console.error('Error rejecting leave in Supabase:', error);
                    showMessage(`Error rejecting leave: ${error.message}`, 'error');
                    return;
                }

                console.log('Leave rejected in Supabase:', data);

                // Update the status locally
                record.status = 'Rejected';

                // Update the UI
                populateLeaveTable();
                updateDashboard();
            } catch (error) {
                console.error('Error in rejectLeaveRecord:', error);
                showMessage(`Error rejecting leave: ${error.message}`, 'error');
            }
        }

        // Approve excuse record (Admin function)
        async function approveExcuseRecord(recordId) {
            try {
                // Update status in Supabase
                const { data, error } = await dbHelpers.updateExcuseStatus(recordId, 'Approved');
                if (error) {
                    console.error('Error approving excuse in Supabase:', error);
                    showMessage(`Error approving excuse: ${error.message}`, 'error');
                    return;
                }

                console.log('Excuse approved in Supabase:', data);

                // Update local array
                const record = excuseRecords.find(r => r.id == recordId);
                if (record) {
                    record.status = 'Approved';
                    showMessage(`Excuse request for ${record.employeeName} has been approved.`);
                }

                // Update the UI
                populateExcuseTable();
            } catch (error) {
                console.error('Error in approveExcuseRecord:', error);
                showMessage(`Error approving excuse: ${error.message}`, 'error');
            }
        }

        // Reject excuse record (Admin function)
        async function rejectExcuseRecord(recordId) {
            if (!confirm('Are you sure you want to reject this excuse request?')) {
                return;
            }

            try {
                // Update status in Supabase
                const { data, error } = await dbHelpers.updateExcuseStatus(recordId, 'Rejected');
                if (error) {
                    console.error('Error rejecting excuse in Supabase:', error);
                    showMessage(`Error rejecting excuse: ${error.message}`, 'error');
                    return;
                }

                console.log('Excuse rejected in Supabase:', data);

                // Update local array
                const record = excuseRecords.find(r => r.id == recordId);
                if (record) {
                    record.status = 'Rejected';
                    showMessage(`Excuse request for ${record.employeeName} has been rejected.`);
                }

                // Update the UI
                populateExcuseTable();
            } catch (error) {
                console.error('Error in rejectExcuseRecord:', error);
                showMessage(`Error rejecting excuse: ${error.message}`, 'error');
            }
        }

        // Delete leave record
        async function deleteLeaveRecord(recordId) {
            if (!confirm('Are you sure you want to delete this leave record?')) {
                return;
            }

            // Find the record
            const record = leaveRecords.find(r => r.id == recordId);
            if (!record) {
                showMessage('Record not found.', 'error');
                return;
            }

            // Note: We don't update employee table balance anymore
            // Balance is calculated dynamically based on approved leave records
            if ((record.type.toLowerCase().includes('annual') || record.type.toLowerCase().includes('casual')) &&
                record.status === 'Approved') {
                console.log('Approved annual leave deleted - balance calculation is dynamic');
                showMessage(`Leave record deleted. Balance calculation is dynamic.`);
            } else {
                showMessage('Leave record deleted successfully.');
            }

            try {
                // Delete from Supabase
                const { data, error } = await dbHelpers.deleteLeaveRequest(recordId);
                if (error) {
                    console.error('Error deleting leave from Supabase:', error);
                    showMessage(`Error deleting leave: ${error.message}`, 'error');
                    return;
                }

                console.log('Leave deleted from Supabase:', data);

                // Find the record index and remove it locally
                const recordIndex = leaveRecords.findIndex(r => r.id == recordId);
                if (recordIndex !== -1) {
                    leaveRecords.splice(recordIndex, 1);
                }

                // Update the UI
                populateLeaveTable();
                updateDashboard();
            } catch (error) {
                console.error('Error in deleteLeaveRecord:', error);
                showMessage(`Error deleting leave: ${error.message}`, 'error');
            }
        }

        // Edit excuse record
        function editExcuseRecord(recordId) {
            // Find the record
            const record = excuseRecords.find(r => r.id == recordId);
            if (!record) {
                showMessage('Record not found.', 'error');
                return;
            }

            // Populate the excuse form with the record data
            document.getElementById('excuse-employee-code').value = record.employeeId;
            document.getElementById('excuse-employee-name').value = record.employeeName;
            document.getElementById('excuse-employee').value = record.employeeId;

            // Set the date
            document.getElementById('excuse-date').value = record.date;

            // Set the type
            const typeSelect = document.getElementById('excuse-type');
            for (let i = 0; i < typeSelect.options.length; i++) {
                if (typeSelect.options[i].text === record.type) {
                    typeSelect.selectedIndex = i;
                    break;
                }
            }

            // Set the time
            if (record.startTime) {
                document.getElementById('excuse-start-time').value = record.startTime;
            }
            if (record.endTime) {
                document.getElementById('excuse-end-time').value = record.endTime;
            }

            // Set the reason
            document.getElementById('excuse-reason').value = record.reason || '';

            // Show the excuse section and make the form visible
            showSection('excuses');
            document.getElementById('excuse-form-container').classList.remove('hidden');
            document.getElementById('excuse-form').scrollIntoView({ behavior: 'smooth' });

            // Add a hidden field to track that we're editing
            let editIdField = document.getElementById('excuse-edit-id');
            if (!editIdField) {
                editIdField = document.createElement('input');
                editIdField.type = 'hidden';
                editIdField.id = 'excuse-edit-id';
                document.getElementById('excuse-form').appendChild(editIdField);
            }
            editIdField.value = recordId;

            // Change the submit button text
            const submitBtn = document.querySelector('#excuse-form button[type="submit"]');
            if (submitBtn) {
                submitBtn.textContent = 'Update Excuse Record';
            }

            // Add a cancel button if it doesn't exist
            if (!document.getElementById('excuse-cancel-edit')) {
                const cancelBtn = document.createElement('button');
                cancelBtn.id = 'excuse-cancel-edit';
                cancelBtn.type = 'button';
                cancelBtn.className = 'px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition duration-150';
                cancelBtn.textContent = 'Cancel';
                cancelBtn.onclick = cancelExcuseEdit;
                submitBtn.parentNode.insertBefore(cancelBtn, submitBtn);
            }
        }

        // Cancel excuse edit
        function cancelExcuseEdit() {
            // Reset the form
            document.getElementById('excuse-form').reset();
            document.getElementById('excuse-employee-name').value = '';

            // Remove the edit ID field
            const editIdField = document.getElementById('excuse-edit-id');
            if (editIdField) {
                editIdField.remove();
            }

            // Change the submit button text back
            const submitBtn = document.querySelector('#excuse-form button[type="submit"]');
            if (submitBtn) {
                submitBtn.textContent = 'Submit Excuse Request';
            }

            // Remove the cancel button
            const cancelBtn = document.getElementById('excuse-cancel-edit');
            if (cancelBtn) {
                cancelBtn.remove();
            }

            // Hide the form container
            document.getElementById('excuse-form-container').classList.add('hidden');
        }

        // Delete excuse record
        async function deleteExcuseRecord(recordId) {
            if (!confirm('Are you sure you want to delete this excuse record?')) {
                return;
            }

            try {
                // Delete from Supabase
                const { data, error } = await dbHelpers.deleteExcuseRequest(recordId);
                if (error) {
                    console.error('Error deleting excuse from Supabase:', error);
                    showMessage(`Error deleting excuse: ${error.message}`, 'error');
                    return;
                }

                console.log('Excuse deleted from Supabase:', data);

                // Remove from local array
                const recordIndex = excuseRecords.findIndex(r => r.id == recordId);
                if (recordIndex !== -1) {
                    excuseRecords.splice(recordIndex, 1);
                }

                // Update the UI
                populateExcuseTable();

                // Show success message
                showMessage('Excuse record deleted successfully.');
            } catch (error) {
                console.error('Error in deleteExcuseRecord:', error);
                showMessage(`Error deleting excuse: ${error.message}`, 'error');
            }
        }

        // Edit penalty record
        function editPenaltyRecord(recordId) {
            // Find the record
            const record = penaltyRecords.find(r => r.id == recordId);
            if (!record) {
                showMessage('Record not found.', 'error');
                return;
            }

            // Populate the penalty form with the record data
            document.getElementById('penalty-employee-code').value = record.employeeId;
            document.getElementById('penalty-employee-name').value = record.employeeName;
            document.getElementById('penalty-employee').value = record.employeeId;

            // Set the date
            document.getElementById('penalty-date').value = record.date;

            // Set the days
            document.getElementById('penalty-days').value = record.days;

            // Set the reason
            document.getElementById('penalty-reason').value = record.reason || '';

            // Show the penalty section and make the form visible
            showSection('penalties');
            document.getElementById('penalty-form-container').classList.remove('hidden');
            document.getElementById('penalty-form').scrollIntoView({ behavior: 'smooth' });

            // Add a hidden field to track that we're editing
            let editIdField = document.getElementById('penalty-edit-id');
            if (!editIdField) {
                editIdField = document.createElement('input');
                editIdField.type = 'hidden';
                editIdField.id = 'penalty-edit-id';
                document.getElementById('penalty-form').appendChild(editIdField);
            }
            editIdField.value = recordId;

            // Change the submit button text
            const submitBtn = document.querySelector('#penalty-form button[type="submit"]');
            if (submitBtn) {
                submitBtn.textContent = 'Update Penalty Record';
            }

            // Add a cancel button if it doesn't exist
            if (!document.getElementById('penalty-cancel-edit')) {
                const cancelBtn = document.createElement('button');
                cancelBtn.id = 'penalty-cancel-edit';
                cancelBtn.type = 'button';
                cancelBtn.className = 'px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition duration-150';
                cancelBtn.textContent = 'Cancel';
                cancelBtn.onclick = cancelPenaltyEdit;
                submitBtn.parentNode.insertBefore(cancelBtn, submitBtn);
            }
        }

        // Cancel penalty edit
        function cancelPenaltyEdit() {
            // Reset the form
            document.getElementById('penalty-form').reset();
            document.getElementById('penalty-employee-name').value = '';

            // Remove the edit ID field
            const editIdField = document.getElementById('penalty-edit-id');
            if (editIdField) {
                editIdField.remove();
            }

            // Change the submit button text back
            const submitBtn = document.querySelector('#penalty-form button[type="submit"]');
            if (submitBtn) {
                submitBtn.textContent = 'Submit Penalty';
            }

            // Remove the cancel button
            const cancelBtn = document.getElementById('penalty-cancel-edit');
            if (cancelBtn) {
                cancelBtn.remove();
            }

            // Hide the form container
            document.getElementById('penalty-form-container').classList.add('hidden');
        }

        // Delete penalty record
        async function deletePenaltyRecord(recordId) {
            if (!confirm('Are you sure you want to delete this penalty record?')) {
                return;
            }

            try {
                // Delete from Supabase
                const { data, error } = await dbHelpers.deletePenalty(recordId);
                if (error) {
                    console.error('Error deleting penalty from Supabase:', error);
                    showMessage(`Error deleting penalty: ${error.message}`, 'error');
                    return;
                }

                console.log('Penalty deleted from Supabase:', data);

                // Remove from local array
                const recordIndex = penaltyRecords.findIndex(r => r.id == recordId);
                if (recordIndex !== -1) {
                    penaltyRecords.splice(recordIndex, 1);
                }

                // Update the UI
                populatePenaltyTable();

                // Show success message
                showMessage('Penalty record deleted successfully.');
            } catch (error) {
                console.error('Error in deletePenaltyRecord:', error);
                showMessage(`Error deleting penalty: ${error.message}`, 'error');
            }
        }

        // Update penalty summary based on filters
        function updatePenaltySummary(employeeId = 'all', month = 'all') {
            console.log('Updating penalty summary with filters:', { employeeId, month });
            const currentYear = new Date().getFullYear();

            // Get the elements to update
            const totalMonthElement = document.getElementById('total-penalty-days-month');
            const totalYearElement = document.getElementById('total-penalty-days-year');

            if (!totalMonthElement || !totalYearElement) return;

            // Filter records based on parameters
            let filteredRecords = [...penaltyRecords];
            console.log('Total penalty records:', filteredRecords.length);

            // Apply employee filter
            if (employeeId !== 'all') {
                console.log('Filtering for employee:', employeeId);
                filteredRecords = filteredRecords.filter(record => record.employeeId === employeeId);
                console.log('After employee filter, records count:', filteredRecords.length);
            }

            // Filter for current year only
            filteredRecords = filteredRecords.filter(record => {
                const date = new Date(record.date);
                return date.getFullYear() === currentYear;
            });
            console.log('After year filter, records count:', filteredRecords.length);

            // Calculate total for the selected month (or current month if none selected)
            let selectedMonth = month !== 'all' ? parseInt(month) : new Date().getMonth() + 1;
            console.log('Selected month for summary:', selectedMonth);

            // Calculate total penalty days for the selected month (current year only)
            const totalMonthPenaltyDays = filteredRecords
                .filter(pr => {
                    const date = new Date(pr.date);
                    const recordMonth = date.getMonth() + 1;
                    console.log(`Penalty record ${pr.id} date: ${pr.date}, month: ${recordMonth}`);
                    return recordMonth === selectedMonth;
                })
                .reduce((sum, pr) => sum + parseFloat(pr.days), 0);
            console.log('Total month penalty days:', totalMonthPenaltyDays);

            // Calculate total penalty days for the current year
            const totalYearPenaltyDays = filteredRecords
                .reduce((sum, pr) => sum + parseFloat(pr.days), 0);
            console.log('Total year penalty days:', totalYearPenaltyDays);

            // Update the summary display - use toFixed(2) to ensure we show exact fractions (0.25, 0.50, 0.75, etc.)
            totalMonthElement.textContent = totalMonthPenaltyDays.toFixed(2);
            totalYearElement.textContent = totalYearPenaltyDays.toFixed(2);

            // Update the month label to show which month is being displayed
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            const monthLabel = document.querySelector('.bg-red-50 h3');

            if (monthLabel) {
                if (month !== 'all') {
                    monthLabel.textContent = `${monthNames[selectedMonth - 1]} ${currentYear} Penalties`;
                } else {
                    monthLabel.textContent = 'Current Month Penalties';
                }
            }
        }

        // This is a duplicate function that's not being used - removing it to avoid confusion

        // Validate employee code and update employee name and balance for leave form
        document.getElementById('leave-employee-code')?.addEventListener('input', function() {
            const employeeCode = this.value.trim();
            const nameInput = document.getElementById('leave-employee-name');
            const hiddenEmployeeInput = document.getElementById('leave-employee');
            const balanceInput = document.getElementById('leave-balance');

            // Reset fields
            nameInput.value = '';
            hiddenEmployeeInput.value = '';
            balanceInput.value = '';

            if (employeeCode) {
                // Find employee by code
                const employee = employees.find(e => e.id === employeeCode);

                if (employee) {
                    // Employee found, update name and balance - handle both field formats
                    const employeeName = employee.fullName || employee.full_name || 'Unknown';
                    nameInput.value = employeeName;
                    hiddenEmployeeInput.value = employee.id;

                    // Get the employee's REMAINING leave balance (calculated dynamically)
                    const remainingBalance = calculateRemainingLeaveBalance(employee.id);

                    // Update the balance input with remaining balance
                    balanceInput.value = parseFloat(remainingBalance).toFixed(1);

                    // Add success styling
                    nameInput.classList.remove('bg-red-50');
                    nameInput.classList.add('bg-green-50');
                } else {
                    // Employee not found, show error styling
                    nameInput.value = 'Employee not found';
                    nameInput.classList.remove('bg-green-50');
                    nameInput.classList.add('bg-red-50');
                }
            }
        });

        // Validate employee code and update employee name for excuse form
        document.getElementById('excuse-employee-code')?.addEventListener('input', function() {
            const employeeCode = this.value.trim();
            const nameInput = document.getElementById('excuse-employee-name');
            const hiddenEmployeeInput = document.getElementById('excuse-employee');

            // Reset fields
            nameInput.value = '';
            hiddenEmployeeInput.value = '';

            if (employeeCode) {
                // Find employee by code
                const employee = employees.find(e => e.id === employeeCode);

                if (employee) {
                    // Employee found, update name - handle both field formats
                    const employeeName = employee.fullName || employee.full_name || 'Unknown';
                    nameInput.value = employeeName;
                    hiddenEmployeeInput.value = employee.id;

                    // Add success styling
                    nameInput.classList.remove('bg-red-50');
                    nameInput.classList.add('bg-green-50');
                } else {
                    // Employee not found, show error styling
                    nameInput.value = 'Employee not found';
                    nameInput.classList.remove('bg-green-50');
                    nameInput.classList.add('bg-red-50');
                }
            }
        });

        // Validate employee code and update employee name for penalty form
        document.getElementById('penalty-employee-code')?.addEventListener('input', function() {
            const employeeCode = this.value.trim();
            const nameInput = document.getElementById('penalty-employee-name');
            const hiddenEmployeeInput = document.getElementById('penalty-employee');

            // Reset fields
            nameInput.value = '';
            hiddenEmployeeInput.value = '';

            if (employeeCode) {
                // Find employee by code
                const employee = employees.find(e => e.id === employeeCode);

                if (employee) {
                    // Employee found, update name - handle both field formats
                    const employeeName = employee.fullName || employee.full_name || 'Unknown';
                    nameInput.value = employeeName;
                    hiddenEmployeeInput.value = employee.id;

                    // Add success styling
                    nameInput.classList.remove('bg-red-50');
                    nameInput.classList.add('bg-green-50');
                } else {
                    // Employee not found, show error styling
                    nameInput.value = 'Employee not found';
                    nameInput.classList.remove('bg-green-50');
                    nameInput.classList.add('bg-red-50');
                }
            }
        });

        // --- Simplified Time Selection Implementation ---
        let selectedHour = 9;
        let isAM = true;
        let currentTimeField = null; // Tracks which time field is being edited

        // Function to open the clock modal for a specific field
        function openClockModal(fieldPrefix) {
            const clockModal = document.getElementById('clockModal');
            const modalTitle = document.getElementById('clock-modal-title');
            const displayField = document.getElementById(`${fieldPrefix}-display`);

            if (!clockModal || !modalTitle || !displayField) {
                console.error('Clock modal elements not found:', { clockModal, modalTitle, displayField });
                return;
            }

            // Set the current field being edited
            window.currentTimeField = fieldPrefix === 'excuse-start-time' || fieldPrefix === 'overtime-start-time' ? 'start' : 'end';
            window.currentFieldPrefix = fieldPrefix;

            // Set the modal title
            modalTitle.textContent = window.currentTimeField === 'start' ? 'Select Start Time' : 'Select End Time';

            // Initialize default values if not set
            if (typeof window.selectedHour === 'undefined') {
                window.selectedHour = window.currentTimeField === 'start' ? 9 : 17;
            }
            if (typeof window.isAM === 'undefined') {
                window.isAM = window.currentTimeField === 'start';
            }

            // Show the modal
            clockModal.classList.remove('hidden');

            // Parse existing time if any
            const timeValue = displayField.value;
            let selectedHour = window.currentTimeField === 'start' ? 9 : 17; // Default to 9 AM for start, 5 PM for end
            let isAM = window.currentTimeField === 'start'; // Default AM for start, PM for end

            if (timeValue) {
                const timeParts = timeValue.match(/(\d+):\d+\s*(AM|PM)/i);
                if (timeParts) {
                    selectedHour = parseInt(timeParts[1]);
                    isAM = timeParts[2].toUpperCase() === 'AM';
                }
            }

            // Reset all buttons
            document.querySelectorAll('.hour-button').forEach(btn => {
                btn.classList.remove('selected');
            });

            // Find and highlight the selected button
            const selectedBtn = document.querySelector(`.hour-button[data-hour="${selectedHour}"][data-ampm="${isAM ? 'AM' : 'PM'}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('selected');
            }

            // Store the current field prefix for use in the confirm button
            window.currentFieldPrefix = fieldPrefix;

            // Update the selected time text
            const hourDisplay = selectedHour === 0 ? 12 : selectedHour;
            const amPm = isAM ? 'AM' : 'PM';
            document.getElementById('selected-time-text').textContent = `${hourDisplay}:00 ${amPm}`;
        }

        // Initialize the simplified time selection
        function initializeAnalogClock() {
            const amHoursContainer = document.getElementById('am-hours-container');
            const pmHoursContainer = document.getElementById('pm-hours-container');
            const selectedTimeText = document.getElementById('selected-time-text');
            const confirmButton = document.getElementById('clock-confirm');
            const closeButton = document.getElementById('close-clock-modal');
            const clockModal = document.getElementById('clockModal');
            const modalTitle = document.getElementById('clock-modal-title');

            // Initialize global variables for time selection
            window.selectedHour = 9; // Default to 9 AM
            window.isAM = true;
            window.currentTimeField = 'start';
            window.currentFieldPrefix = 'excuse-start-time';

            // Create AM hour buttons
            for (let i = 1; i <= 12; i++) {
                const hourBtn = document.createElement('button');
                hourBtn.type = 'button';
                hourBtn.className = 'hour-button';
                hourBtn.textContent = i === 12 ? '12' : i;
                hourBtn.dataset.hour = i;
                hourBtn.dataset.ampm = 'AM';

                // Add click event to select hour
                hourBtn.addEventListener('click', function() {
                    selectHour(i, true);
                });

                amHoursContainer.appendChild(hourBtn);
            }

            // Create PM hour buttons
            for (let i = 1; i <= 12; i++) {
                const hourBtn = document.createElement('button');
                hourBtn.type = 'button';
                hourBtn.className = 'hour-button';
                hourBtn.textContent = i === 12 ? '12' : i;
                hourBtn.dataset.hour = i;
                hourBtn.dataset.ampm = 'PM';

                // Add click event to select hour
                hourBtn.addEventListener('click', function() {
                    selectHour(i, false);
                });

                pmHoursContainer.appendChild(hourBtn);
            }

            // Function to select an hour
            function selectHour(hour, am) {
                window.selectedHour = hour;
                window.isAM = am;

                // Update selected hour visual
                document.querySelectorAll('.hour-button').forEach(btn => {
                    btn.classList.remove('selected');
                });

                // Find and highlight the selected button
                const selectedBtn = document.querySelector(`.hour-button[data-hour="${hour}"][data-ampm="${window.isAM ? 'AM' : 'PM'}"]`);
                if (selectedBtn) {
                    selectedBtn.classList.add('selected');
                }

                // Update the selected time text
                const hourDisplay = window.selectedHour === 0 ? 12 : window.selectedHour;
                const amPm = window.isAM ? 'AM' : 'PM';
                selectedTimeText.textContent = `${hourDisplay}:00 ${amPm}`;
            }



            // Confirm time selection
            confirmButton.addEventListener('click', function() {
                const hourDisplay = window.selectedHour === 0 ? 12 : window.selectedHour;
                const amPm = window.isAM ? 'AM' : 'PM';
                const timeString = `${hourDisplay}:00 ${amPm}`;

                // Calculate 24-hour format for hidden input
                let hour24 = window.selectedHour;
                if (!window.isAM && window.selectedHour < 12) {
                    hour24 += 12;
                } else if (window.isAM && window.selectedHour === 12) {
                    hour24 = 0;
                }
                const timeValue = `${hour24 < 10 ? '0' + hour24 : hour24}:00`;

                // Get the current field prefix (excuse-start-time, excuse-end-time, overtime-start-time, overtime-end-time)
                const fieldPrefix = window.currentFieldPrefix;

                // Update the display field
                const displayField = document.getElementById(`${fieldPrefix}-display`);
                if (displayField) {
                    displayField.value = timeString;
                }

                // Update the hidden field
                const hiddenField = document.getElementById(fieldPrefix);
                if (hiddenField) {
                    hiddenField.value = timeValue;
                }

                // Hide the modal
                clockModal.classList.add('hidden');
            });

            // Close modal
            closeButton.addEventListener('click', function() {
                clockModal.classList.add('hidden');
            });

            // Add click event listeners to time input fields
            document.getElementById('excuse-start-time-display')?.addEventListener('click', function() {
                openClockModal('excuse-start-time');
            });

            document.getElementById('excuse-end-time-display')?.addEventListener('click', function() {
                openClockModal('excuse-end-time');
            });

            document.getElementById('overtime-start-time-display')?.addEventListener('click', function() {
                openClockModal('overtime-start-time');
            });

            document.getElementById('overtime-end-time-display')?.addEventListener('click', function() {
                openClockModal('overtime-end-time');
            });
        }

        // --- General Initialization ---
         function initializeDatePickers() {
            flatpickr("main .flatpickr-input", {
                altInput: true, altFormat: "F j, Y", dateFormat: "Y-m-d", allowInput: true
            });
        }

        // Removed complex Flatpickr initialization - using simple dropdowns only

        // Run on page load
        document.addEventListener('DOMContentLoaded', () => {
             initializeDatePickers();
             console.log("Page loaded. Waiting for login.");

             // EMERGENCY FIX: Ensure all modals are closed on page load
             const modalsToClose = ['employeeCardModal', 'employeeModal', 'leaveModal', 'excuseModal', 'overtimeModal', 'penaltyModal'];
             modalsToClose.forEach(modalId => {
                 const modal = document.getElementById(modalId);
                 if (modal) {
                     modal.classList.add('hidden');
                     modal.classList.remove('flex');
                     modal.style.display = 'none';
                 }
             });
             console.log('All modals forced to close on page load');

             // Add emergency escape key handler
             document.addEventListener('keydown', function(e) {
                 if (e.key === 'Escape') {
                     modalsToClose.forEach(modalId => {
                         const modal = document.getElementById(modalId);
                         if (modal && !modal.classList.contains('hidden')) {
                             modal.classList.add('hidden');
                             modal.classList.remove('flex');
                             modal.style.display = 'none';
                             console.log(`Emergency closed modal: ${modalId}`);
                         }
                     });
                 }
             });

             // initializeAppUI is called after successful login

             // Mobile sidebar toggle - Enhanced implementation
             const mobileMenuButton = document.getElementById('mobile-menu-button');
             const closeSidebarButton = document.getElementById('close-sidebar');
             const sidebar = document.getElementById('sidebar');
             const sidebarLinks = document.querySelectorAll('.sidebar-link');

             // Function to show mobile sidebar
             function showMobileSidebar() {
                 if (sidebar) {
                     sidebar.classList.remove('-translate-x-full');
                     sidebar.classList.add('translate-x-0');
                     // Add backdrop for mobile
                     if (!document.getElementById('mobile-backdrop')) {
                         const backdrop = document.createElement('div');
                         backdrop.id = 'mobile-backdrop';
                         backdrop.className = 'fixed inset-0 bg-black bg-opacity-50 z-5 md:hidden';
                         backdrop.addEventListener('click', hideMobileSidebar);
                         document.body.appendChild(backdrop);
                     }
                 }
             }

             // Function to hide mobile sidebar
             function hideMobileSidebar() {
                 if (sidebar) {
                     sidebar.classList.add('-translate-x-full');
                     sidebar.classList.remove('translate-x-0');
                     // Remove backdrop
                     const backdrop = document.getElementById('mobile-backdrop');
                     if (backdrop) {
                         backdrop.remove();
                     }
                 }
             }

             // Mobile menu button click handler
             if (mobileMenuButton) {
                 console.log('Mobile menu button found, adding event listener');
                 mobileMenuButton.addEventListener('click', (e) => {
                     e.preventDefault();
                     e.stopPropagation();
                     console.log('Mobile menu button clicked - showing sidebar');
                     showMobileSidebar();
                 });
             } else {
                 console.error('Mobile menu button not found!');
             }

             // Close sidebar button click handler
             if (closeSidebarButton) {
                 closeSidebarButton.addEventListener('click', (e) => {
                     e.preventDefault();
                     e.stopPropagation();
                     hideMobileSidebar();
                 });
             }

             // Close sidebar when clicking on a link (in mobile view)
             sidebarLinks.forEach(link => {
                 link.addEventListener('click', () => {
                     if (window.innerWidth < 768) { // Only in mobile view
                         hideMobileSidebar();
                     }
                 });
             });

             // Notification bell toggle
             const notificationBell = document.getElementById('notification-bell');
             const notificationDropdown = document.getElementById('notification-dropdown');
             const markAllReadBtn = document.getElementById('mark-all-read');

             if (notificationBell && notificationDropdown) {
                 notificationBell.addEventListener('click', (e) => {
                     e.stopPropagation();
                     notificationDropdown.classList.toggle('hidden');
                     populateNotificationDropdown();
                 });

                 // Close dropdown when clicking outside
                 document.addEventListener('click', (e) => {
                     if (!notificationDropdown.contains(e.target) && e.target !== notificationBell) {
                         notificationDropdown.classList.add('hidden');
                     }
                 });

                 // Prevent dropdown from closing when clicking inside it
                 notificationDropdown.addEventListener('click', (e) => {
                     e.stopPropagation();
                 });

                 // Mark all as read button
                 markAllReadBtn.addEventListener('click', (e) => {
                     e.stopPropagation();
                     notifications.forEach(notification => {
                         notification.read = true;
                     });
                     updateNotificationBadge();
                     populateNotificationDropdown();
                 });
             }

             // Handle date dropdowns
             populateDateDropdowns();
        });

        // Populate date dropdowns (days, months, years)
        function populateDateDropdowns() {
            // Days (1-31)
            const dayDropdowns = ['hiringDay', 'dobDay', 'resignDay'];
            dayDropdowns.forEach(id => {
                const dropdown = document.getElementById(id);
                if (dropdown) {
                    for (let i = 1; i <= 31; i++) {
                        const option = document.createElement('option');
                        option.value = i;
                        option.textContent = i;
                        dropdown.appendChild(option);
                    }
                }
            });

            // Months
            const months = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            const monthDropdowns = ['hiringMonth', 'dobMonth', 'resignMonth'];
            monthDropdowns.forEach(id => {
                const dropdown = document.getElementById(id);
                if (dropdown) {
                    months.forEach((month, index) => {
                        const option = document.createElement('option');
                        option.value = index + 1;
                        option.textContent = month;
                        dropdown.appendChild(option);
                    });
                }
            });

            // Years (current year - 100 to current year)
            const currentYear = new Date().getFullYear();
            const yearDropdowns = ['hiringYear', 'dobYear', 'resignYear'];
            yearDropdowns.forEach(id => {
                const dropdown = document.getElementById(id);
                if (dropdown) {
                    for (let year = currentYear; year >= currentYear - 100; year--) {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        dropdown.appendChild(option);
                    }
                }
            });

            // Add event listeners to update hidden date fields
            setupDateFieldSync('hiringDay', 'hiringMonth', 'hiringYear', 'hiringDate');
            setupDateFieldSync('dobDay', 'dobMonth', 'dobYear', 'dob');
            setupDateFieldSync('resignDay', 'resignMonth', 'resignYear', 'resignDate');
        }

        // Sync dropdown selections to hidden date field
        function setupDateFieldSync(dayId, monthId, yearId, dateFieldId) {
            const dayDropdown = document.getElementById(dayId);
            const monthDropdown = document.getElementById(monthId);
            const yearDropdown = document.getElementById(yearId);
            const dateField = document.getElementById(dateFieldId);

            if (!dayDropdown || !monthDropdown || !yearDropdown || !dateField) return;

            const updateDateField = () => {
                const day = dayDropdown.value;
                const month = monthDropdown.value;
                const year = yearDropdown.value;

                if (day && month && year) {
                    // Format as YYYY-MM-DD
                    const formattedMonth = month.padStart(2, '0');
                    const formattedDay = day.padStart(2, '0');
                    dateField.value = `${year}-${formattedMonth}-${formattedDay}`;
                    console.log(`Updated ${dateFieldId}:`, dateField.value);
                } else {
                    // Clear the hidden field if any dropdown is empty
                    dateField.value = '';
                    console.log(`Cleared ${dateFieldId} - incomplete selection`);
                }
            };

            dayDropdown.addEventListener('change', updateDateField);
            monthDropdown.addEventListener('change', updateDateField);
            yearDropdown.addEventListener('change', updateDateField);
        }

        // Function to validate leave days match calendar selection
        function validateLeaveDays() {
            const startDate = document.getElementById('leave-start-date').value;
            const endDate = document.getElementById('leave-end-date').value;
            const selectedDays = parseFloat(document.getElementById('leave-days').value);

            if (!startDate || !endDate) return true; // Skip validation if dates not selected

            // Special handling for half-day requests
            if (selectedDays === 0.5) {
                // For half-day requests, start and end dates must be the same
                if (startDate !== endDate) {
                    showMessage('For half-day leave, start and end dates must be the same', 'error');
                    return false;
                }
                return true; // Valid half-day request
            }

            const calculatedDays = calculateLeaveDays(startDate, endDate);

            if (calculatedDays !== selectedDays) {
                showMessage(`Selected days (${selectedDays}) don't match calendar selection (${calculatedDays} days)`, 'error');
                return false;
            }

            return true;
        }

        // Global notifications array
        let notifications = [];

        // Add notifications for probation, birthdays, and anniversaries
        function updateDashboardNotifications() {
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentDay = today.getDate();
            const currentYear = today.getFullYear();

            // Clear previous notifications
            notifications = [];

            // Find employees with birthdays this month
            const birthdayEmployees = employees.filter(emp => {
                if (!emp.dob || emp.status !== 'Active') return false;
                const dob = new Date(emp.dob);
                return dob.getMonth() === currentMonth;
            });

            // Add birthday notifications
            birthdayEmployees.forEach(emp => {
                const dob = new Date(emp.dob);
                const birthdayDay = dob.getDate();
                const daysUntilBirthday = birthdayDay - currentDay;

                // Only add if birthday is today or in the future (this month)
                if (daysUntilBirthday >= 0 || (daysUntilBirthday < 0 && Math.abs(daysUntilBirthday) < 7)) {
                    const age = currentYear - dob.getFullYear();
                    let message = '';

                    // Handle both field name formats
                    const employeeName = emp.fullName || emp.full_name || 'Unknown Employee';

                    if (daysUntilBirthday === 0) {
                        message = `${employeeName}'s birthday is today! They are turning ${age} years old.`;
                    } else if (daysUntilBirthday > 0) {
                        message = `${employeeName}'s birthday is in ${daysUntilBirthday} days. They will turn ${age} years old.`;
                    } else {
                        message = `${employeeName}'s birthday was ${Math.abs(daysUntilBirthday)} days ago. They turned ${age} years old.`;
                    }

                    notifications.push({
                        type: 'birthday',
                        icon: 'fa-birthday-cake',
                        color: 'text-pink-500',
                        message: message,
                        date: new Date(currentYear, dob.getMonth(), dob.getDate()),
                        employee: emp,
                        read: false
                    });
                }
            });

            // Find employees with work anniversaries this month
            const anniversaryEmployees = employees.filter(emp => {
                if (!emp.hiringDate || emp.status !== 'Active') return false;
                const hireDate = new Date(emp.hiringDate);
                return hireDate.getMonth() === currentMonth && hireDate.getFullYear() < currentYear;
            });

            // Add anniversary notifications
            anniversaryEmployees.forEach(emp => {
                const hireDate = new Date(emp.hiringDate);
                const anniversaryDay = hireDate.getDate();
                const daysUntilAnniversary = anniversaryDay - currentDay;

                // Only add if anniversary is today or in the future (this month)
                if (daysUntilAnniversary >= 0 || (daysUntilAnniversary < 0 && Math.abs(daysUntilAnniversary) < 7)) {
                    const years = currentYear - hireDate.getFullYear();
                    // Handle both field name formats
                    const employeeName = emp.fullName || emp.full_name || 'Unknown Employee';
                    let message = '';

                    if (daysUntilAnniversary === 0) {
                        message = `${employeeName}'s work anniversary is today! They have been with the company for ${years} years.`;
                    } else if (daysUntilAnniversary > 0) {
                        message = `${employeeName}'s work anniversary is in ${daysUntilAnniversary} days. They will complete ${years} years with the company.`;
                    } else {
                        message = `${employeeName}'s work anniversary was ${Math.abs(daysUntilAnniversary)} days ago. They completed ${years} years with the company.`;
                    }

                    notifications.push({
                        type: 'anniversary',
                        icon: 'fa-glass-cheers',
                        color: 'text-blue-500',
                        message: message,
                        date: new Date(currentYear, hireDate.getMonth(), hireDate.getDate()),
                        employee: emp,
                        read: false
                    });
                }
            });

            // Find employees who will complete probation soon (assuming 3 months probation)
            const probationEmployees = employees.filter(emp => {
                if (!emp.hiringDate || emp.status !== 'Active') return false;
                const hireDate = new Date(emp.hiringDate);
                const probationEndDate = new Date(hireDate);
                probationEndDate.setMonth(probationEndDate.getMonth() + 3);

                // Check if probation ends within the next 30 days or ended in the last 7 days
                const timeDiff = probationEndDate - today;
                const daysDiff = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
                return (daysDiff >= 0 && daysDiff <= 30) || (daysDiff < 0 && daysDiff >= -7);
            });

            // Add probation notifications
            probationEmployees.forEach(emp => {
                const hireDate = new Date(emp.hiringDate);
                const probationEndDate = new Date(hireDate);
                probationEndDate.setMonth(probationEndDate.getMonth() + 3);

                const timeDiff = probationEndDate - today;
                const daysDiff = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));

                // Handle both field name formats
                const employeeName = emp.fullName || emp.full_name || 'Unknown Employee';
                let message = '';
                if (daysDiff === 0) {
                    message = `${employeeName}'s probation period ends today!`;
                } else if (daysDiff > 0) {
                    message = `${employeeName}'s probation period will end in ${daysDiff} days.`;
                } else {
                    message = `${employeeName}'s probation period ended ${Math.abs(daysDiff)} days ago.`;
                }

                notifications.push({
                    type: 'probation',
                    icon: 'fa-user-check',
                    color: 'text-green-500',
                    message: message,
                    date: probationEndDate,
                    employee: emp,
                    read: false
                });
            });

            // Update notification badge
            updateNotificationBadge();
        }

        // Update notification badge count
        function updateNotificationBadge() {
            const unreadCount = notifications.filter(n => !n.read).length;
            const badge = document.getElementById('notification-badge');

            if (unreadCount > 0) {
                badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        // Populate notification dropdown
        function populateNotificationDropdown() {
            const notificationList = document.getElementById('notification-list');

            if (notifications.length === 0) {
                notificationList.innerHTML = `
                    <div class="py-8 text-center text-gray-500">
                        <i class="fas fa-bell-slash text-2xl mb-2"></i>
                        <p>No notifications</p>
                    </div>
                `;
                return;
            }

            // Sort notifications by date (newest first)
            notifications.sort((a, b) => b.date - a.date);

            let notificationHTML = '';

            notifications.forEach((notification, index) => {
                const dateString = formatDate(notification.date);

                notificationHTML += `
                    <div class="notification-item p-3 border-b hover:bg-gray-50 ${notification.read ? 'bg-gray-50' : ''}" data-index="${index}">
                        <div class="flex items-start">
                            <div class="flex-shrink-0 mr-3">
                                <div class="h-8 w-8 rounded-full bg-${notification.color.replace('text-', 'bg-').replace('-500', '-100')} flex items-center justify-center">
                                    <i class="fas ${notification.icon} ${notification.color}"></i>
                                </div>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm text-gray-800">${notification.message}</p>
                                <p class="text-xs text-gray-500 mt-1">${dateString}</p>
                            </div>
                            ${!notification.read ? '<div class="ml-2 h-2 w-2 bg-blue-500 rounded-full"></div>' : ''}
                        </div>
                    </div>
                `;
            });

            notificationList.innerHTML = notificationHTML;

            // Add click event listeners to mark notifications as read
            document.querySelectorAll('.notification-item').forEach(item => {
                item.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    notifications[index].read = true;
                    updateNotificationBadge();
                    populateNotificationDropdown();
                });
            });
        }

        // Function to set up employee code validation for leave filter
        function setupLeaveFilterEmployeeCodeValidation() {
            const employeeCodeInput = document.getElementById('leave-filter-employee-code');
            const employeeNameInput = document.getElementById('leave-filter-employee-name');
            const employeeIdInput = document.getElementById('leave-filter-employee');
            const applyFiltersButton = document.getElementById('apply-leave-filters');

            if (!employeeCodeInput || !employeeNameInput || !employeeIdInput || !applyFiltersButton) return;

            // Add input event listener to validate employee code
            employeeCodeInput.addEventListener('input', function() {
                const code = this.value.trim();

                if (code === '') {
                    // Reset fields if empty
                    employeeNameInput.value = '';
                    employeeIdInput.value = 'all';
                    employeeNameInput.classList.remove('border-green-500', 'border-red-500');
                    return;
                }

                // Find employee by code
                const employee = employees.find(e => e.id.toLowerCase() === code.toLowerCase());

                if (employee) {
                    // Valid employee code - handle both field name formats
                    const employeeName = employee.fullName || employee.full_name || 'Unknown';
                    employeeNameInput.value = employeeName;
                    employeeIdInput.value = employee.id;
                    employeeNameInput.classList.remove('border-red-500');
                    employeeNameInput.classList.add('border-green-500');

                    // Update leave summary immediately when a valid employee is selected
                    const monthFilter = document.getElementById('leave-filter-month').value;
                    updateLeaveSummary(employee.id, monthFilter);
                } else {
                    // Invalid employee code
                    employeeNameInput.value = 'Employee not found';
                    employeeIdInput.value = 'all';
                    employeeNameInput.classList.remove('border-green-500');
                    employeeNameInput.classList.add('border-red-500');
                }
            });

            // Add change event listener to month filter
            const monthFilterSelect = document.getElementById('leave-filter-month');
            if (monthFilterSelect) {
                monthFilterSelect.addEventListener('change', function() {
                    const employeeId = document.getElementById('leave-filter-employee').value;
                    updateLeaveSummary(employeeId, this.value);
                });
            }

            // Set up excuse filter employee code validation
            setupExcuseFilterEmployeeCodeValidation();

            // Set up penalty filter employee code validation
            setupPenaltyFilterEmployeeCodeValidation();

            // Function to reset leave filters
            function resetLeaveFilters() {
                // Reset all filter dropdowns to default values
                document.getElementById('leave-filter-employee-code').value = '';
                document.getElementById('leave-filter-employee-name').value = '';
                document.getElementById('leave-filter-employee').value = 'all';
                document.getElementById('leave-filter-month').value = 'all';

                // Remove any styling from the employee name field
                document.getElementById('leave-filter-employee-name').classList.remove('border-green-500', 'border-red-500');

                // Repopulate the table with all records and update the summary
                populateLeaveTable();
                updateLeaveSummary('all', 'all');
            }

            // Add click event listener to apply filters button
            applyFiltersButton.addEventListener('click', function() {
                console.log('Leave filter button clicked');
                // Toggle the button color and check if we need to reset
                const wasActive = toggleFilterButtonColor(this, resetLeaveFilters);
                console.log('Was active:', wasActive);

                // Only apply filters if we're not resetting
                if (!wasActive) {
                    // Get the current filter values
                    const employeeId = document.getElementById('leave-filter-employee').value;
                    const month = document.getElementById('leave-filter-month').value;
                    console.log('Applying leave filters:', { employeeId, month });

                    // Force the filter values to be applied
                    document.getElementById('leave-filter-employee').value = employeeId;
                    document.getElementById('leave-filter-month').value = month;

                    // Update both the table and the summary with the same filters
                    populateLeaveTable();
                    updateLeaveSummary(employeeId, month);
                }
            });

            // Set current year in the filter label
            updateMonthFilterLabels();
        }

        // Function to update month filter labels to show current year
        function updateMonthFilterLabels() {
            const currentYear = new Date().getFullYear();

            // Update leave filter month label
            const leaveMonthFilterLabel = document.querySelector('label[for="leave-filter-month"]');
            if (leaveMonthFilterLabel) {
                leaveMonthFilterLabel.textContent = `Filter by Month (${currentYear})`;
            }

            // Update excuse filter month label
            const excuseMonthFilterLabel = document.querySelector('label[for="excuse-filter-month"]');
            if (excuseMonthFilterLabel) {
                excuseMonthFilterLabel.textContent = `Filter by Month (${currentYear})`;
            }

            // Update penalty filter month label
            const penaltyMonthFilterLabel = document.querySelector('label[for="penalty-filter-month"]');
            if (penaltyMonthFilterLabel) {
                penaltyMonthFilterLabel.textContent = `Filter by Month (${currentYear})`;
            }

            // Update overtime filter month label
            const overtimeMonthFilterLabel = document.querySelector('label[for="overtime-filter-month"]');
            if (overtimeMonthFilterLabel) {
                overtimeMonthFilterLabel.textContent = `Filter by Month (${currentYear})`;
            }
        }

        // Function to set up employee code validation for excuse filter
        function setupExcuseFilterEmployeeCodeValidation() {
            const employeeCodeInput = document.getElementById('excuse-filter-employee-code');
            const employeeNameInput = document.getElementById('excuse-filter-employee-name');
            const employeeIdInput = document.getElementById('excuse-filter-employee');
            const applyFiltersButton = document.getElementById('excuse-filter-btn');

            if (!employeeCodeInput || !employeeNameInput || !employeeIdInput || !applyFiltersButton) return;

            // Add input event listener to validate employee code
            employeeCodeInput.addEventListener('input', function() {
                const code = this.value.trim();

                // Reset fields if empty
                if (code === '') {
                    employeeNameInput.value = '';
                    employeeIdInput.value = 'all';
                    employeeNameInput.classList.remove('border-green-500', 'border-red-500');
                    return;
                }

                // Find employee by code
                const employee = employees.find(e => e.id.toLowerCase() === code.toLowerCase());

                if (employee) {
                    // Valid employee code - handle both field name formats
                    const employeeName = employee.fullName || employee.full_name || 'Unknown';
                    employeeNameInput.value = employeeName;
                    employeeIdInput.value = employee.id;
                    employeeNameInput.classList.remove('border-red-500');
                    employeeNameInput.classList.add('border-green-500');

                    // Update excuse summary immediately when a valid employee is selected
                    const monthFilter = document.getElementById('excuse-filter-month').value;
                    updateExcuseSummary(employee.id, monthFilter);
                } else {
                    // Invalid employee code
                    employeeNameInput.value = 'Employee not found';
                    employeeIdInput.value = 'all';
                    employeeNameInput.classList.remove('border-green-500');
                    employeeNameInput.classList.add('border-red-500');
                }
            });

            // Add change event listener to month filter
            const monthFilterSelect = document.getElementById('excuse-filter-month');
            if (monthFilterSelect) {
                monthFilterSelect.addEventListener('change', function() {
                    const employeeId = document.getElementById('excuse-filter-employee').value;
                    updateExcuseSummary(employeeId, this.value);
                });
            }
        }

        // Function to set up employee code validation for penalty filter
        function setupPenaltyFilterEmployeeCodeValidation() {
            const employeeCodeInput = document.getElementById('penalty-filter-employee-code');
            const employeeNameInput = document.getElementById('penalty-filter-employee-name');
            const employeeIdInput = document.getElementById('penalty-filter-employee');
            const applyFiltersButton = document.getElementById('penalty-filter-btn');

            if (!employeeCodeInput || !employeeNameInput || !employeeIdInput || !applyFiltersButton) return;

            // Add input event listener to validate employee code
            employeeCodeInput.addEventListener('input', function() {
                const code = this.value.trim();

                // Reset fields if empty
                if (code === '') {
                    employeeNameInput.value = '';
                    employeeIdInput.value = 'all';
                    employeeNameInput.classList.remove('border-green-500', 'border-red-500');
                    return;
                }

                // Find employee by code
                const employee = employees.find(e => e.id.toLowerCase() === code.toLowerCase());

                if (employee) {
                    // Valid employee code - handle both field name formats
                    const employeeName = employee.fullName || employee.full_name || 'Unknown';
                    employeeNameInput.value = employeeName;
                    employeeIdInput.value = employee.id;
                    employeeNameInput.classList.remove('border-red-500');
                    employeeNameInput.classList.add('border-green-500');

                    // Update penalty summary immediately when a valid employee is selected
                    const monthFilter = document.getElementById('penalty-filter-month').value;
                    updatePenaltySummary(employee.id, monthFilter);
                } else {
                    // Invalid employee code
                    employeeNameInput.value = 'Employee not found';
                    employeeIdInput.value = 'all';
                    employeeNameInput.classList.remove('border-green-500');
                    employeeNameInput.classList.add('border-red-500');
                }
            });

            // Add change event listener to month filter
            const monthFilterSelect = document.getElementById('penalty-filter-month');
            if (monthFilterSelect) {
                monthFilterSelect.addEventListener('change', function() {
                    const employeeId = document.getElementById('penalty-filter-employee').value;
                    updatePenaltySummary(employeeId, this.value);
                });
            }
        }

        // Function to update all employee leave balances based on year-to-date usage
        function updateAllEmployeeLeaveBalances() {
            // We no longer automatically update all employee leave balances
            // Leave balances are now manually set by admin and updated when leave requests are processed

            // Employee data is now automatically managed in Supabase
        }

        // Helper function to format dates
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);

            // Format as DD/MM/YYYY
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();

            return `${day}/${month}/${year}`;
        }

        // Payroll Functions

        // Function to populate the year dropdowns for payroll
        function populatePayrollYearDropdowns() {
            const currentYear = new Date().getFullYear();
            const payrollYear = document.getElementById('payroll-year');
            const payrollHistoryYear = document.getElementById('payroll-history-year');

            if (payrollYear) {
                payrollYear.innerHTML = '';
                for (let year = currentYear; year >= currentYear - 5; year--) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    payrollYear.appendChild(option);
                }
            }

            if (payrollHistoryYear) {
                // Keep the "All Years" option
                payrollHistoryYear.innerHTML = '<option value="all">All Years</option>';
                for (let year = currentYear; year >= currentYear - 5; year--) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    payrollHistoryYear.appendChild(option);
                }
            }
        }

        // Function to run payroll for the selected month
        function runPayroll() {
            // Get the selected month and year
            const selectedMonth = parseInt(document.getElementById('payroll-month').value);
            const selectedYear = parseInt(document.getElementById('payroll-year').value);

            // Show the payroll form container
            document.getElementById('payroll-form-container').classList.remove('hidden');

            // Populate the payroll calculation table
            populatePayrollCalculationTable(selectedMonth, selectedYear);
        }

        // Function to populate the payroll calculation table
        function populatePayrollCalculationTable(month, year) {
            const tableBody = document.getElementById('payrollCalculationTableBody');
            if (!tableBody) return;

            tableBody.innerHTML = '';

            // Get active employees with salary records
            const activeEmployees = employees.filter(emp => emp.status === 'Active');
            const employeesWithSalary = activeEmployees.filter(emp => {
                return salaryRecords.some(sr => sr.employeeId === emp.id);
            });

            if (employeesWithSalary.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="12" class="text-center py-4 text-gray-500">No active employees with salary records found.</td></tr>';
                return;
            }

            // For each employee, create a row in the table
            employeesWithSalary.forEach(employee => {
                const salaryRecord = salaryRecords.find(sr => sr.employeeId === employee.id);

                // Handle both field name formats
                const employeeName = employee.fullName || employee.full_name || 'Unknown Employee';

                // Create the row
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition duration-150';
                row.innerHTML = `
                    <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${employee.id}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${employeeName}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${salaryRecord.basicSalary.toFixed(2)}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${salaryRecord.fixedAllowance.toFixed(2)}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">
                        <input type="number" class="fuel-allowance w-24 border border-gray-300 rounded-md px-2 py-1 text-sm"
                               value="0" min="0" step="0.01" data-employee-id="${employee.id}">
                    </td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">
                        <input type="number" class="reward w-24 border border-gray-300 rounded-md px-2 py-1 text-sm"
                               value="0" min="0" step="0.01" data-employee-id="${employee.id}">
                    </td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700 overtime-value" data-employee-id="${employee.id}">0.00</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${salaryRecord.fixedDeduction.toFixed(2)}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700 penalties-days" data-employee-id="${employee.id}">0.00</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">
                        <input type="number" class="penalties-egp w-24 border border-gray-300 rounded-md px-2 py-1 text-sm bg-gray-100"
                               value="0" min="0" step="0.01" data-employee-id="${employee.id}" readonly>
                    </td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">
                        <input type="number" class="other-deductions w-24 border border-gray-300 rounded-md px-2 py-1 text-sm"
                               value="0" min="0" step="0.01" data-employee-id="${employee.id}">
                    </td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900 net-salary" data-employee-id="${employee.id}">0.00</td>
                `;

                tableBody.appendChild(row);
            });

            // Calculate overtime and penalties for each employee
            calculateOvertimeForMonth(month, year);
            calculatePenaltiesForMonth(month, year);

            // Add event listeners to recalculate net salary when inputs change
            addPayrollInputEventListeners();
        }

        // Function to calculate overtime for the selected month
        function calculateOvertimeForMonth(month, year) {
            // For each employee, calculate overtime
            const overtimeElements = document.querySelectorAll('.overtime-value');

            overtimeElements.forEach(element => {
                const employeeId = element.getAttribute('data-employee-id');
                const employee = employees.find(emp => emp.id === employeeId);
                const salaryRecord = salaryRecords.find(sr => sr.employeeId === employeeId);

                if (!employee || !salaryRecord) return;

                // Get overtime records for this employee in the selected month
                const employeeOvertimeRecords = overtimeRecords.filter(record => {
                    const recordDate = new Date(record.date);
                    return record.employeeId === employeeId &&
                           recordDate.getMonth() + 1 === month &&
                           recordDate.getFullYear() === year &&
                           record.status === 'Approved';
                });

                // Calculate total overtime hours
                const totalOvertimeHours = employeeOvertimeRecords.reduce((sum, record) => sum + record.hours, 0);

                // Calculate overtime pay: (total overtime hours  1.5  8)  (basic salary  30)
                const overtimePay = (totalOvertimeHours * 1.5 / 8) * (salaryRecord.basicSalary / 30);

                // Update the element
                element.textContent = overtimePay.toFixed(2);

                // Recalculate net salary
                calculateNetSalary(employeeId);
            });
        }

        // Function to calculate penalties for the selected month
        function calculatePenaltiesForMonth(month, year) {
            // For each employee, calculate penalties
            const penaltyElements = document.querySelectorAll('.penalties-days');

            penaltyElements.forEach(element => {
                const employeeId = element.getAttribute('data-employee-id');
                const employee = employees.find(emp => emp.id === employeeId);
                const salaryRecord = salaryRecords.find(sr => sr.employeeId === employeeId);

                if (!employee || !salaryRecord) return;

                // Get penalty records for this employee in the selected month
                const employeePenaltyRecords = penaltyRecords.filter(record => {
                    const recordDate = new Date(record.date);
                    return record.employeeId === employeeId &&
                           recordDate.getMonth() + 1 === month &&
                           recordDate.getFullYear() === year &&
                           record.status === 'Approved';
                });

                // Calculate total penalty days
                const totalPenaltyDays = employeePenaltyRecords.reduce((sum, record) => sum + parseFloat(record.days), 0);

                // Calculate penalty deduction: total penalties  (basic salary  30)
                const penaltyDeduction = totalPenaltyDays * (salaryRecord.basicSalary / 30);

                // Update the penalties/days element - use toFixed(2) to ensure we show exact fractions (0.25, 0.50, 0.75, etc.)
                element.textContent = totalPenaltyDays.toFixed(2);
                element.setAttribute('data-penalty-value', penaltyDeduction.toFixed(2));

                // Update the penalties (EGP) input field with the calculated value
                const penaltiesEgpInput = document.querySelector(`.penalties-egp[data-employee-id="${employeeId}"]`);
                if (penaltiesEgpInput) {
                    penaltiesEgpInput.value = penaltyDeduction.toFixed(2);
                }

                // Recalculate net salary
                calculateNetSalary(employeeId);
            });
        }

        // Function to add event listeners to payroll inputs
        function addPayrollInputEventListeners() {
            // Add event listeners to all input fields
            document.querySelectorAll('.fuel-allowance, .reward, .other-deductions').forEach(input => {
                input.addEventListener('input', function() {
                    const employeeId = this.getAttribute('data-employee-id');
                    calculateNetSalary(employeeId);
                    updatePayrollTotals();
                });
            });

            // Initial calculation
            updatePayrollTotals();
        }

        // Function to calculate net salary for an employee
        function calculateNetSalary(employeeId) {
            const salaryRecord = salaryRecords.find(sr => sr.employeeId === employeeId);
            if (!salaryRecord) return;

            // Get all the values
            const basicSalary = salaryRecord.basicSalary;
            const fixedAllowance = salaryRecord.fixedAllowance;
            const fixedDeduction = salaryRecord.fixedDeduction;

            // Get the input values
            const fuelAllowance = parseFloat(document.querySelector(`.fuel-allowance[data-employee-id="${employeeId}"]`).value) || 0;
            const reward = parseFloat(document.querySelector(`.reward[data-employee-id="${employeeId}"]`).value) || 0;
            const penaltiesEgp = parseFloat(document.querySelector(`.penalties-egp[data-employee-id="${employeeId}"]`).value) || 0;
            const otherDeductions = parseFloat(document.querySelector(`.other-deductions[data-employee-id="${employeeId}"]`).value) || 0;

            // Get the calculated values
            const overtime = parseFloat(document.querySelector(`.overtime-value[data-employee-id="${employeeId}"]`).textContent) || 0;

            // Calculate net salary
            const totalAllowances = fixedAllowance + fuelAllowance + reward + overtime;
            const totalDeductions = fixedDeduction + penaltiesEgp + otherDeductions;
            const netSalary = basicSalary + totalAllowances - totalDeductions;

            // Update the net salary element
            const netSalaryElement = document.querySelector(`.net-salary[data-employee-id="${employeeId}"]`);
            if (netSalaryElement) {
                netSalaryElement.textContent = netSalary.toFixed(2);
            }
        }

        // Function to update payroll totals
        function updatePayrollTotals() {
            // Get all the values
            let totalBasicSalary = 0;
            let totalFixedAllowance = 0;
            let totalFuelAllowance = 0;
            let totalReward = 0;
            let totalOvertime = 0;
            let totalFixedDeduction = 0;
            let totalPenaltiesDays = 0;
            let totalPenaltiesEgp = 0;
            let totalOtherDeductions = 0;
            let totalNetSalary = 0;

            // Get all employee rows
            const employeeRows = document.querySelectorAll('#payrollCalculationTableBody tr');

            employeeRows.forEach(row => {
                // Skip if it's a message row
                if (row.querySelector('td[colspan]')) return;

                // Get the values from the row
                totalBasicSalary += parseFloat(row.cells[2].textContent) || 0;
                totalFixedAllowance += parseFloat(row.cells[3].textContent) || 0;
                totalFuelAllowance += parseFloat(row.querySelector('.fuel-allowance')?.value) || 0;
                totalReward += parseFloat(row.querySelector('.reward')?.value) || 0;
                totalOvertime += parseFloat(row.querySelector('.overtime-value')?.textContent) || 0;
                totalFixedDeduction += parseFloat(row.cells[7].textContent) || 0;

                const penaltiesDaysElement = row.querySelector('.penalties-days');
                if (penaltiesDaysElement) {
                    totalPenaltiesDays += parseFloat(penaltiesDaysElement.textContent) || 0;
                }

                totalPenaltiesEgp += parseFloat(row.querySelector('.penalties-egp')?.value) || 0;
                totalOtherDeductions += parseFloat(row.querySelector('.other-deductions')?.value) || 0;
                totalNetSalary += parseFloat(row.querySelector('.net-salary')?.textContent) || 0;
            });

            // Update the totals row
            document.getElementById('total-basic-salary').textContent = totalBasicSalary.toFixed(2);
            document.getElementById('total-fixed-allowance').textContent = totalFixedAllowance.toFixed(2);
            document.getElementById('total-fuel-allowance').textContent = totalFuelAllowance.toFixed(2);
            document.getElementById('total-reward').textContent = totalReward.toFixed(2);
            document.getElementById('total-overtime').textContent = totalOvertime.toFixed(2);
            document.getElementById('total-fixed-deduction').textContent = totalFixedDeduction.toFixed(2);
            document.getElementById('total-penalties-days').textContent = totalPenaltiesDays.toFixed(2);
            document.getElementById('total-penalties-egp').textContent = totalPenaltiesEgp.toFixed(2);
            document.getElementById('total-other-deductions').textContent = totalOtherDeductions.toFixed(2);
            document.getElementById('total-net-salary').textContent = totalNetSalary.toFixed(2);
        }

        // Function to save payroll
        async function savePayroll() {
            // Get the selected month and year
            const selectedMonth = parseInt(document.getElementById('payroll-month').value);
            const selectedYear = parseInt(document.getElementById('payroll-year').value);

            // Get all employee rows
            const employeeRows = document.querySelectorAll('#payrollCalculationTableBody tr');

            // Create payroll records
            const newPayrollRecords = [];

            employeeRows.forEach(row => {
                // Skip if it's a message row
                if (row.querySelector('td[colspan]')) return;

                // Get the employee ID
                const employeeId = row.cells[0].textContent;
                const employeeName = row.cells[1].textContent;

                // Get all the values
                const basicSalary = parseFloat(row.cells[2].textContent) || 0;
                const fixedAllowance = parseFloat(row.cells[3].textContent) || 0;
                const fuelAllowance = parseFloat(row.querySelector('.fuel-allowance')?.value) || 0;
                const reward = parseFloat(row.querySelector('.reward')?.value) || 0;
                const overtime = parseFloat(row.querySelector('.overtime-value')?.textContent) || 0;
                const fixedDeduction = parseFloat(row.cells[7].textContent) || 0;

                const penaltiesDaysElement = row.querySelector('.penalties-days');
                const penaltiesDays = parseFloat(penaltiesDaysElement?.textContent) || 0;

                const penaltiesEgp = parseFloat(row.querySelector('.penalties-egp')?.value) || 0;
                const otherDeductions = parseFloat(row.querySelector('.other-deductions')?.value) || 0;
                const netSalary = parseFloat(row.querySelector('.net-salary')?.textContent) || 0;

                // Create a payroll record
                const payrollRecord = {
                    id: Date.now() + Math.floor(Math.random() * 1000), // Generate a unique ID
                    month: selectedMonth,
                    year: selectedYear,
                    employeeId: employeeId,
                    employeeName: employeeName,
                    basicSalary: basicSalary,
                    fixedAllowance: fixedAllowance,
                    fuelAllowance: fuelAllowance,
                    reward: reward,
                    overtime: overtime,
                    fixedDeduction: fixedDeduction,
                    penaltiesDays: penaltiesDays,
                    penaltiesEgp: penaltiesEgp,
                    otherDeductions: otherDeductions,
                    netSalary: netSalary,
                    date: new Date().toISOString()
                };

                newPayrollRecords.push(payrollRecord);
            });

            // Save each payroll record to Supabase
            for (const payrollRecord of newPayrollRecords) {
                const supabasePayrollData = {
                    employee_id: payrollRecord.employeeId,
                    employee_name: payrollRecord.employeeName,
                    month: payrollRecord.month,
                    year: payrollRecord.year,
                    basic_salary: payrollRecord.basicSalary,
                    allowances: payrollRecord.fixedAllowance + payrollRecord.fuelAllowance + payrollRecord.reward + payrollRecord.overtime,
                    deductions: payrollRecord.fixedDeduction + payrollRecord.penaltiesEgp + payrollRecord.otherDeductions,
                    net_salary: payrollRecord.netSalary
                };

                const { data, error } = await dbHelpers.addPayroll(supabasePayrollData);
                if (error) {
                    console.error('Error saving payroll to Supabase:', error);
                    showMessage(`Error saving payroll: ${error.message}`, 'error');
                    return;
                }

                console.log('Payroll record saved to Supabase:', data);
                // Add the Supabase ID to the local record
                payrollRecord.id = data.id;
            }

            // Add the new records to the local payroll records array
            payrollRecords = [...payrollRecords, ...newPayrollRecords];

            // Hide the payroll form container
            document.getElementById('payroll-form-container').classList.add('hidden');

            // Show success message
            showMessage('Payroll saved successfully!');

            // Populate the payroll history table
            populatePayrollHistoryTable();
        }

        // Function to populate the payroll history table
        function populatePayrollHistoryTable(monthFilter = 'all', yearFilter = 'all') {
            const tableBody = document.getElementById('payrollHistoryTableBody');
            if (!tableBody) return;

            tableBody.innerHTML = '';

            // Check if filter is active and update button state
            const isFilterActive = monthFilter !== 'all' || yearFilter !== 'all';
            const filterBtn = document.getElementById('payroll-history-filter-btn');
            const filterBtnText = document.getElementById('filter-btn-text');

            if (filterBtn) {
                if (isFilterActive) {
                    filterBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                    filterBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                    if (filterBtnText) filterBtnText.textContent = 'Clear Filters';
                } else {
                    filterBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                    filterBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                    if (filterBtnText) filterBtnText.textContent = 'Apply Filters';
                }
            }

            // Filter records based on month and year
            let filteredRecords = [...payrollRecords];

            if (monthFilter !== 'all') {
                filteredRecords = filteredRecords.filter(record => record.month === parseInt(monthFilter));
            }

            if (yearFilter !== 'all') {
                filteredRecords = filteredRecords.filter(record => record.year === parseInt(yearFilter));
            }

            // Sort by date (newest first)
            filteredRecords.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (filteredRecords.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-gray-500">No payroll records found.</td></tr>';
                return;
            }

            // Populate the table
            filteredRecords.forEach(record => {
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                const monthName = monthNames[record.month - 1];

                const totalAllowances = record.fixedAllowance + record.fuelAllowance + record.reward + record.overtime;
                const totalDeductions = record.fixedDeduction + record.penaltiesEgp + record.otherDeductions;

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition duration-150';
                row.innerHTML = `
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${monthName} ${record.year}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${record.employeeId}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${record.employeeName}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${record.basicSalary.toFixed(2)}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${totalAllowances.toFixed(2)}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${totalDeductions.toFixed(2)}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${record.netSalary.toFixed(2)}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm font-medium space-x-2">
                        <button onclick="viewPayrollDetails('${record.id}')" class="text-indigo-600 hover:text-indigo-900" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="deletePayrollRecord('${record.id}')" class="text-red-600 hover:text-red-900" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;

                tableBody.appendChild(row);
            });
        }

        // Function to export payroll data to Excel
        function exportPayrollToExcel() {
            // Get the selected month and year
            const selectedMonth = parseInt(document.getElementById('payroll-month').value);
            const selectedYear = parseInt(document.getElementById('payroll-year').value);

            // Get active employees with salary records
            const activeEmployees = employees.filter(emp => emp.status === 'Active');
            const employeesWithSalary = activeEmployees.filter(emp => {
                return salaryRecords.some(sr => sr.employeeId === emp.id);
            });

            if (employeesWithSalary.length === 0) {
                showMessage('No active employees with salary records found.', 'error');
                return;
            }

            // Create data array for Excel
            const data = [];

            // Add header row
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            const monthName = monthNames[selectedMonth - 1];
            data.push([`Payroll for ${monthName} ${selectedYear}`]);
            data.push([]);  // Empty row
            data.push([
                'Code',
                'Name',
                'Basic Salary',
                'Fixed Allowance',
                'Fuel Allowance',
                'Reward (EGP)',
                'Overtime',
                'Fixed Deduction',
                'Penalties/Days',
                'Penalties (EGP)',
                'Other Deductions',
                'Net Salary'
            ]);

            // Process each employee
            employeesWithSalary.forEach(employee => {
                const salaryRecord = salaryRecords.find(sr => sr.employeeId === employee.id);
                if (!salaryRecord) return;

                // Calculate overtime
                const employeeOvertimeRecords = overtimeRecords.filter(record => {
                    const recordDate = new Date(record.date);
                    return record.employeeId === employee.id &&
                           recordDate.getMonth() + 1 === selectedMonth &&
                           recordDate.getFullYear() === selectedYear &&
                           record.status === 'Approved';
                });

                const totalOvertimeHours = employeeOvertimeRecords.reduce((sum, record) => sum + record.hours, 0);
                const overtimePay = (totalOvertimeHours * 1.5 / 8) * (salaryRecord.basicSalary / 30);

                // Calculate penalties
                const employeePenaltyRecords = penaltyRecords.filter(record => {
                    const recordDate = new Date(record.date);
                    return record.employeeId === employee.id &&
                           recordDate.getMonth() + 1 === selectedMonth &&
                           recordDate.getFullYear() === selectedYear &&
                           record.status === 'Approved';
                });

                const totalPenaltyDays = employeePenaltyRecords.reduce((sum, record) => sum + parseFloat(record.days), 0);
                const penaltyDeduction = totalPenaltyDays * (salaryRecord.basicSalary / 30);

                // Default values for manual entries
                const fuelAllowance = 0;
                const reward = 0;
                const otherDeductions = 0;

                // Calculate net salary
                const totalAllowances = salaryRecord.fixedAllowance + fuelAllowance + reward + overtimePay;
                const totalDeductions = salaryRecord.fixedDeduction + penaltyDeduction + otherDeductions;
                const netSalary = salaryRecord.basicSalary + totalAllowances - totalDeductions;

                // Add employee row
                const employeeName = employee.fullName || employee.full_name || 'Unknown Employee';
                data.push([
                    employee.id,
                    employeeName,
                    salaryRecord.basicSalary.toFixed(2),
                    salaryRecord.fixedAllowance.toFixed(2),
                    fuelAllowance.toFixed(2),
                    reward.toFixed(2),
                    overtimePay.toFixed(2),
                    salaryRecord.fixedDeduction.toFixed(2),
                    totalPenaltyDays.toFixed(2), // Ensure we show exact fractions (0.25, 0.50, 0.75, etc.)
                    penaltyDeduction.toFixed(2),
                    otherDeductions.toFixed(2),
                    netSalary.toFixed(2)
                ]);
            });

            // Calculate totals
            const totals = [
                'TOTALS',
                '',
                data.slice(3).reduce((sum, row) => sum + parseFloat(row[2]), 0).toFixed(2),
                data.slice(3).reduce((sum, row) => sum + parseFloat(row[3]), 0).toFixed(2),
                data.slice(3).reduce((sum, row) => sum + parseFloat(row[4]), 0).toFixed(2),
                data.slice(3).reduce((sum, row) => sum + parseFloat(row[5]), 0).toFixed(2),
                data.slice(3).reduce((sum, row) => sum + parseFloat(row[6]), 0).toFixed(2),
                data.slice(3).reduce((sum, row) => sum + parseFloat(row[7]), 0).toFixed(2),
                data.slice(3).reduce((sum, row) => sum + parseFloat(row[8]), 0).toFixed(2),
                data.slice(3).reduce((sum, row) => sum + parseFloat(row[9]), 0).toFixed(2),
                data.slice(3).reduce((sum, row) => sum + parseFloat(row[10]), 0).toFixed(2),
                data.slice(3).reduce((sum, row) => sum + parseFloat(row[11]), 0).toFixed(2)
            ];

            data.push(totals);

            // Convert data to CSV
            let csvContent = "data:text/csv;charset=utf-8,";

            data.forEach(row => {
                const csvRow = row.join(',');
                csvContent += csvRow + '\r\n';
            });

            // Create download link
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `Payroll_${monthName}_${selectedYear}.csv`);
            document.body.appendChild(link);

            // Trigger download
            link.click();
            document.body.removeChild(link);

            showMessage(`Payroll data for ${monthName} ${selectedYear} exported successfully!`);
        }

        // Function to view payroll details
        function viewPayrollDetails(recordId) {
            // Find the record
            const record = payrollRecords.find(r => r.id == recordId);
            if (!record) {
                showMessage('Record not found.', 'error');
                return;
            }

            // Show the details in a modal or alert for now
            alert(`Payroll Details for ${record.employeeName} (${record.employeeId})
Month/Year: ${record.month}/${record.year}
Basic Salary: ${record.basicSalary.toFixed(2)}
Fixed Allowance: ${record.fixedAllowance.toFixed(2)}
Fuel Allowance: ${record.fuelAllowance.toFixed(2)}
Reward: ${record.reward.toFixed(2)}
Overtime: ${record.overtime.toFixed(2)}
Fixed Deduction: ${record.fixedDeduction.toFixed(2)}
Penalties (Days): ${record.penaltiesDays.toFixed(2)} // Ensure we show exact fractions (0.25, 0.50, 0.75, etc.)
Penalties (EGP): ${record.penaltiesEgp.toFixed(2)}
Other Deductions: ${record.otherDeductions.toFixed(2)}
Net Salary: ${record.netSalary.toFixed(2)}`);
        }

        // Function to delete payroll record
        async function deletePayrollRecord(recordId) {
            if (!confirm('Are you sure you want to delete this payroll record?')) {
                return;
            }

            try {
                // Delete from Supabase
                const { data, error } = await dbHelpers.deletePayroll(recordId);
                if (error) {
                    console.error('Error deleting payroll from Supabase:', error);
                    showMessage(`Error deleting payroll: ${error.message}`, 'error');
                    return;
                }

                console.log('Payroll deleted from Supabase:', data);

                // Remove from local array
                const recordIndex = payrollRecords.findIndex(r => r.id == recordId);
                if (recordIndex !== -1) {
                    payrollRecords.splice(recordIndex, 1);
                }

                // Update the UI
                populatePayrollHistoryTable();

                // Show success message
                showMessage('Payroll record deleted successfully.');
            } catch (error) {
                console.error('Error in deletePayrollRecord:', error);
                showMessage(`Error deleting payroll: ${error.message}`, 'error');
            }
        }

        // Add event listeners for payroll functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Populate year dropdowns
            populatePayrollYearDropdowns();

            // Set current month in the dropdown
            const currentMonth = new Date().getMonth() + 1; // 1-12
            const payrollMonthDropdown = document.getElementById('payroll-month');
            if (payrollMonthDropdown) {
                payrollMonthDropdown.value = currentMonth;
            }

            // Add event listener to run payroll button
            const runPayrollBtn = document.getElementById('run-payroll-btn');
            if (runPayrollBtn) {
                runPayrollBtn.addEventListener('click', runPayroll);
            }

            // Add event listener to export payroll button
            const exportPayrollBtn = document.getElementById('export-payroll-btn');
            if (exportPayrollBtn) {
                exportPayrollBtn.addEventListener('click', exportPayrollToExcel);
            }

            // Add event listener to save payroll button
            const savePayrollBtn = document.getElementById('save-payroll-btn');
            if (savePayrollBtn) {
                savePayrollBtn.addEventListener('click', savePayroll);
            }

            // Add event listener to cancel payroll button
            const cancelPayrollBtn = document.getElementById('cancel-payroll-btn');
            if (cancelPayrollBtn) {
                cancelPayrollBtn.addEventListener('click', function() {
                    document.getElementById('payroll-form-container').classList.add('hidden');
                });
            }

            // Add event listener to payroll history filter button
            const payrollHistoryFilterBtn = document.getElementById('payroll-history-filter-btn');
            if (payrollHistoryFilterBtn) {
                // Track filter state
                let filterActive = false;

                payrollHistoryFilterBtn.addEventListener('click', function() {
                    const monthFilter = document.getElementById('payroll-history-month').value;
                    const yearFilter = document.getElementById('payroll-history-year').value;
                    const filterBtnText = document.getElementById('filter-btn-text');

                    // Toggle filter state
                    filterActive = !filterActive;

                    if (filterActive) {
                        // Apply filter
                        populatePayrollHistoryTable(monthFilter, yearFilter);

                        // Change button color to red and update text
                        this.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                        this.classList.add('bg-red-600', 'hover:bg-red-700');
                        filterBtnText.textContent = 'Clear Filters';
                    } else {
                        // Clear filter
                        document.getElementById('payroll-history-month').value = 'all';
                        document.getElementById('payroll-history-year').value = 'all';
                        populatePayrollHistoryTable('all', 'all');

                        // Restore original button color and text
                        this.classList.remove('bg-red-600', 'hover:bg-red-700');
                        this.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                        filterBtnText.textContent = 'Apply Filters';
                    }
                });
            }

            // Payroll records are now loaded from Supabase in loadSavedData()

            // Populate the payroll history table
            populatePayrollHistoryTable();
        });
    </script>
    <script type="module">
        try {
            const { supabase, dbHelpers, utils } = await import('./supabase.js');

            // Make dbHelpers and utils available globally
        window.dbHelpers = dbHelpers;
        window.utils = utils;
        window.supabaseClient = supabase;

        // Debug: Check if functions are available
        console.log('dbHelpers available functions:', Object.keys(dbHelpers));
        console.log('updateEmployee function:', typeof dbHelpers.updateEmployee);
        console.log('deleteEmployee function:', typeof dbHelpers.deleteEmployee);

        window.handleLogin = async function handleLogin(event) {
            event.preventDefault();

            const emailInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const errorDiv = document.getElementById('login-error');
            const email = emailInput.value.trim();
            const password = passwordInput.value;

            try {
                // Check user credentials in Supabase
                const { data: user, error } = await dbHelpers.getUserByCredentials(email, password);

                if (error || !user) {
                    errorDiv.classList.remove('hidden');
                    passwordInput.value = '';
                    return;
                }

                console.log('Login successful:', user);

                // Set the current user role and ID
                currentUserRole = user.role;
                currentUserId = user.role === 'admin' ? 'admin' : user.id;

                // Hide login screen and show app
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                document.body.classList.add('flex', 'h-screen');
                errorDiv.classList.add('hidden');

                // Load employee data if not admin
                if (currentUserRole !== 'admin' && user.id) {
                    const { data: employeeData } = await dbHelpers.getAllEmployees();
                    if (employeeData) {
                        currentUserData = employeeData.find(emp => emp.id === user.id);
                        console.log('Current user data:', currentUserData);
                    }
                }

                // Initialize the application
                await initializeAppUI();

                // Add permanent button fix for admin approval buttons
                if (currentUserRole === 'admin' || currentUserRole === 'admin_1') {
                    document.addEventListener('click', function(e) {
                        if (e.target.tagName === 'BUTTON') {
                            const onclick = e.target.getAttribute('onclick');

                            // Handle admin approval/rejection buttons with syntax error protection
                            if (onclick && (onclick.includes('approve') || onclick.includes('reject')) && onclick.includes('Record') && !onclick.includes('FromManager')) {
                                e.preventDefault();
                                e.stopPropagation();

                                console.log('Admin approval button clicked:', onclick);

                                // Robust parsing for UUIDs with dashes
                                const match = onclick.match(/(approve|reject)(\w+)Record\((.+)\)/);

                                if (match) {
                                    const action = match[1];
                                    const type = match[2];
                                    let id = match[3].replace(/['"]/g, '').trim();
                                    const functionName = `${action}${type}Record`;

                                    console.log(`Executing: ${functionName}('${id}')`);

                                    if (typeof window[functionName] === 'function') {
                                        try {
                                            window[functionName](id);
                                            console.log(` ${functionName} executed successfully`);
                                        } catch (error) {
                                            console.error(` Error executing ${functionName}:`, error);
                                        }
                                    } else {
                                        console.error(` Function ${functionName} not found`);
                                    }
                                }
                            }
                        }
                    });
                }

                // Show welcome message
                if (currentUserRole === 'admin') {
                    showMessage('Logged in as Administrator. All submissions will be auto-approved.');
                } else if (currentUserRole === 'admin_1') {
                    showMessage('Logged in as Limited Administrator. Access to salary and payroll sections is restricted.');
                } else if (currentUserRole === 'manager' && currentUserData) {
                    showMessage(`Welcome, ${currentUserData.full_name}! You are logged in as a manager.`);
                } else if (currentUserRole === 'employee' && currentUserData) {
                    showMessage(`Welcome, ${currentUserData.full_name}! You are logged in as an employee.`);
                } else {
                    showMessage(`Welcome! You are logged in as ${currentUserRole}.`);
                }

            } catch (error) {
                console.error('Login error:', error);
                errorDiv.classList.remove('hidden');
                passwordInput.value = '';
                showMessage('Login failed. Please try again.', 'error');
            }
        }

        async function addEmployeeToDatabase(employee) {
            try {
                // Step 1: Create user account first
                const { data: userData, error: userError } = await supabase
                    .from('users')
                    .insert([{
                        username: employee.email,
                        password: 'user123',
                        role: employee.position.toLowerCase().includes('manager') ? 'manager' : 'employee'
                    }])
                    .select()
                    .single();

                if (userError) throw userError;

                // Step 2: Create employee record
                const { data: employeeData, error: employeeError } = await supabase
                    .from('employees')
                    .insert([{
                        code: employee.code,
                        first_name: employee.firstName,
                        last_name: employee.lastName,
                        department: employee.department,
                        position: employee.position,
                        hire_date: employee.hireDate,
                        status: 'Active',
                        email: employee.email
                    }])
                    .select()
                    .single();

                if (employeeError) throw employeeError;

                console.log('Employee and user account created successfully');
                return { data: employeeData, error: null };

            } catch (error) {
                console.error('Error in addEmployeeToDatabase:', error);
                return { data: null, error };
            }
        }

        // Example usage: Call addEmployeeToDatabase when admin adds a new employee
        // addEmployeeToDatabase({ email: 'newemployee@company.com', role: 'employee' });

        } catch (error) {
            console.error('Failed to load supabase.js:', error);
            console.error('Make sure supabase.js is in the same directory as index.html');
            alert('Error: Could not load database configuration. Please check that supabase.js file exists.');
        }
    </script>

</body>
</html>
